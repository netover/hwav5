# =============================================================================
# Resync v5.9.6 - Production Docker Compose
# =============================================================================
#
# Services:
# - resync: Main FastAPI application
# - postgres: PostgreSQL 15+ database
# - redis: Redis 7+ for caching and rate limiting
# - nginx: Reverse proxy with TLS termination (optional)
#
# Usage:
#   Production: docker-compose -f docker-compose.yml up -d
#   Development: docker-compose -f docker-compose.dev.yml up
#
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: resync-postgres
    restart: unless-stopped
    
    environment:
      POSTGRES_DB: ${DATABASE_NAME:-resync}
      POSTGRES_USER: ${DATABASE_USER:-resync}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:?DATABASE_PASSWORD required}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
      # Performance tuning for production
      POSTGRES_MAX_CONNECTIONS: 100
      POSTGRES_SHARED_BUFFERS: 256MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 1GB
    
    volumes:
      # Persistent data
      - postgres_data:/var/lib/postgresql/data
      # Custom PostgreSQL configuration (optional)
      # - ./config/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    
    ports:
      - "${DATABASE_PORT:-5432}:5432"
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER:-resync}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    networks:
      - resync-network
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 512M

  # ===========================================================================
  # Redis Cache
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: resync-redis
    restart: unless-stopped
    
    command: >
      redis-server
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --requirepass ${REDIS_PASSWORD:-}
    
    volumes:
      - redis_data:/data
    
    ports:
      - "${REDIS_PORT:-6379}:6379"
    
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    
    networks:
      - resync-network
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 768M
        reservations:
          cpus: '0.5'
          memory: 256M

  # ===========================================================================
  # Resync Application
  # ===========================================================================
  resync:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PYTHON_VERSION: 3.12
    
    image: resync:5.9.6
    container_name: resync-app
    restart: unless-stopped
    
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    environment:
      # Application
      ENVIRONMENT: production
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      
      # Database (use service names as hosts in Docker network)
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: ${DATABASE_NAME:-resync}
      DATABASE_USER: ${DATABASE_USER:-resync}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:?DATABASE_PASSWORD required}
      DATABASE_SSL_MODE: ${DATABASE_SSL_MODE:-prefer}
      
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_URL: redis://:${REDIS_PASSWORD:-}@redis:6379
      
      # Security
      SECRET_KEY: ${SECRET_KEY:?SECRET_KEY required}
      JWT_ALGORITHM: HS256
      
      # Workers (for Gunicorn)
      WORKERS: ${WORKERS:-2}
      WORKER_CLASS: uvicorn.workers.UvicornWorker
      WORKER_TIMEOUT: 120
      GRACEFUL_TIMEOUT: 30
      
      # CORS
      CORS_ALLOW_ORIGINS: ${CORS_ALLOW_ORIGINS:-http://localhost:3000}
      
      # LLM
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      
      # TWS Integration
      TWS_HOST: ${TWS_HOST:-}
      TWS_PORT: ${TWS_PORT:-31111}
      TWS_USERNAME: ${TWS_USERNAME:-}
      TWS_PASSWORD: ${TWS_PASSWORD:-}
    
    volumes:
      # Persistent storage
      - resync_uploads:/app/uploads
      - resync_backups:/app/backups
      - resync_logs:/app/logs
      - resync_reports:/app/reports
    
    ports:
      - "${SERVER_PORT:-8000}:8000"
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    networks:
      - resync-network
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G
    
    # Security
    security_opt:
      - no-new-privileges:true
    
    # Read-only root filesystem (except mounted volumes)
    # read_only: true

  # ===========================================================================
  # Nginx Reverse Proxy (Optional - for production with TLS)
  # ===========================================================================
  # Uncomment to use Nginx as reverse proxy
  # nginx:
  #   image: nginx:alpine
  #   container_name: resync-nginx
  #   restart: unless-stopped
  #   
  #   depends_on:
  #     - resync
  #   
  #   volumes:
  #     - ./config/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./config/ssl:/etc/nginx/ssl:ro
  #     - nginx_cache:/var/cache/nginx
  #   
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   
  #   networks:
  #     - resync-network
  #   
  #   healthcheck:
  #     test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

# =============================================================================
# Networks
# =============================================================================
networks:
  resync-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  resync_uploads:
    driver: local
  resync_backups:
    driver: local
  resync_logs:
    driver: local
  resync_reports:
    driver: local
  # nginx_cache:
  #   driver: local

# =============================================================================
# Production Deployment Notes
# =============================================================================
#
# 1. BEFORE FIRST RUN:
#    - Copy .env.example to .env
#    - Set all required environment variables (especially SECRET_KEY and DATABASE_PASSWORD)
#    - Review CORS_ALLOW_ORIGINS for your domain
#
# 2. DATABASE MIGRATIONS:
#    docker-compose exec resync alembic upgrade head
#
# 3. CREATE ADMIN USER:
#    docker-compose exec resync python -m resync.scripts.create_admin
#
# 4. BACKUPS:
#    - PostgreSQL: docker-compose exec postgres pg_dump -U resync resync > backup.sql
#    - Volumes: docker run --rm -v resync_uploads:/data -v $(pwd):/backup alpine tar czf /backup/uploads.tar.gz -C /data .
#
# 5. MONITORING:
#    - Application: http://localhost:8000/api/v1/monitoring/health
#    - Metrics: http://localhost:8000/metrics
#
# 6. SCALING:
#    docker-compose up -d --scale resync=3
#    (Requires load balancer like Nginx)
#
# 7. LOGS:
#    docker-compose logs -f resync
#
# 8. UPDATES:
#    docker-compose pull
#    docker-compose up -d --build
#
# =============================================================================
