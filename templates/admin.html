<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resync Admin Configuration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/admin-neumorphic.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
        }
        
        body {
            background-color: #f5f7fb;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .admin-header {
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .sidebar {
            background-color: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            height: calc(100vh - 70px);
            position: sticky;
            top: 70px;
        }
        
        .nav-link {
            color: var(--secondary-color);
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover, .nav-link.active {
            color: var(--primary-color);
            background-color: rgba(0,123,255,0.1);
            border-left: 3px solid var(--primary-color);
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #0069d9);
            border: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #218838);
            border: none;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected {
            background-color: var(--success-color);
        }
        
        .status-disconnected {
            background-color: var(--danger-color);
        }
        
        .status-warning {
            background-color: var(--warning-color);
        }
        
        .section-divider {
            border-top: 1px solid rgba(0,0,0,0.1);
            margin: 2rem 0;
        }
        
        .config-section {
            display: none;
        }
        
        .config-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            background-color: white;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .toast.success {
            border-left-color: var(--success-color);
        }
        
        .toast.error {
            border-left-color: var(--danger-color);
        }
        
        .toast.warning {
            border-left-color: var(--warning-color);
        }
        
        /* Health monitoring cards */
        .health-card {
            transition: all 0.3s ease;
            border-width: 2px;
        }
        
        .health-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .health-card .display-4 {
            font-size: 2.5rem;
            transition: color 0.3s ease;
        }
        
        .health-card .card-text {
            font-weight: 500;
            min-height: 24px;
        }
        
        .health-card small {
            display: block;
            margin-top: 0.25rem;
        }
        
        #healthOverallBanner {
            display: flex;
            align-items: center;
        }
        
        #healthOverallBanner strong {
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container"></div>
    
    <!-- Header -->
    <header class="admin-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1><i class="fas fa-cogs me-2"></i>Resync Administration</h1>
                    <p class="mb-0">System Configuration & Management Console</p>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group">
                        <button class="btn btn-outline-light" id="refreshBtn">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-outline-light" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar Navigation -->
            <div class="col-md-3 col-lg-2 sidebar">
                <nav class="nav flex-column pt-3">
                    <h6 class="px-3 text-muted">CONFIGURATION</h6>
                    <a class="nav-link active" href="#" data-target="teams-config">
                        <i class="fab fa-microsoft me-2"></i>Teams Integration
                    </a>
                    <a class="nav-link" href="#" data-target="tws-config">
                        <i class="fas fa-server me-2"></i>TWS Configuration
                    </a>
                    <a class="nav-link" href="#" data-target="tws-instances">
                        <i class="fas fa-network-wired me-2"></i>TWS Instances
                        <span class="badge bg-info" style="margin-left:auto;" id="tws-instance-count">0</span>
                    </a>
                    <a class="nav-link" href="#" data-target="system-config">
                        <i class="fas fa-sliders-h me-2"></i>System Settings
                    </a>
                    <a class="nav-link" href="#" data-target="litellm-config">
                        <i class="fas fa-brain me-2"></i>LiteLLM & AI Models
                    </a>
                    
                    <h6 class="px-3 mt-4 text-muted">MONITORING</h6>
                    <a class="nav-link" href="#" data-target="health-monitoring">
                        <span class="badge badge-success" style="margin-left:auto;">OK</span>
                        <i class="fas fa-heartbeat me-2"></i>System Health
                    </a>
                    <a class="nav-link" href="#" data-target="proactive-monitoring">
                        <i class="fas fa-satellite-dish me-2"></i>TWS Proativo
                        <span class="badge badge-info" style="margin-left:auto;">LIVE</span>
                    </a>
                    <a class="nav-link" href="/tws-monitor" target="_blank">
                        <i class="fas fa-chart-line me-2"></i>Dashboard TWS <i class="fas fa-external-link-alt fa-xs"></i>
                    </a>
                    <a class="nav-link" href="#" data-target="notifications">
                        <i class="fas fa-bell me-2"></i>Notifications
                        <span class="badge badge-warning" style="margin-left:auto;">3</span>
                    </a>
                    <a class="nav-link" href="#" data-target="logs">
                        <i class="fas fa-file-alt me-2"></i>System Logs
                    </a>
                    
                    <h6 class="px-3 mt-4 text-muted">AI & LEARNING</h6>
                    <a class="nav-link" href="#" data-target="ai-monitoring">
                        <i class="fas fa-robot me-2"></i>AI Specialists & Monitoring
                        <span class="badge bg-primary" id="aiSpecialistsBadge" style="margin-left:auto;">4</span>
                    </a>
                    <a class="nav-link" href="#" data-target="threshold-tuning">
                        <i class="fas fa-sliders-h me-2"></i>Threshold Tuning
                        <span class="badge bg-secondary" id="tuningLevelBadge" style="margin-left:auto;">OFF</span>
                    </a>

                    <h6 class="px-3 mt-4 text-muted">TOOLS</h6>
                    <a class="nav-link" href="#" data-target="backup-restore">
                        <i class="fas fa-database me-2"></i>Backup & Restore
                    </a>
                    <a class="nav-link" href="#" data-target="audit">
                        <i class="fas fa-scroll me-2"></i>Audit Log
                    </a>
                    <a class="nav-link" href="#" data-target="maintenance">
                        <i class="fas fa-tools me-2"></i>Maintenance
                    </a>
                </nav>
            </div>
            
            <!-- Main Content Area -->
            <div class="col-md-9 col-lg-10">
                <!-- Teams Configuration Section -->
                <div id="teams-config" class="config-section active">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fab fa-microsoft me-2"></i>Microsoft Teams Integration</h2>
                        <button class="btn btn-success" id="saveTeamsConfig">
                            <i class="fas fa-save me-1"></i>Save Configuration
                        </button>
                    </div>
                    
                    <div class="row">
                        <div class="col-xl-8">
                            <!-- Basic Configuration Card -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Basic Configuration</h5>
                                </div>
                                <div class="card-body">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="teamsEnabled" checked>
                                        <label class="form-check-label" for="teamsEnabled">
                                            <strong>Enable Teams Integration</strong>
                                            <small class="d-block text-muted">Toggle to enable/disable Teams notifications</small>
                                        </label>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="webhookUrl" class="form-label">Teams Webhook URL</label>
                                        <input type="url" class="form-control" id="webhookUrl" 
                                               placeholder="https://yourcompany.webhook.office.com/webhook...">
                                        <div class="form-text">Incoming webhook URL for your Teams channel</div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="channelName" class="form-label">Channel Name</label>
                                                <input type="text" class="form-control" id="channelName" 
                                                       placeholder="Resync Notifications">
                                                <div class="form-text">Name of the Teams channel</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="botName" class="form-label">Bot Display Name</label>
                                                <input type="text" class="form-control" id="botName" 
                                                       value="Resync Bot">
                                                <div class="form-text">Name displayed in Teams notifications</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="avatarUrl" class="form-label">Bot Avatar URL</label>
                                        <input type="url" class="form-control" id="avatarUrl" 
                                               placeholder="https://example.com/avatar.png">
                                        <div class="form-text">URL to avatar image for the bot (optional)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Advanced Features Card -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-star me-2"></i>Advanced Features</h5>
                                </div>
                                <div class="card-body">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="conversationLearning" checked>
                                        <label class="form-check-label" for="conversationLearning">
                                            <strong>Enable Conversation Learning</strong>
                                            <small class="d-block text-muted">Allow bot to learn from Teams conversations</small>
                                        </label>
                                    </div>
                                    
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="jobNotifications" checked>
                                        <label class="form-check-label" for="jobNotifications">
                                            <strong>Enable Job Status Notifications</strong>
                                            <small class="d-block text-muted">Send notifications for job status changes</small>
                                        </label>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Monitored TWS Instances</label>
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" id="newInstanceInput" 
                                                   placeholder="Enter TWS instance name">
                                            <button class="btn btn-outline-secondary" type="button" id="addInstanceBtn">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                        <div id="instancesList" class="mt-2">
                                            <!-- Instances will be added here dynamically -->
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Job Status Filters</label>
                                        <select multiple class="form-select" id="jobStatusFilters" size="4">
                                            <option value="ABEND" selected>ABEND (Abnormal End)</option>
                                            <option value="ERROR" selected>Error</option>
                                            <option value="FAILED" selected>Failed</option>
                                            <option value="TIMEOUT">Timeout</option>
                                            <option value="CANCELLED">Cancelled</option>
                                            <option value="WARNING">Warning</option>
                                        </select>
                                        <div class="form-text">Select job statuses that trigger notifications</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Notification Types</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="job_status" 
                                                   id="notifyJobStatus" checked>
                                            <label class="form-check-label" for="notifyJobStatus">
                                                Job Status Changes
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="alerts" 
                                                   id="notifyAlerts" checked>
                                            <label class="form-check-label" for="notifyAlerts">
                                                System Alerts
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="performance" 
                                                   id="notifyPerformance" checked>
                                            <label class="form-check-label" for="notifyPerformance">
                                                Performance Issues
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-xl-4">
                            <!-- Health Status Card -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-heartbeat me-2"></i>Integration Status</h5>
                                </div>
                                <div class="card-body">
                                    <div class="text-center mb-3">
                                        <div class="status-indicator status-connected"></div>
                                        <span class="fw-bold">Connected</span>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Last Health Check</label>
                                        <div class="text-muted" id="lastHealthCheck">2 minutes ago</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Connection Status</label>
                                        <div class="text-success">
                                            <i class="fas fa-check-circle me-1"></i> Webhook Accessible
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Features Enabled</label>
                                        <ul class="list-unstyled small">
                                            <li><i class="fas fa-check text-success me-1"></i> Notifications</li>
                                            <li><i class="fas fa-check text-success me-1"></i> Learning</li>
                                            <li><i class="fas fa-times text-danger me-1"></i> Conversations</li>
                                        </ul>
                                    </div>
                                    
                                    <button class="btn btn-outline-primary w-100" id="testNotificationBtn">
                                        <i class="fas fa-paper-plane me-1"></i> Send Test Notification
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Quick Actions Card -->
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-info" id="refreshHealthBtn">
                                            <i class="fas fa-sync me-1"></i> Refresh Health Status
                                        </button>
                                        <button class="btn btn-outline-warning">
                                            <i class="fas fa-exclamation-triangle me-1"></i> View Recent Errors
                                        </button>
                                        <button class="btn btn-outline-secondary">
                                            <i class="fas fa-history me-1"></i> View Notification History
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- TWS Configuration Section (Hidden by default) -->
                <div id="tws-config" class="config-section">
                    <h2><i class="fas fa-server me-2"></i>TWS Configuration</h2>
                    <p class="text-muted">Configure connections to HCL Workload Automation instances</p>

                    <div class="card">
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Primary TWS Instance</label>
                                    <input type="text" id="primaryTwsInstance" class="form-control" placeholder="Primary instance">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Monitored TWS Instances (Up to 10)</label>
                                <div id="twsInstancesList" class="mb-2">
                                    <!-- Instances will be added here dynamically -->
                                </div>
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="newTwsInstanceInput" placeholder="Enter instance name">
                                    <button class="btn btn-outline-secondary" type="button" id="addTwsInstanceBtn">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <button class="btn btn-success" id="saveTwsConfig">
                                <i class="fas fa-save me-1"></i>Save TWS Configuration
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Proactive Monitoring Section (Hidden by default) -->
                <div id="proactive-monitoring" class="config-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2><i class="fas fa-satellite-dish me-2"></i>Monitoramento Proativo TWS</h2>
                            <p class="text-muted mb-0">Configure o background poller, WebSocket broadcast e notificações</p>
                        </div>
                        <div>
                            <a href="/tws-monitor" target="_blank" class="btn btn-primary me-2">
                                <i class="fas fa-external-link-alt me-1"></i>Abrir Dashboard
                            </a>
                            <button class="btn btn-success" id="saveProactiveConfig">
                                <i class="fas fa-save me-1"></i>Salvar
                            </button>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Background Poller Configuration -->
                        <div class="col-xl-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Background Poller</h5>
                                </div>
                                <div class="card-body">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="pollerEnabled" checked>
                                        <label class="form-check-label" for="pollerEnabled">
                                            <strong>Habilitar Polling Automático</strong>
                                            <small class="d-block text-muted">Coleta status do TWS automaticamente</small>
                                        </label>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="pollingInterval" class="form-label">
                                            Intervalo de Polling: <span id="pollingIntervalValue">30</span> segundos
                                        </label>
                                        <input type="range" class="form-range" id="pollingInterval" 
                                               min="5" max="300" step="5" value="30">
                                        <div class="d-flex justify-content-between">
                                            <small class="text-muted">5s (mais recursos)</small>
                                            <small class="text-muted">300s (menos recursos)</small>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Modo de Polling</label>
                                        <select class="form-select" id="pollingMode">
                                            <option value="fixed">Fixo (intervalo constante)</option>
                                            <option value="adaptive">Adaptativo (ajusta com carga)</option>
                                            <option value="scheduled">Agendado (horários específicos)</option>
                                        </select>
                                    </div>
                                    
                                    <div id="scheduledPollingConfig" class="d-none">
                                        <div class="mb-3">
                                            <label class="form-label">Horário de Polling Intensivo</label>
                                            <input type="text" class="form-control" id="pollingSchedule" 
                                                   placeholder="06:00-22:00" value="06:00-22:00">
                                            <small class="text-muted">Fora deste horário, intervalo será 5 minutos</small>
                                        </div>
                                    </div>
                                    
                                    <hr>
                                    
                                    <h6>Thresholds de Detecção</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Job Travado (minutos)</label>
                                                <input type="number" class="form-control" id="jobStuckThreshold" 
                                                       min="10" max="240" value="60">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Job Atrasado (minutos)</label>
                                                <input type="number" class="form-control" id="jobLateThreshold" 
                                                       min="5" max="120" value="30">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Taxa de Falha para Anomalia (%)</label>
                                        <input type="number" class="form-control" id="anomalyThreshold" 
                                               min="5" max="50" value="10">
                                        <small class="text-muted">Alerta se taxa de falha exceder este valor</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- WebSocket & Notifications Configuration -->
                        <div class="col-xl-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-broadcast-tower me-2"></i>WebSocket Broadcast</h5>
                                </div>
                                <div class="card-body">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="websocketEnabled" checked>
                                        <label class="form-check-label" for="websocketEnabled">
                                            <strong>Habilitar WebSocket</strong>
                                            <small class="d-block text-muted">Push de eventos em tempo real</small>
                                        </label>
                                    </div>
                                    
                                    <h6>Filtros de Broadcast</h6>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="wsFilterJobs" checked>
                                            <label class="form-check-label" for="wsFilterJobs">Eventos de Jobs</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="wsFilterWs" checked>
                                            <label class="form-check-label" for="wsFilterWs">Eventos de Workstations</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="wsFilterSystem" checked>
                                            <label class="form-check-label" for="wsFilterSystem">Eventos de Sistema</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="wsFilterCritical" checked>
                                            <label class="form-check-label" for="wsFilterCritical">Apenas Críticos</label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Severidade Mínima</label>
                                        <select class="form-select" id="wsMinSeverity">
                                            <option value="info">Info (todos)</option>
                                            <option value="warning">Warning</option>
                                            <option value="error" selected>Error</option>
                                            <option value="critical">Critical</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Filtrar Jobs (regex)</label>
                                        <input type="text" class="form-control" id="wsJobFilter" 
                                               placeholder=".*BATCH.*|.*CRITICAL.*">
                                        <small class="text-muted">Deixe vazio para todos os jobs</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-bell me-2"></i>Web Push Notifications</h5>
                                </div>
                                <div class="card-body">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="webpushEnabled" checked>
                                        <label class="form-check-label" for="webpushEnabled">
                                            <strong>Habilitar Notificações Browser</strong>
                                            <small class="d-block text-muted">Push notifications para eventos críticos</small>
                                        </label>
                                    </div>
                                    
                                    <h6>Notificar quando:</h6>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="notifyAbend" checked>
                                            <label class="form-check-label" for="notifyAbend">
                                                <i class="fas fa-times-circle text-danger me-1"></i>Job em ABEND
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="notifyWsOffline" checked>
                                            <label class="form-check-label" for="notifyWsOffline">
                                                <i class="fas fa-server text-warning me-1"></i>Workstation Offline
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="notifyStuck">
                                            <label class="form-check-label" for="notifyStuck">
                                                <i class="fas fa-clock text-info me-1"></i>Job Travado
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="notifyPattern">
                                            <label class="form-check-label" for="notifyPattern">
                                                <i class="fas fa-chart-line text-primary me-1"></i>Padrão Detectado
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="soundEnabled">
                                        <label class="form-check-label" for="soundEnabled">
                                            <strong>Alerta Sonoro</strong>
                                            <small class="d-block text-muted">Beep para eventos críticos</small>
                                        </label>
                                    </div>
                                    
                                    <button class="btn btn-outline-primary btn-sm" id="testNotification">
                                        <i class="fas fa-paper-plane me-1"></i>Testar Notificação
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Retention & Patterns -->
                    <div class="row">
                        <div class="col-xl-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-database me-2"></i>Retenção de Dados</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Dados Completos</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="retentionFull" 
                                                           min="1" max="30" value="7">
                                                    <span class="input-group-text">dias</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Sumários/Eventos</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="retentionSummary" 
                                                           min="7" max="90" value="30">
                                                    <span class="input-group-text">dias</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Padrões</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="retentionPatterns" 
                                                           min="30" max="365" value="90">
                                                    <span class="input-group-text">dias</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info mb-0">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <strong>Estimativa:</strong> ~150 MB para 30 dias com 9.000 jobs/dia
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-xl-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-brain me-2"></i>Detecção de Padrões</h5>
                                </div>
                                <div class="card-body">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="patternDetectionEnabled" checked>
                                        <label class="form-check-label" for="patternDetectionEnabled">
                                            <strong>Habilitar Detecção de Padrões</strong>
                                        </label>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Intervalo de Análise</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="patternInterval" 
                                                           min="5" max="60" value="15">
                                                    <span class="input-group-text">min</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Confiança Mínima</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="patternConfidence" 
                                                           min="50" max="95" value="70">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <h6>Tipos de Padrões</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="patternRecurring" checked>
                                        <label class="form-check-label" for="patternRecurring">Falhas Recorrentes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="patternTime" checked>
                                        <label class="form-check-label" for="patternTime">Correlações Temporais</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="patternDependency" checked>
                                        <label class="form-check-label" for="patternDependency">Cadeias de Dependência</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status & Actions -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Status do Sistema</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-light rounded">
                                        <i class="fas fa-clock fa-2x text-primary mb-2"></i>
                                        <h3 id="pollerStatus" class="mb-0">--</h3>
                                        <small class="text-muted">Polls Realizados</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-light rounded">
                                        <i class="fas fa-broadcast-tower fa-2x text-success mb-2"></i>
                                        <h3 id="eventsGenerated" class="mb-0">--</h3>
                                        <small class="text-muted">Eventos Gerados</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-light rounded">
                                        <i class="fas fa-users fa-2x text-info mb-2"></i>
                                        <h3 id="wsClients" class="mb-0">--</h3>
                                        <small class="text-muted">Clientes WebSocket</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-light rounded">
                                        <i class="fas fa-chart-line fa-2x text-warning mb-2"></i>
                                        <h3 id="patternsDetected" class="mb-0">--</h3>
                                        <small class="text-muted">Padrões Detectados</small>
                                    </div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="status-indicator" id="pollerStatusIndicator"></span>
                                    <strong id="pollerStatusText">Verificando...</strong>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-outline-success" id="startPollerBtn">
                                        <i class="fas fa-play me-1"></i>Iniciar
                                    </button>
                                    <button class="btn btn-outline-danger" id="stopPollerBtn">
                                        <i class="fas fa-stop me-1"></i>Parar
                                    </button>
                                    <button class="btn btn-outline-primary" id="forcePollBtn">
                                        <i class="fas fa-sync me-1"></i>Forçar Poll
                                    </button>
                                    <button class="btn btn-outline-warning" id="detectPatternsBtn">
                                        <i class="fas fa-search me-1"></i>Detectar Padrões
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- System Configuration Section (Hidden by default) -->
                <div id="system-config" class="config-section">
                    <h2><i class="fas fa-sliders-h me-2"></i>System Settings</h2>
                    <p class="text-muted">Configure global system parameters and behaviors</p>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Changes to system settings require application restart to take effect.
                            </div>
                            
                            <!-- General Settings -->
                            <h5 class="border-bottom pb-2 mb-3">General Settings</h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Environment</label>
                                        <select class="form-select" id="envSelect">
                                            <option value="Development">Development</option>
                                            <option value="Production">Production</option>
                                            <option value="Staging">Staging</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Debug Mode</label>
                                        <select class="form-select" id="debugSelect">
                                            <option value="Disabled">Disabled</option>
                                            <option value="Enabled">Enabled</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Security Settings -->
                            <h5 class="border-bottom pb-2 mb-3 mt-4">Security Settings</h5>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="sslEnabled">
                                <label class="form-check-label" for="sslEnabled">
                                    <strong>SSL/TLS Encryption</strong>
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="cspEnabled">
                                <label class="form-check-label" for="cspEnabled">
                                    <strong>Content Security Policy</strong>
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="corsEnabled">
                                <label class="form-check-label" for="corsEnabled">
                                    <strong>CORS Protection</strong>
                                </label>
                            </div>

                            <button class="btn btn-success" id="saveSystemSettings">
                                <i class="fas fa-save me-1"></i>Save System Settings
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- LiteLLM Configuration Section -->
                <div id="litellm-config" class="config-section">
                    <h2><i class="fas fa-brain me-2"></i>LiteLLM Configuration</h2>
                    <p class="text-muted">Multi-provider AI model management, cost monitoring, and smart routing</p>
                    
                    <!-- Status Overview Cards -->
                    <div class="row mb-4">
                        <!-- Router Status -->
                        <div class="col-md-3 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <div class="display-4 mb-2" id="litellmRouterIcon">
                                        <i class="fas fa-server text-muted"></i>
                                    </div>
                                    <h6>Router Status</h6>
                                    <span class="badge bg-secondary" id="litellmRouterStatus">Checking...</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Active Models -->
                        <div class="col-md-3 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <div class="display-4 mb-2 text-primary">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <h6>Available Models</h6>
                                    <span class="h4" id="litellmModelCount">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Today's Cost -->
                        <div class="col-md-3 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <div class="display-4 mb-2 text-success">
                                        <i class="fas fa-dollar-sign"></i>
                                    </div>
                                    <h6>Today's Cost</h6>
                                    <span class="h4" id="litellmTodayCost">$0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Total Requests -->
                        <div class="col-md-3 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <div class="display-4 mb-2 text-info">
                                        <i class="fas fa-exchange-alt"></i>
                                    </div>
                                    <h6>Total Requests</h6>
                                    <span class="h4" id="litellmTotalRequests">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Budget Progress -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><i class="fas fa-chart-pie me-2"></i><strong>Monthly Budget</strong></span>
                                <span>
                                    <span id="litellmBudgetUsed">$0.00</span> / 
                                    <span id="litellmBudgetLimit">$500.00</span>
                                </span>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar" id="litellmBudgetBar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <small class="text-muted">Projected: <span id="litellmProjectedCost">$0.00</span>/month</small>
                                <small class="text-warning" id="litellmBudgetAlert" style="display: none;">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Approaching limit
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabs -->
                    <ul class="nav nav-tabs mb-4" id="litellmTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#litellm-providers">
                                <i class="fas fa-cloud me-1"></i>Providers
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#litellm-models">
                                <i class="fas fa-cubes me-1"></i>Models
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#litellm-routing">
                                <i class="fas fa-route me-1"></i>Smart Routing
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#litellm-costs">
                                <i class="fas fa-coins me-1"></i>Costs
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content">
                        <!-- Providers Tab -->
                        <div class="tab-pane fade show active" id="litellm-providers">
                            <div class="row" id="litellmProvidersGrid">
                                <div class="col-12 text-center py-4">
                                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                    <p class="text-muted mt-2">Loading providers...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Models Tab -->
                        <div class="tab-pane fade" id="litellm-models">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="litellmModelSearch" placeholder="Search models...">
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="litellmProviderFilter">
                                        <option value="">All Providers</option>
                                        <option value="openai">OpenAI</option>
                                        <option value="anthropic">Anthropic</option>
                                        <option value="ollama">Ollama (Local)</option>
                                        <option value="together_ai">Together AI</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="litellmLocalOnly">
                                        <label class="form-check-label" for="litellmLocalOnly">Local Only (Free)</label>
                                    </div>
                                </div>
                                <div class="col-md-2 text-end">
                                    <button class="btn btn-outline-primary" onclick="LiteLLMAdmin.refreshModels()">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="row" id="litellmModelsGrid">
                                <div class="col-12 text-center py-4">
                                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Routing Tab -->
                        <div class="tab-pane fade" id="litellm-routing">
                            <div class="card">
                                <div class="card-body">
                                    <h5><i class="fas fa-magic me-2"></i>Smart Model Routing</h5>
                                    <p class="text-muted">Automatically select models based on query complexity</p>
                                    
                                    <div class="form-check form-switch mb-4">
                                        <input class="form-check-input" type="checkbox" id="litellmRoutingEnabled" checked>
                                        <label class="form-check-label" for="litellmRoutingEnabled">
                                            <strong>Enable Smart Routing</strong>
                                        </label>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">
                                                <i class="fas fa-bolt text-success me-1"></i>Simple Queries
                                            </label>
                                            <select class="form-select" id="litellmSimpleModel">
                                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                                <option value="gpt-4o-mini">GPT-4o Mini</option>
                                                <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                                                <option value="ollama/llama3">Llama 3 (Local)</option>
                                            </select>
                                            <small class="text-muted">Status checks, basic info</small>
                                        </div>
                                        
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">
                                                <i class="fas fa-brain text-primary me-1"></i>Complex Queries
                                            </label>
                                            <select class="form-select" id="litellmComplexModel">
                                                <option value="gpt-4o">GPT-4o</option>
                                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                                <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                                                <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                                            </select>
                                            <small class="text-muted">Analysis, troubleshooting</small>
                                        </div>
                                        
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">
                                                <i class="fas fa-life-ring text-warning me-1"></i>Fallback Model
                                            </label>
                                            <select class="form-select" id="litellmFallbackModel">
                                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                                <option value="ollama/llama3">Llama 3 (Local)</option>
                                                <option value="ollama/mistral">Mistral (Local)</option>
                                            </select>
                                            <small class="text-muted">When primary unavailable</small>
                                        </div>
                                    </div>
                                    
                                    <div class="form-check form-switch mt-3">
                                        <input class="form-check-input" type="checkbox" id="litellmPreferLocal">
                                        <label class="form-check-label" for="litellmPreferLocal">
                                            <i class="fas fa-home me-1"></i>Prefer local models when available (zero cost)
                                        </label>
                                    </div>
                                    
                                    <button class="btn btn-success mt-4" onclick="LiteLLMAdmin.saveRouting()">
                                        <i class="fas fa-save me-1"></i>Save Routing Configuration
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Costs Tab -->
                        <div class="tab-pane fade" id="litellm-costs">
                            <div class="row">
                                <div class="col-md-8 mb-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-chart-line me-2"></i>Daily Cost Trend
                                        </div>
                                        <div class="card-body">
                                            <canvas id="litellmCostChart" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-chart-pie me-2"></i>Cost by Model
                                        </div>
                                        <div class="card-body">
                                            <canvas id="litellmModelCostChart" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-tachometer-alt me-2"></i>Usage Statistics
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-md-2">
                                            <div class="h4 text-primary" id="litellmStatRequests">0</div>
                                            <small class="text-muted">Total Requests</small>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="h4 text-info" id="litellmStatInputTokens">0</div>
                                            <small class="text-muted">Input Tokens</small>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="h4 text-info" id="litellmStatOutputTokens">0</div>
                                            <small class="text-muted">Output Tokens</small>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="h4 text-warning" id="litellmStatLatency">0ms</div>
                                            <small class="text-muted">Avg Latency</small>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="h4 text-danger" id="litellmStatErrorRate">0%</div>
                                            <small class="text-muted">Error Rate</small>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="h4 text-success" id="litellmStatTotalCost">$0.00</div>
                                            <small class="text-muted">Total Cost</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Test Model Modal -->
                    <div class="modal fade" id="testModelModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title"><i class="fas fa-flask me-2"></i>Test Model</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">Model</label>
                                        <input type="text" class="form-control" id="testModelName" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Test Prompt</label>
                                        <textarea class="form-control" id="testModelPrompt" rows="2">Hello, respond with OK if working.</textarea>
                                    </div>
                                    <div id="testModelResult" style="display: none;"></div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-primary" onclick="LiteLLMAdmin.runTest()">
                                        <i class="fas fa-play me-1"></i>Run Test
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- TWS Instances Management Section -->
                <div id="tws-instances" class="config-section">
                    <h2><i class="fas fa-network-wired me-2"></i>TWS Instances Management</h2>
                    <p class="text-muted">Manage multiple TWS/HWA server connections across datacenters</p>
                    
                    <!-- Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-center" style="border-left: 4px solid #10b981;">
                                <div class="card-body">
                                    <h3 class="mb-0" id="tws-total-instances">0</h3>
                                    <small class="text-muted">Total Instances</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center" style="border-left: 4px solid #3b82f6;">
                                <div class="card-body">
                                    <h3 class="mb-0" id="tws-connected-count">0</h3>
                                    <small class="text-muted">Connected</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center" style="border-left: 4px solid #f59e0b;">
                                <div class="card-body">
                                    <h3 class="mb-0" id="tws-pending-count">0</h3>
                                    <small class="text-muted">Pending</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center" style="border-left: 4px solid #ef4444;">
                                <div class="card-body">
                                    <h3 class="mb-0" id="tws-error-count">0</h3>
                                    <small class="text-muted">Errors</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions Bar -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addTWSInstanceModal">
                                <i class="fas fa-plus me-1"></i>Add Instance
                            </button>
                            <button class="btn btn-outline-primary me-2" onclick="TWSInstancesAdmin.connectAll()">
                                <i class="fas fa-plug me-1"></i>Connect All
                            </button>
                            <button class="btn btn-outline-secondary" onclick="TWSInstancesAdmin.disconnectAll()">
                                <i class="fas fa-unlink me-1"></i>Disconnect All
                            </button>
                        </div>
                        <button class="btn btn-outline-info" onclick="TWSInstancesAdmin.refresh()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                    
                    <!-- Instances Table -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-server me-2"></i>Configured Instances
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 40px;"></th>
                                            <th>Name</th>
                                            <th>Host</th>
                                            <th>Environment</th>
                                            <th>Status</th>
                                            <th>Learning</th>
                                            <th class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tws-instances-table">
                                        <tr>
                                            <td colspan="7" class="text-center py-4 text-muted">
                                                <i class="fas fa-spinner fa-spin me-2"></i>Loading instances...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add Instance Modal -->
                    <div class="modal fade" id="addTWSInstanceModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Add TWS Instance</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="addTWSInstanceForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Instance Name *</label>
                                                <input type="text" class="form-control" id="tws-new-name" 
                                                       placeholder="e.g., SAZ, NAZ, LON" required>
                                                <small class="text-muted">Short identifier (uppercase)</small>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Display Name *</label>
                                                <input type="text" class="form-control" id="tws-new-display-name" 
                                                       placeholder="e.g., São Paulo - SAZ" required>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-8 mb-3">
                                                <label class="form-label">Host *</label>
                                                <input type="text" class="form-control" id="tws-new-host" 
                                                       placeholder="tws.example.com" required>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Port</label>
                                                <input type="number" class="form-control" id="tws-new-port" 
                                                       value="31116" min="1" max="65535">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Username</label>
                                                <input type="text" class="form-control" id="tws-new-username" 
                                                       placeholder="admin">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Password</label>
                                                <input type="password" class="form-control" id="tws-new-password">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Environment</label>
                                                <select class="form-select" id="tws-new-environment">
                                                    <option value="production">Production</option>
                                                    <option value="staging">Staging</option>
                                                    <option value="development">Development</option>
                                                    <option value="dr">Disaster Recovery</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Color</label>
                                                <input type="color" class="form-control form-control-color" 
                                                       id="tws-new-color" value="#3B82F6">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Options</label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="tws-new-ssl" checked>
                                                    <label class="form-check-label" for="tws-new-ssl">SSL Enabled</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="tws-new-learning" checked>
                                                    <label class="form-check-label" for="tws-new-learning">Learning Enabled</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Description</label>
                                            <textarea class="form-control" id="tws-new-description" rows="2" 
                                                      placeholder="Optional description..."></textarea>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-outline-primary" onclick="TWSInstancesAdmin.testNewConnection()">
                                        <i class="fas fa-vial me-1"></i>Test Connection
                                    </button>
                                    <button type="button" class="btn btn-success" onclick="TWSInstancesAdmin.addInstance()">
                                        <i class="fas fa-plus me-1"></i>Add Instance
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Edit Instance Modal -->
                    <div class="modal fade" id="editTWSInstanceModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit TWS Instance</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <input type="hidden" id="tws-edit-id">
                                    <form id="editTWSInstanceForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Instance Name</label>
                                                <input type="text" class="form-control" id="tws-edit-name" disabled>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Display Name *</label>
                                                <input type="text" class="form-control" id="tws-edit-display-name" required>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-8 mb-3">
                                                <label class="form-label">Host *</label>
                                                <input type="text" class="form-control" id="tws-edit-host" required>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Port</label>
                                                <input type="number" class="form-control" id="tws-edit-port" 
                                                       min="1" max="65535">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Environment</label>
                                                <select class="form-select" id="tws-edit-environment">
                                                    <option value="production">Production</option>
                                                    <option value="staging">Staging</option>
                                                    <option value="development">Development</option>
                                                    <option value="dr">Disaster Recovery</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Color</label>
                                                <input type="color" class="form-control form-control-color" id="tws-edit-color">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Options</label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="tws-edit-enabled">
                                                    <label class="form-check-label" for="tws-edit-enabled">Enabled</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="tws-edit-learning">
                                                    <label class="form-check-label" for="tws-edit-learning">Learning Enabled</label>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" onclick="TWSInstancesAdmin.saveInstance()">
                                        <i class="fas fa-save me-1"></i>Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Health Monitoring Section (Hidden by default) -->
                <div id="health-monitoring" class="config-section">
                    <h2><i class="fas fa-heartbeat me-2"></i>System Health Monitoring</h2>
                    <p class="text-muted">Monitor system performance and health status in real-time</p>
                    
                    <!-- Overall Status Banner -->
                    <div class="alert alert-success mb-4" id="healthOverallBanner" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>System Status:</strong> <span id="healthOverallStatus">All systems operational</span>
                        <button class="btn btn-sm btn-outline-light float-end" onclick="refreshHealthStatus()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                    
                    <!-- Component Cards - Row 1: Core Infrastructure -->
                    <h5 class="mb-3"><i class="fas fa-server me-2"></i>Core Infrastructure</h5>
                    <div class="row mb-4">
                        <div class="col-md-4 mb-3">
                            <div class="card text-center health-card" id="healthCardDatabase">
                                <div class="card-body">
                                    <div class="display-4 text-success" id="healthIconDatabase">
                                        <i class="fas fa-database"></i>
                                    </div>
                                    <h5 class="card-title mt-2">Database</h5>
                                    <p class="card-text" id="healthDatabaseStatus">Checking...</p>
                                    <small class="text-muted" id="healthDatabaseLatency"></small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="card text-center health-card" id="healthCardRedis">
                                <div class="card-body">
                                    <div class="display-4 text-success" id="healthIconRedis">
                                        <i class="fas fa-bolt"></i>
                                    </div>
                                    <h5 class="card-title mt-2">Redis Cache</h5>
                                    <p class="card-text" id="healthRedisStatus">Checking...</p>
                                    <small class="text-muted" id="healthRedisLatency"></small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="card text-center health-card" id="healthCardLLM">
                                <div class="card-body">
                                    <div class="display-4 text-success" id="healthIconLLM">
                                        <i class="fas fa-brain"></i>
                                    </div>
                                    <h5 class="card-title mt-2">LLM Service</h5>
                                    <p class="card-text" id="healthLLMStatus">Checking...</p>
                                    <small class="text-muted" id="healthLLMLatency"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Component Cards - Row 2: Integrations -->
                    <h5 class="mb-3"><i class="fas fa-plug me-2"></i>Integrations</h5>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card text-center health-card" id="healthCardRAG">
                                <div class="card-body">
                                    <div class="display-4 text-success" id="healthIconRAG">
                                        <i class="fas fa-search"></i>
                                    </div>
                                    <h5 class="card-title mt-2">RAG (Qdrant)</h5>
                                    <p class="card-text" id="healthRAGStatus">Checking...</p>
                                    <small class="text-muted" id="healthRAGLatency"></small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="card text-center health-card" id="healthCardTeams">
                                <div class="card-body">
                                    <div class="display-4 text-success" id="healthIconTeams">
                                        <i class="fab fa-microsoft"></i>
                                    </div>
                                    <h5 class="card-title mt-2">Teams</h5>
                                    <p class="card-text" id="healthTeamsStatus">Checking...</p>
                                    <small class="text-muted" id="healthTeamsLatency"></small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="card text-center health-card" id="healthCardTWS">
                                <div class="card-body">
                                    <div class="display-4 text-success" id="healthIconTWS">
                                        <i class="fas fa-cogs"></i>
                                    </div>
                                    <h5 class="card-title mt-2">TWS (HWA)</h5>
                                    <p class="card-text" id="healthTWSStatus">Checking...</p>
                                    <small class="text-muted" id="healthTWSLatency"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Health History / Last Check Info -->
                    <div class="card mt-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-clock me-2"></i>Last checked: <span id="healthLastCheck">Never</span></span>
                                <div>
                                    <label class="form-check-label me-2">
                                        <input type="checkbox" class="form-check-input" id="healthAutoRefresh" checked>
                                        Auto-refresh (30s)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

                <!-- Notifications Section (Hidden by default) -->
                <div id="notifications" class="config-section">
                    <h2><i class="fas fa-bell me-2"></i>Notifications
                        <span class="badge badge-warning" style="margin-left:auto;">3</span></h2>
                    <p class="text-muted">Configure which job statuses and system alerts trigger notifications</p>

                    <div class="card">
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Job Status Filters</label>
                                <select multiple class="form-select" id="notifStatusFilters" size="6">
                                    <option value="ABEND">ABEND (Abnormal End)</option>
                                    <option value="ERROR">Error</option>
                                    <option value="FAILED">Failed</option>
                                    <option value="TIMEOUT">Timeout</option>
                                    <option value="CANCELLED">Cancelled</option>
                                    <option value="WARNING">Warning</option>
                                </select>
                                <div class="form-text">Select job statuses that trigger notifications</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Notification Types</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="notifyJobStatus">
                                    <label class="form-check-label" for="notifyJobStatus">Job Status Changes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="notifyAlerts">
                                    <label class="form-check-label" for="notifyAlerts">System Alerts</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="notifyPerformance">
                                    <label class="form-check-label" for="notifyPerformance">Performance Issues</label>
                                </div>
                            </div>

                            <button class="btn btn-success" id="saveNotificationsBtn">
                                <i class="fas fa-save me-1"></i>Save Notifications
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Logs Section (Hidden by default) -->
                <div id="logs" class="config-section">
                    <h2><i class="fas fa-file-alt me-2"></i>System Logs</h2>
                    <p class="text-muted">View recent entries from application logs</p>

                    <div class="card">
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Log File</label>
                                    <input type="text" class="form-control" id="logFileName" value="app.log">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Lines</label>
                                    <input type="number" class="form-control" id="logLines" value="100" min="10" max="1000">
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button class="btn btn-outline-primary w-100" id="loadLogsBtn">
                                        <i class="fas fa-eye me-1"></i>Load Logs
                                    </button>
                                </div>
                            </div>
                            <pre id="logContent" class="p-3 bg-light" style="height: 300px; overflow-y: scroll; white-space: pre-wrap;"></pre>
                        </div>
                    </div>
                </div>

                <!-- Backup & Restore Section (Hidden by default) -->
                <div id="backup-restore" class="config-section">
                    <h2><i class="fas fa-database me-2"></i>Backup & Restore</h2>
                    <p class="text-muted">Manage backups of audit data</p>

                    <div class="card">
                        <div class="card-body">
                            <div class="d-grid gap-2 d-md-flex mb-3">
                                <button class="btn btn-outline-primary" id="createBackupBtn">
                                    <i class="fas fa-save me-1"></i>Create Backup
                                </button>
                                <button class="btn btn-outline-warning" id="restoreBackupBtn">
                                    <i class="fas fa-upload me-1"></i>Restore Latest
                                </button>
                            </div>
                            <pre id="backupStatus" class="p-3 bg-light" style="height: 200px; overflow-y: scroll;"></pre>
                        </div>
                    </div>
                </div>

                <!-- Audit Section (Hidden by default) -->
                <div id="audit" class="config-section">
                    <h2><i class="fas fa-scroll me-2"></i>Audit Log</h2>
                    <p class="text-muted">Inspect recent audit trail entries</p>

                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button class="btn btn-outline-primary" id="loadAuditBtn">
                                    <i class="fas fa-eye me-1"></i>Load Audit Logs
                                </button>
                            </div>
                            <div style="height: 300px; overflow-y: scroll;">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th scope="col">#</th>
                                            <th scope="col">Timestamp</th>
                                            <th scope="col">Message</th>
                                        </tr>
                                    </thead>
                                    <tbody id="auditTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Specialists & Monitoring Section -->
                <div id="ai-monitoring" class="config-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2><i class="fas fa-robot me-2"></i>AI Specialists & Monitoring</h2>
                            <p class="text-muted mb-0">Configure specialist agents and AI drift monitoring (Evidently)</p>
                        </div>
                        <button class="btn btn-success" id="saveAIConfig">
                            <i class="fas fa-save me-1"></i>Save Configuration
                        </button>
                    </div>

                    <div class="row">
                        <!-- Specialists Configuration -->
                        <div class="col-xl-6">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-users-cog me-2"></i>Specialist Agents</h5>
                                    <div class="form-check form-switch mb-0">
                                        <input class="form-check-input" type="checkbox" id="specialistsEnabled" checked>
                                        <label class="form-check-label" for="specialistsEnabled">Enable Team</label>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted small mb-3">4 specialized AI agents that analyze TWS queries in parallel</p>
                                    
                                    <!-- Team Settings -->
                                    <div class="mb-4">
                                        <h6><i class="fas fa-cog me-2"></i>Team Settings</h6>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Execution Mode</label>
                                                <select class="form-select" id="executionMode">
                                                    <option value="coordinate" selected>Coordinate (Recommended)</option>
                                                    <option value="parallel">Parallel</option>
                                                    <option value="route">Route (Single Best)</option>
                                                    <option value="collaborate">Collaborate</option>
                                                </select>
                                                <div class="form-text">How specialists work together</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Team Timeout (seconds)</label>
                                                <input type="number" class="form-control" id="teamTimeout" value="45" min="10" max="180">
                                            </div>
                                        </div>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="parallelExecution" checked>
                                            <label class="form-check-label" for="parallelExecution">Run Specialists in Parallel</label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="fallbackGeneral" checked>
                                            <label class="form-check-label" for="fallbackGeneral">Fallback to General Agent on Failure</label>
                                        </div>
                                    </div>

                                    <!-- Individual Specialists -->
                                    <h6 class="mt-4"><i class="fas fa-user-tie me-2"></i>Specialists Configuration</h6>
                                    
                                    <!-- Job Analyst -->
                                    <div class="border rounded p-3 mb-3 bg-light">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div>
                                                <strong><i class="fas fa-bug text-danger me-2"></i>Job Analyst</strong>
                                                <small class="d-block text-muted">Return codes, ABENDs, failure analysis</small>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="jobAnalystEnabled" checked>
                                            </div>
                                        </div>
                                        <div class="row collapse show" id="jobAnalystConfig">
                                            <div class="col-md-4">
                                                <label class="form-label small">Model</label>
                                                <select class="form-select form-select-sm" id="jobAnalystModel">
                                                    <option value="gpt-4o" selected>GPT-4o</option>
                                                    <option value="gpt-4o-mini">GPT-4o Mini</option>
                                                    <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                                                    <option value="ollama/llama3.1">Llama 3.1 (Local)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small">Temperature</label>
                                                <input type="number" class="form-control form-control-sm" id="jobAnalystTemp" value="0.2" min="0" max="2" step="0.1">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small">Timeout (s)</label>
                                                <input type="number" class="form-control form-control-sm" id="jobAnalystTimeout" value="30" min="5" max="120">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Dependency Specialist -->
                                    <div class="border rounded p-3 mb-3 bg-light">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div>
                                                <strong><i class="fas fa-project-diagram text-primary me-2"></i>Dependency Specialist</strong>
                                                <small class="d-block text-muted">Predecessors, successors, impact analysis</small>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="dependencyEnabled" checked>
                                            </div>
                                        </div>
                                        <div class="row collapse show" id="dependencyConfig">
                                            <div class="col-md-4">
                                                <label class="form-label small">Model</label>
                                                <select class="form-select form-select-sm" id="dependencyModel">
                                                    <option value="gpt-4o" selected>GPT-4o</option>
                                                    <option value="gpt-4o-mini">GPT-4o Mini</option>
                                                    <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                                                    <option value="ollama/llama3.1">Llama 3.1 (Local)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small">Temperature</label>
                                                <input type="number" class="form-control form-control-sm" id="dependencyTemp" value="0.1" min="0" max="2" step="0.1">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small">Timeout (s)</label>
                                                <input type="number" class="form-control form-control-sm" id="dependencyTimeout" value="30" min="5" max="120">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Resource Specialist -->
                                    <div class="border rounded p-3 mb-3 bg-light">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div>
                                                <strong><i class="fas fa-server text-success me-2"></i>Resource Specialist</strong>
                                                <small class="d-block text-muted">Workstations, CPU/memory, conflicts</small>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="resourceEnabled" checked>
                                            </div>
                                        </div>
                                        <div class="row collapse show" id="resourceConfig">
                                            <div class="col-md-4">
                                                <label class="form-label small">Model</label>
                                                <select class="form-select form-select-sm" id="resourceModel">
                                                    <option value="gpt-4o" selected>GPT-4o</option>
                                                    <option value="gpt-4o-mini">GPT-4o Mini</option>
                                                    <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                                                    <option value="ollama/llama3.1">Llama 3.1 (Local)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small">Temperature</label>
                                                <input type="number" class="form-control form-control-sm" id="resourceTemp" value="0.2" min="0" max="2" step="0.1">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small">Timeout (s)</label>
                                                <input type="number" class="form-control form-control-sm" id="resourceTimeout" value="25" min="5" max="120">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Knowledge Specialist -->
                                    <div class="border rounded p-3 bg-light">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div>
                                                <strong><i class="fas fa-book text-warning me-2"></i>Knowledge Specialist</strong>
                                                <small class="d-block text-muted">Documentation RAG, troubleshooting guides</small>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="knowledgeEnabled" checked>
                                            </div>
                                        </div>
                                        <div class="row collapse show" id="knowledgeConfig">
                                            <div class="col-md-4">
                                                <label class="form-label small">Model</label>
                                                <select class="form-select form-select-sm" id="knowledgeModel">
                                                    <option value="gpt-4o" selected>GPT-4o</option>
                                                    <option value="gpt-4o-mini">GPT-4o Mini</option>
                                                    <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                                                    <option value="ollama/llama3.1">Llama 3.1 (Local)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small">Temperature</label>
                                                <input type="number" class="form-control form-control-sm" id="knowledgeTemp" value="0.4" min="0" max="2" step="0.1">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small">Timeout (s)</label>
                                                <input type="number" class="form-control form-control-sm" id="knowledgeTimeout" value="35" min="5" max="120">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI Monitoring Configuration -->
                        <div class="col-xl-6">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>AI Monitoring (Evidently)</h5>
                                    <div class="form-check form-switch mb-0">
                                        <input class="form-check-input" type="checkbox" id="monitoringEnabled" checked>
                                        <label class="form-check-label" for="monitoringEnabled">Enable</label>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted small mb-3">Drift detection to monitor AI quality degradation over time</p>
                                    
                                    <!-- Schedule Configuration -->
                                    <div class="mb-4">
                                        <h6><i class="fas fa-clock me-2"></i>Schedule</h6>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Run Frequency</label>
                                                <select class="form-select" id="monitoringSchedule">
                                                    <option value="hourly">Hourly</option>
                                                    <option value="every_4_hours">Every 4 Hours</option>
                                                    <option value="daily" selected>Daily (Recommended)</option>
                                                    <option value="weekly">Weekly</option>
                                                    <option value="manual">Manual Only</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Scheduled Time</label>
                                                <input type="time" class="form-control" id="monitoringTime" value="03:00">
                                                <div class="form-text">Best during low-traffic hours</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Drift Detection -->
                                    <div class="mb-4">
                                        <h6><i class="fas fa-search-plus me-2"></i>Drift Detection</h6>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="dataDriftEnabled" checked>
                                            <label class="form-check-label" for="dataDriftEnabled">
                                                Data Drift <small class="text-muted">(query patterns)</small>
                                            </label>
                                        </div>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="predictionDriftEnabled" checked>
                                            <label class="form-check-label" for="predictionDriftEnabled">
                                                Prediction Drift <small class="text-muted">(response quality)</small>
                                            </label>
                                        </div>
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="targetDriftEnabled" checked>
                                            <label class="form-check-label" for="targetDriftEnabled">
                                                Target Drift <small class="text-muted">(user feedback)</small>
                                            </label>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Detection Threshold</label>
                                                <input type="number" class="form-control" id="driftThreshold" value="0.15" min="0.01" max="0.5" step="0.01">
                                                <div class="form-text">Sensitivity (0.15 = 15% drift)</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Alert Threshold</label>
                                                <input type="number" class="form-control" id="alertThreshold" value="0.25" min="0.05" max="0.5" step="0.01">
                                                <div class="form-text">Trigger alerts above this</div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Reference Window (days)</label>
                                                <input type="number" class="form-control" id="referenceWindow" value="7" min="1" max="90">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Current Window (hours)</label>
                                                <input type="number" class="form-control" id="currentWindow" value="24" min="1" max="168">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Resource Limits -->
                                    <div class="mb-4">
                                        <h6><i class="fas fa-tachometer-alt me-2"></i>Resource Limits</h6>
                                        <div class="alert alert-info small mb-3">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Limits to prevent monitoring from impacting production workloads
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Max CPU Usage (%)</label>
                                                <input type="number" class="form-control" id="maxCpuPercent" value="25" min="5" max="100">
                                                <div class="form-text">Recommended: 25% or less</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Max Memory (MB)</label>
                                                <input type="number" class="form-control" id="maxMemoryMb" value="512" min="128" max="4096">
                                                <div class="form-text">Recommended: 512 MB</div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Max Execution Time (s)</label>
                                                <input type="number" class="form-control" id="maxExecutionTime" value="300" min="30" max="3600">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Process Priority (nice)</label>
                                                <input type="number" class="form-control" id="niceLevel" value="10" min="0" max="19">
                                                <div class="form-text">Higher = lower priority (10-19 safe)</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Monitoring Status Card -->
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-heartbeat me-2"></i>Monitoring Status</h5>
                                    <button class="btn btn-sm btn-outline-primary" id="refreshMonitoringStatus">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-md-4">
                                            <div class="h4" id="monitoringStatusIcon">
                                                <span class="status-indicator status-disconnected"></span>
                                            </div>
                                            <small class="text-muted">Status</small>
                                            <div id="monitoringRunning">Not Running</div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="h4 text-primary" id="totalAlerts">0</div>
                                            <small class="text-muted">Total Alerts</small>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="h4" id="lastRunTime">Never</div>
                                            <small class="text-muted">Last Run</small>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <button class="btn btn-warning" id="runMonitoringNow">
                                            <i class="fas fa-play me-1"></i>Run Now
                                        </button>
                                        <button class="btn btn-outline-secondary" id="viewMonitoringReports">
                                            <i class="fas fa-file-alt me-1"></i>View Reports
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Alerts Card -->
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Recent Drift Alerts</h5>
                                </div>
                                <div class="card-body">
                                    <div id="driftAlertsContainer">
                                        <p class="text-muted text-center">No recent alerts</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Threshold Tuning Section -->
                <div id="threshold-tuning" class="config-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2><i class="fas fa-sliders-h me-2"></i>Threshold Auto-Tuning</h2>
                            <p class="text-muted mb-0">Automatic calibration of Active Learning thresholds</p>
                        </div>
                        <button class="btn btn-outline-primary" id="refreshThresholdTuning">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>

                    <!-- Circuit Breaker Alert -->
                    <div class="alert alert-danger d-none mb-4" id="circuitBreakerAlert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Circuit Breaker Active!</strong> Auto-tuning is disabled due to performance degradation.
                        <button class="btn btn-sm btn-outline-danger ms-3" id="resetCircuitBreakerBtn">
                            Reset Circuit Breaker
                        </button>
                    </div>

                    <!-- Level Selector Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-gauge-high me-2"></i>Auto-Tuning Level</h5>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="tuning-slider-container">
                                        <input type="range" class="form-range" min="0" max="3" step="1"
                                               id="tuningLevelSlider" value="0">
                                        <div class="d-flex justify-content-between mt-2">
                                            <span class="badge bg-secondary slider-label" data-level="0">OFF</span>
                                            <span class="badge bg-info slider-label" data-level="1">LOW</span>
                                            <span class="badge bg-warning slider-label" data-level="2">MID</span>
                                            <span class="badge bg-success slider-label" data-level="3">HIGH</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div id="tuningLevelInfo" class="alert alert-secondary mb-0">
                                        <strong id="levelTitle">Disabled</strong>
                                        <p class="mb-0 small" id="levelDescription">Static thresholds. No metrics collection.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-primary" id="applyTuningLevel" disabled>
                                    <i class="fas fa-check me-1"></i>Apply Level
                                </button>
                                <button class="btn btn-outline-secondary ms-2" id="resetThresholdsBtn">
                                    <i class="fas fa-undo me-1"></i>Reset to Defaults
                                </button>
                                <button class="btn btn-outline-warning ms-2" id="rollbackThresholdsBtn">
                                    <i class="fas fa-history me-1"></i>Rollback to Last Good
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Metrics Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Effectiveness Metrics (30 days)</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <h3 class="mb-0" id="metricReviewRate">--%</h3>
                                        <small class="text-muted">Review Rate</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <h3 class="mb-0 text-warning" id="metricFPRate">--%</h3>
                                        <small class="text-muted">False Positive Rate</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <h3 class="mb-0 text-danger" id="metricFNRate">--%</h3>
                                        <small class="text-muted">False Negative Rate</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <h3 class="mb-0 text-success" id="metricF1Score">--%</h3>
                                        <small class="text-muted">F1 Score</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="p-3 border rounded">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span>Precision</span>
                                            <span id="metricPrecision">--%</span>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-info" id="precisionBar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="p-3 border rounded">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span>Recall</span>
                                            <span id="metricRecall">--%</span>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-success" id="recallBar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Current Thresholds Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Current Thresholds</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Threshold</th>
                                        <th>Current Value</th>
                                        <th>Min</th>
                                        <th>Max</th>
                                        <th>Default</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="thresholdsTable">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Recommendations Card -->
                    <div class="card mb-4" id="recommendationsCard" style="display: none;">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Recommendations</h5>
                            <button class="btn btn-sm btn-light" id="generateRecommendationsBtn">
                                <i class="fas fa-magic me-1"></i>Generate New
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="recommendationsList">
                                <p class="text-center text-muted">No pending recommendations</p>
                            </div>
                        </div>
                    </div>

                    <!-- Audit Log Card -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-history me-2"></i>Change History</h5>
                        </div>
                        <div class="card-body">
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>Action</th>
                                            <th>Threshold</th>
                                            <th>Change</th>
                                            <th>By</th>
                                            <th>Reason</th>
                                        </tr>
                                    </thead>
                                    <tbody id="auditLogTable">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">No changes recorded</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

    <script>
        // Navigation handling
        document.addEventListener('DOMContentLoaded', function() {
            // Navigation tab switching
            const navLinks = document.querySelectorAll('.nav-link');
            const configSections = document.querySelectorAll('.config-section');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all links and sections
                    navLinks.forEach(l => l.classList.remove('active'));
                    configSections.forEach(s => s.classList.remove('active'));
                    
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    // Show corresponding section
                    const target = this.getAttribute('data-target');
                    document.getElementById(target).classList.add('active');
                });
            });
            
            // Add instance functionality
            document.getElementById('addInstanceBtn').addEventListener('click', function() {
                const input = document.getElementById('newInstanceInput');
                const value = input.value.trim();
                
                if (value) {
                    const instancesList = document.getElementById('instancesList');
                    const instanceDiv = document.createElement('div');
                    instanceDiv.className = 'alert alert-secondary alert-sm d-flex justify-content-between align-items-center mb-2';
                    instanceDiv.innerHTML = `
                        <span>${value}</span>
                        <button class="btn-close" type="button"></button>
                    `;
                    
                    instancesList.appendChild(instanceDiv);
                    input.value = '';
                    
                    // Add remove functionality
                    instanceDiv.querySelector('.btn-close').addEventListener('click', function() {
                        instanceDiv.remove();
                    });
                }
            });
            
            // Test notification button
            document.getElementById('testNotificationBtn').addEventListener('click', function() {
                showToast('Test notification sent successfully!', 'success');
            });
            
            // Save configuration button – call API to persist Teams settings
            document.getElementById('saveTeamsConfig').addEventListener('click', async function() {
                try {
                    await saveTeamsConfig();
                    showToast('Teams configuration saved successfully!', 'success');
                } catch (err) {
                    console.error('Failed to save Teams configuration:', err);
                    showToast('Erro ao salvar a configuração do Teams.', 'error');
                }
            });
            
            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', function() {
                showToast('Configuration refreshed', 'info');
            });
            
            // Initialize with some sample instances for Teams integration
            const sampleInstances = ['TWS_NAZ', 'TWS_SAZ'];
            const instancesList = document.getElementById('instancesList');
            
            sampleInstances.forEach(instance => {
                const instanceDiv = document.createElement('div');
                instanceDiv.className = 'alert alert-secondary alert-sm d-flex justify-content-between align-items-center mb-2';
                instanceDiv.innerHTML = `
                    <span>${instance}</span>
                    <button class="btn-close" type="button"></button>
                `;
                
                instancesList.appendChild(instanceDiv);
                
                // Add remove functionality
                instanceDiv.querySelector('.btn-close').addEventListener('click', function() {
                    instanceDiv.remove();
                });
            });

            // Event listener for adding TWS instances
            document.getElementById('addTwsInstanceBtn').addEventListener('click', function() {
                const input = document.getElementById('newTwsInstanceInput');
                const value = input.value.trim();
                if (value) {
                    const list = document.getElementById('twsInstancesList');
                    const div = document.createElement('div');
                    div.className = 'alert alert-secondary alert-sm d-flex justify-content-between align-items-center mb-2';
                    div.innerHTML = `<span>${value}</span><button class="btn-close" type="button"></button>`;
                    list.appendChild(div);
                    input.value = '';
                    div.querySelector('.btn-close').addEventListener('click', function() { div.remove(); });
                }
            });

            // Save TWS configuration
            document.getElementById('saveTwsConfig').addEventListener('click', async function() {
                try {
                    await saveTwsConfig();
                    showToast('TWS configuration saved successfully!', 'success');
                } catch (err) {
                    console.error('Failed to save TWS configuration:', err);
                    showToast('Erro ao salvar a configuração TWS.', 'error');
                }
            });

            // Save system settings
            document.getElementById('saveSystemSettings').addEventListener('click', async function() {
                try {
                    await saveSystemSettings();
                    showToast('System settings saved successfully!', 'success');
                } catch (err) {
                    console.error('Failed to save system settings:', err);
                    showToast('Erro ao salvar configurações de sistema.', 'error');
                }
            });

            // Save notifications
            document.getElementById('saveNotificationsBtn').addEventListener('click', async function() {
                try {
                    await saveNotifications();
                    showToast('Notification settings saved successfully!', 'success');
                } catch (err) {
                    console.error('Failed to save notifications:', err);
                    showToast('Erro ao salvar configurações de notificações.', 'error');
                }
            });

            // Load logs
            document.getElementById('loadLogsBtn').addEventListener('click', function() {
                loadLogs();
            });

            // Create backup
            document.getElementById('createBackupBtn').addEventListener('click', function() {
                createBackup();
            });

            // Restore backup
            document.getElementById('restoreBackupBtn').addEventListener('click', function() {
                restoreBackup();
            });

            // Load audit logs
            document.getElementById('loadAuditBtn').addEventListener('click', function() {
                loadAudit();
            });

            // Refresh health status
            document.getElementById('refreshHealthBtn').addEventListener('click', function() {
                loadHealthStatus();
            });

            // Load persisted configuration when the page loads
            loadTeamsConfig();
            loadTwsConfig();
            loadSystemSettings();
            loadNotifications();
            loadHealthStatus();
        });
        
        // Fetch current Teams configuration from the backend and populate form fields
        async function loadTeamsConfig() {
            try {
                const resp = await fetch('/api/v1/admin/teams-config');
                if (!resp.ok) {
                    throw new Error(`Erro HTTP ${resp.status}`);
                }
                const data = await resp.json();
                // Populate the form fields with the returned values
                document.getElementById('teamsEnabled').checked = Boolean(data.enabled);
                document.getElementById('webhookUrl').value = data.webhook_url || '';
                document.getElementById('channelName').value = data.channel_name || '';
                document.getElementById('botName').value = data.bot_name || '';
                document.getElementById('avatarUrl').value = data.avatar_url || '';
            } catch (error) {
                console.error('Failed to load Teams configuration:', error);
                showToast('Erro ao carregar a configuração do Teams.', 'error');
            }
        }

        // Save Teams configuration to the backend
        async function saveTeamsConfig() {
            const payload = {
                enabled: document.getElementById('teamsEnabled').checked,
                webhook_url: document.getElementById('webhookUrl').value.trim(),
                channel_name: document.getElementById('channelName').value.trim(),
                bot_name: document.getElementById('botName').value.trim(),
                avatar_url: document.getElementById('avatarUrl').value.trim(),
            };
            const resp = await fetch('/api/v1/admin/teams-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            if (!resp.ok) {
                const detail = await resp.text();
                throw new Error(`Erro ${resp.status}: ${detail}`);
            }
            // HTTP 204 No Content indicates success
        }

        // Load TWS configuration from backend and populate the form
        async function loadTwsConfig() {
            try {
                const resp = await fetch('/api/v1/admin/tws-config');
                if (!resp.ok) {
                    throw new Error(`Erro HTTP ${resp.status}`);
                }
                const data = await resp.json();
                // Set primary instance
                document.getElementById('primaryTwsInstance').value = data.primary_instance || '';
                // Clear existing list
                const list = document.getElementById('twsInstancesList');
                list.innerHTML = '';
                (data.monitored_instances || []).forEach(instance => {
                    const div = document.createElement('div');
                    div.className = 'alert alert-secondary alert-sm d-flex justify-content-between align-items-center mb-2';
                    div.innerHTML = `<span>${instance}</span><button class="btn-close" type="button"></button>`;
                    list.appendChild(div);
                    div.querySelector('.btn-close').addEventListener('click', function() {
                        div.remove();
                    });
                });
            } catch (error) {
                console.error('Failed to load TWS configuration:', error);
                showToast('Erro ao carregar a configuração TWS.', 'error');
            }
        }

        // Save TWS configuration to backend
        async function saveTwsConfig() {
            const primary = document.getElementById('primaryTwsInstance').value.trim();
            const list = document.getElementById('twsInstancesList');
            const instances = [];
            list.querySelectorAll('span').forEach(el => {
                const name = el.textContent.trim();
                if (name) instances.push(name);
            });
            const payload = {
                primary_instance: primary,
                monitored_instances: instances
            };
            const resp = await fetch('/api/v1/admin/tws-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!resp.ok) {
                const detail = await resp.text();
                throw new Error(`Erro ${resp.status}: ${detail}`);
            }
        }

        // Load system settings from backend and populate the form
        async function loadSystemSettings() {
            try {
                const resp = await fetch('/api/v1/admin/system-settings');
                if (!resp.ok) throw new Error(`Erro HTTP ${resp.status}`);
                const data = await resp.json();
                // Environment select
                const envSelect = document.getElementById('envSelect');
                envSelect.value = data.environment || 'Production';
                // Debug select
                const debugSelect = document.getElementById('debugSelect');
                debugSelect.value = data.debug_mode ? 'Enabled' : 'Disabled';
                // Toggles
                document.getElementById('sslEnabled').checked = Boolean(data.ssl_enabled);
                document.getElementById('cspEnabled').checked = Boolean(data.csp_enabled);
                document.getElementById('corsEnabled').checked = Boolean(data.cors_enabled);
            } catch (error) {
                console.error('Failed to load system settings:', error);
                showToast('Erro ao carregar configurações de sistema.', 'error');
            }
        }

        // Save system settings to backend
        async function saveSystemSettings() {
            const env = document.getElementById('envSelect').value;
            const debugMode = document.getElementById('debugSelect').value === 'Enabled';
            const payload = {
                environment: env,
                debug_mode: debugMode,
                ssl_enabled: document.getElementById('sslEnabled').checked,
                csp_enabled: document.getElementById('cspEnabled').checked,
                cors_enabled: document.getElementById('corsEnabled').checked,
            };
            const resp = await fetch('/api/v1/admin/system-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!resp.ok) {
                const detail = await resp.text();
                throw new Error(`Erro ${resp.status}: ${detail}`);
            }
        }

        // Load notifications settings
        async function loadNotifications() {
            try {
                const resp = await fetch('/api/v1/admin/notifications');
                if (!resp.ok) throw new Error(`Erro HTTP ${resp.status}`);
                const data = await resp.json();
                // Set selected options for job status filters
                const select = document.getElementById('notifStatusFilters');
                const filters = data.job_status_filters || [];
                Array.from(select.options).forEach(opt => {
                    opt.selected = filters.includes(opt.value);
                });
                // Set toggles
                document.getElementById('notifyJobStatus').checked = Boolean(data.notify_job_status);
                document.getElementById('notifyAlerts').checked = Boolean(data.notify_alerts);
                document.getElementById('notifyPerformance').checked = Boolean(data.notify_performance);
            } catch (error) {
                console.error('Failed to load notifications:', error);
                showToast('Erro ao carregar notificações.', 'error');
            }
        }

        // Save notifications settings
        async function saveNotifications() {
            const select = document.getElementById('notifStatusFilters');
            const filters = Array.from(select.options)
                .filter(opt => opt.selected)
                .map(opt => opt.value);
            const payload = {
                job_status_filters: filters,
                notify_job_status: document.getElementById('notifyJobStatus').checked,
                notify_alerts: document.getElementById('notifyAlerts').checked,
                notify_performance: document.getElementById('notifyPerformance').checked,
            };
            const resp = await fetch('/api/v1/admin/notifications', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!resp.ok) {
                const detail = await resp.text();
                throw new Error(`Erro ${resp.status}: ${detail}`);
            }
        }

        // Load logs from backend and display in textarea
        async function loadLogs() {
            const file = document.getElementById('logFileName').value.trim() || 'app.log';
            const lines = parseInt(document.getElementById('logLines').value, 10) || 100;
            try {
                const params = new URLSearchParams({ file, lines: lines.toString() });
                const resp = await fetch(`/api/v1/admin/logs?${params.toString()}`);
                if (!resp.ok) throw new Error(`Erro HTTP ${resp.status}`);
                const data = await resp.json();
                document.getElementById('logContent').textContent = data.content || '';
            } catch (error) {
                console.error('Failed to load logs:', error);
                showToast('Erro ao carregar logs.', 'error');
            }
        }

        // Create a backup via backend
        async function createBackup() {
            try {
                const resp = await fetch('/api/v1/admin/backup', { method: 'POST' });
                if (!resp.ok) throw new Error(`Erro HTTP ${resp.status}`);
                const data = await resp.json();
                document.getElementById('backupStatus').textContent = JSON.stringify(data, null, 2);
                showToast('Backup criado com sucesso!', 'success');
            } catch (error) {
                console.error('Failed to create backup:', error);
                showToast('Erro ao criar backup.', 'error');
            }
        }

        // Restore from latest backup via backend
        async function restoreBackup() {
            try {
                const resp = await fetch('/api/v1/admin/restore', { method: 'POST' });
                if (!resp.ok) throw new Error(`Erro HTTP ${resp.status}`);
                const data = await resp.json();
                document.getElementById('backupStatus').textContent = JSON.stringify(data, null, 2);
                showToast('Restauração concluída!', 'success');
            } catch (error) {
                console.error('Failed to restore backup:', error);
                showToast('Erro ao restaurar backup.', 'error');
            }
        }

        // Load audit records from backend
        async function loadAudit() {
            try {
                const resp = await fetch('/api/v1/admin/audit');
                if (!resp.ok) throw new Error(`Erro HTTP ${resp.status}`);
                const data = await resp.json();
                const tbody = document.getElementById('auditTableBody');
                tbody.innerHTML = '';
                (data.records || []).forEach((rec, idx) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<th scope="row">${idx + 1}</th><td>${rec.timestamp || rec.time || ''}</td><td>${rec.message || rec.action || JSON.stringify(rec)}</td>`;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Failed to load audit logs:', error);
                showToast('Erro ao carregar logs de auditoria.', 'error');
            }
        }

        // Health monitoring auto-refresh interval
        let healthRefreshInterval = null;

        // Update component card styling based on status
        function updateHealthCard(component, data) {
            const iconEl = document.getElementById(`healthIcon${component}`);
            const statusEl = document.getElementById(`health${component}Status`);
            const latencyEl = document.getElementById(`health${component}Latency`);
            const cardEl = document.getElementById(`healthCard${component}`);
            
            if (!statusEl) return;
            
            const status = data.status || 'unknown';
            const message = data.message || status;
            const latency = data.latency_ms;
            
            // Update status text
            statusEl.textContent = message;
            
            // Update latency if available
            if (latencyEl) {
                latencyEl.textContent = latency ? `${latency.toFixed(1)}ms` : '';
            }
            
            // Update icon color based on status
            if (iconEl) {
                iconEl.classList.remove('text-success', 'text-warning', 'text-danger', 'text-secondary');
                if (status === 'healthy') {
                    iconEl.classList.add('text-success');
                } else if (status === 'degraded') {
                    iconEl.classList.add('text-warning');
                } else if (status === 'unhealthy') {
                    iconEl.classList.add('text-danger');
                } else {
                    iconEl.classList.add('text-secondary');
                }
            }
            
            // Update card border
            if (cardEl) {
                cardEl.classList.remove('border-success', 'border-warning', 'border-danger');
                if (status === 'healthy') {
                    cardEl.classList.add('border-success');
                } else if (status === 'degraded') {
                    cardEl.classList.add('border-warning');
                } else if (status === 'unhealthy') {
                    cardEl.classList.add('border-danger');
                }
            }
        }

        // Load health status from backend and update all cards
        async function loadHealthStatus() {
            try {
                const resp = await fetch('/api/v1/admin/health');
                if (!resp.ok) throw new Error(`Erro HTTP ${resp.status}`);
                const data = await resp.json();
                
                // Update overall status banner
                const banner = document.getElementById('healthOverallBanner');
                const overallStatus = document.getElementById('healthOverallStatus');
                if (banner && overallStatus) {
                    banner.classList.remove('alert-success', 'alert-warning', 'alert-danger');
                    if (data.overall_status === 'healthy') {
                        banner.classList.add('alert-success');
                        overallStatus.textContent = 'All systems operational';
                    } else if (data.overall_status === 'degraded') {
                        banner.classList.add('alert-warning');
                        overallStatus.textContent = 'Some components degraded';
                    } else {
                        banner.classList.add('alert-danger');
                        overallStatus.textContent = 'System issues detected';
                    }
                }
                
                // Update individual component cards
                const components = data.components || {};
                
                // Map backend component names to frontend IDs
                const componentMap = {
                    'database': 'Database',
                    'redis': 'Redis',
                    'llm': 'LLM',
                    'rag': 'RAG',
                    'teams': 'Teams',
                    'tws': 'TWS'
                };
                
                for (const [backendName, frontendName] of Object.entries(componentMap)) {
                    if (components[backendName]) {
                        updateHealthCard(frontendName, components[backendName]);
                    }
                }
                
                // Update last check timestamp
                const lastCheckEl = document.getElementById('healthLastCheck');
                if (lastCheckEl) {
                    lastCheckEl.textContent = new Date().toLocaleTimeString();
                }
                
            } catch (error) {
                console.error('Failed to load health status:', error);
                showToast('Erro ao carregar status de saúde.', 'error');
            }
        }
        
        // Refresh health status (called by button)
        function refreshHealthStatus() {
            loadHealthStatus();
            showToast('Health status refreshed', 'info');
        }
        
        // Setup auto-refresh for health monitoring
        function setupHealthAutoRefresh() {
            const checkbox = document.getElementById('healthAutoRefresh');
            if (!checkbox) return;
            
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    healthRefreshInterval = setInterval(loadHealthStatus, 30000);
                } else {
                    if (healthRefreshInterval) {
                        clearInterval(healthRefreshInterval);
                        healthRefreshInterval = null;
                    }
                }
            });
            
            // Start auto-refresh if checked by default
            if (checkbox.checked) {
                healthRefreshInterval = setInterval(loadHealthStatus, 30000);
            }
        }
        
        // Initialize health auto-refresh on page load
        document.addEventListener('DOMContentLoaded', setupHealthAutoRefresh);

        // Toast notification function
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type} show`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="toast-header">
                    <strong class="me-auto">
                        ${type === 'success' ? '<i class="fas fa-check-circle me-1"></i>' : ''}
                        ${type === 'error' ? '<i class="fas fa-exclamation-circle me-1"></i>' : ''}
                        ${type === 'warning' ? '<i class="fas fa-exclamation-triangle me-1"></i>' : ''}
                        ${type === 'info' ? '<i class="fas fa-info-circle me-1"></i>' : ''}
                        Notification
                    </strong>
                    <small>Just now</small>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/admin.js"></script>
    
    <!-- LiteLLM Admin Module -->
    <script>
    const LiteLLMAdmin = {
        data: null,
        costChart: null,
        modelCostChart: null,
        initialized: false,
        
        async init() {
            if (this.initialized) return;
            this.initialized = true;
            
            await this.loadData();
            this.initCharts();
            this.bindEvents();
            
            // Auto-refresh every 30 seconds
            setInterval(() => this.loadData(), 30000);
        },
        
        async loadData() {
            try {
                const response = await fetch('/api/v1/litellm/dashboard-data', {
                    headers: { 'Authorization': 'Basic ' + btoa(adminCredentials || 'admin:admin') }
                });
                
                if (!response.ok) throw new Error('Failed to load');
                
                this.data = await response.json();
                this.updateUI();
                
            } catch (error) {
                console.error('LiteLLM data error:', error);
            }
        },
        
        updateUI() {
            if (!this.data) return;
            
            const { status, usage, costs, providers } = this.data;
            
            // Router status
            const routerIcon = document.getElementById('litellmRouterIcon');
            const routerStatus = document.getElementById('litellmRouterStatus');
            if (status.router_available) {
                routerIcon.innerHTML = '<i class="fas fa-server text-success"></i>';
                routerStatus.className = 'badge bg-success';
                routerStatus.textContent = 'Online';
            } else {
                routerIcon.innerHTML = '<i class="fas fa-server text-danger"></i>';
                routerStatus.className = 'badge bg-danger';
                routerStatus.textContent = 'Offline';
            }
            
            // Stats
            document.getElementById('litellmModelCount').textContent = this.data.models_count || 0;
            document.getElementById('litellmTodayCost').textContent = '$' + usage.cost_today_usd.toFixed(2);
            document.getElementById('litellmTotalRequests').textContent = this.formatNumber(usage.total_requests);
            
            // Budget
            document.getElementById('litellmBudgetUsed').textContent = '$' + costs.total_cost_usd.toFixed(2);
            document.getElementById('litellmBudgetLimit').textContent = '$' + costs.budget_limit_usd.toFixed(2);
            document.getElementById('litellmProjectedCost').textContent = '$' + costs.projected_monthly_cost.toFixed(2);
            
            const budgetBar = document.getElementById('litellmBudgetBar');
            const budgetPercent = Math.min(costs.budget_used_percent, 100);
            budgetBar.style.width = budgetPercent + '%';
            budgetBar.className = 'progress-bar' + (budgetPercent > 80 ? ' bg-danger' : budgetPercent > 60 ? ' bg-warning' : ' bg-success');
            
            document.getElementById('litellmBudgetAlert').style.display = budgetPercent > 70 ? 'inline' : 'none';
            
            // Usage stats
            document.getElementById('litellmStatRequests').textContent = this.formatNumber(usage.total_requests);
            document.getElementById('litellmStatInputTokens').textContent = this.formatNumber(usage.total_input_tokens);
            document.getElementById('litellmStatOutputTokens').textContent = this.formatNumber(usage.total_output_tokens);
            document.getElementById('litellmStatLatency').textContent = Math.round(usage.avg_response_time_ms) + 'ms';
            document.getElementById('litellmStatErrorRate').textContent = (usage.error_rate * 100).toFixed(1) + '%';
            document.getElementById('litellmStatTotalCost').textContent = '$' + usage.total_cost_usd.toFixed(2);
            
            // Render providers
            this.renderProviders(providers);
            
            // Update charts
            this.updateCharts();
        },
        
        renderProviders(providers) {
            const grid = document.getElementById('litellmProvidersGrid');
            const icons = {
                'OpenAI': 'fa-robot',
                'Anthropic': 'fa-brain',
                'Ollama (Local)': 'fa-home',
                'Together AI': 'fa-layer-group',
                'NVIDIA NIM': 'fa-microchip',
                'OpenRouter': 'fa-random'
            };
            
            grid.innerHTML = providers.map(p => `
                <div class="col-md-4 mb-3">
                    <div class="card h-100 ${!p.configured ? 'opacity-50' : ''}">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas ${icons[p.name] || 'fa-cloud'} fa-2x me-3 ${p.configured ? 'text-primary' : 'text-muted'}"></i>
                                <div>
                                    <h6 class="mb-0">${p.name}</h6>
                                    <span class="badge ${p.configured ? 'bg-success' : 'bg-secondary'}">
                                        ${p.configured ? 'Configured' : 'Not Configured'}
                                    </span>
                                </div>
                            </div>
                            <small class="text-muted">
                                Models: ${p.models_available.slice(0, 3).join(', ')}
                                ${p.models_available.length > 3 ? '...' : ''}
                            </small>
                        </div>
                    </div>
                </div>
            `).join('');
        },
        
        async refreshModels() {
            try {
                const response = await fetch('/api/v1/litellm/models', {
                    headers: { 'Authorization': 'Basic ' + btoa(adminCredentials || 'admin:admin') }
                });
                
                if (!response.ok) return;
                
                const models = await response.json();
                const grid = document.getElementById('litellmModelsGrid');
                
                grid.innerHTML = models.map(m => `
                    <div class="col-md-4 mb-3" data-provider="${m.provider}" data-local="${m.is_local}">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0">${m.name}</h6>
                                    <span class="badge bg-secondary">${m.provider}</span>
                                </div>
                                <small class="text-muted d-block">Max: ${m.max_tokens ? this.formatNumber(m.max_tokens) : 'N/A'} tokens</small>
                                <div class="mt-2">
                                    ${m.is_local ? 
                                        '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Free (Local)</span>' :
                                        `<small>In: $${m.input_cost_per_1k}/1K | Out: $${m.output_cost_per_1k}/1K</small>`
                                    }
                                </div>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="LiteLLMAdmin.testModel('${m.name}')">
                                    <i class="fas fa-flask me-1"></i>Test
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Failed to load models:', error);
            }
        },
        
        initCharts() {
            // Daily cost chart
            const costCtx = document.getElementById('litellmCostChart')?.getContext('2d');
            if (costCtx) {
                this.costChart = new Chart(costCtx, {
                    type: 'line',
                    data: { labels: [], datasets: [{ label: 'Daily Cost ($)', data: [], borderColor: '#667eea', fill: true, backgroundColor: 'rgba(102, 126, 234, 0.1)' }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }
            
            // Model cost chart
            const modelCtx = document.getElementById('litellmModelCostChart')?.getContext('2d');
            if (modelCtx) {
                this.modelCostChart = new Chart(modelCtx, {
                    type: 'doughnut',
                    data: { labels: [], datasets: [{ data: [], backgroundColor: ['#667eea', '#764ba2', '#48c774', '#ffb347', '#f66d9b'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            }
        },
        
        updateCharts() {
            if (!this.data) return;
            const { costs } = this.data;
            
            if (this.costChart && costs.daily_costs) {
                const labels = Object.keys(costs.daily_costs).slice(-7);
                const data = labels.map(d => costs.daily_costs[d]);
                this.costChart.data.labels = labels;
                this.costChart.data.datasets[0].data = data;
                this.costChart.update();
            }
            
            if (this.modelCostChart && costs.model_costs) {
                this.modelCostChart.data.labels = Object.keys(costs.model_costs);
                this.modelCostChart.data.datasets[0].data = Object.values(costs.model_costs);
                this.modelCostChart.update();
            }
        },
        
        testModel(modelName) {
            document.getElementById('testModelName').value = modelName;
            document.getElementById('testModelResult').style.display = 'none';
            new bootstrap.Modal(document.getElementById('testModelModal')).show();
        },
        
        async runTest() {
            const model = document.getElementById('testModelName').value;
            const prompt = document.getElementById('testModelPrompt').value;
            const resultDiv = document.getElementById('testModelResult');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'alert alert-info';
            resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
            
            try {
                const response = await fetch('/api/v1/litellm/test', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa(adminCredentials || 'admin:admin'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ model, prompt })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.className = 'alert alert-success';
                    resultDiv.innerHTML = `<i class="fas fa-check-circle me-2"></i><strong>Success!</strong><br>
                        <small>Response: ${result.response}</small><br>
                        <small>Latency: ${Math.round(result.latency_ms)}ms</small>`;
                } else {
                    resultDiv.className = 'alert alert-danger';
                    resultDiv.innerHTML = `<i class="fas fa-times-circle me-2"></i><strong>Failed</strong><br>
                        <small>Error: ${result.error}</small>`;
                }
            } catch (error) {
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = `<i class="fas fa-times-circle me-2"></i>Error: ${error.message}`;
            }
        },
        
        async saveRouting() {
            const config = {
                LLM_ROUTING_ENABLED: document.getElementById('litellmRoutingEnabled').checked,
                LLM_ROUTING_SIMPLE_MODEL: document.getElementById('litellmSimpleModel').value,
                LLM_ROUTING_COMPLEX_MODEL: document.getElementById('litellmComplexModel').value,
                LLM_ROUTING_FALLBACK_MODEL: document.getElementById('litellmFallbackModel').value,
                LLM_PREFER_LOCAL_MODELS: document.getElementById('litellmPreferLocal').checked
            };
            
            try {
                const response = await fetch('/api/v1/system-config/update', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa(adminCredentials || 'admin:admin'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ updates: config })
                });
                
                const result = await response.json();
                showToast(result.success ? 'Routing configuration saved!' : 'Failed to save', result.success ? 'success' : 'error');
                
            } catch (error) {
                showToast('Error saving configuration', 'error');
            }
        },
        
        bindEvents() {
            // Model search filter
            document.getElementById('litellmModelSearch')?.addEventListener('input', (e) => {
                const search = e.target.value.toLowerCase();
                document.querySelectorAll('#litellmModelsGrid > div').forEach(card => {
                    const name = card.querySelector('h6')?.textContent.toLowerCase() || '';
                    card.style.display = name.includes(search) ? '' : 'none';
                });
            });
            
            // Provider filter
            document.getElementById('litellmProviderFilter')?.addEventListener('change', (e) => {
                const provider = e.target.value.toLowerCase();
                document.querySelectorAll('#litellmModelsGrid > div').forEach(card => {
                    const cardProvider = card.dataset.provider?.toLowerCase() || '';
                    card.style.display = !provider || cardProvider === provider ? '' : 'none';
                });
            });
            
            // Local only filter
            document.getElementById('litellmLocalOnly')?.addEventListener('change', (e) => {
                const localOnly = e.target.checked;
                document.querySelectorAll('#litellmModelsGrid > div').forEach(card => {
                    const isLocal = card.dataset.local === 'true';
                    card.style.display = !localOnly || isLocal ? '' : 'none';
                });
            });
        },
        
        formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }
    };
    
    // Initialize when LiteLLM section is shown
    document.querySelector('[data-target="litellm-config"]')?.addEventListener('click', () => {
        setTimeout(() => {
            LiteLLMAdmin.init();
            LiteLLMAdmin.refreshModels();
        }, 100);
    });
    
    // ===========================================
    // TWS Instances Admin Module
    // ===========================================
    const TWSInstancesAdmin = {
        instances: [],
        
        async init() {
            await this.refresh();
        },
        
        async refresh() {
            try {
                const response = await fetch('/api/v1/admin/tws-instances');
                const data = await response.json();
                this.instances = data.instances || [];
                this.updateUI();
            } catch (error) {
                console.error('Failed to load TWS instances:', error);
                this.showError('Failed to load TWS instances');
            }
        },
        
        updateUI() {
            // Update counts
            const connected = this.instances.filter(i => i.status === 'connected').length;
            const errors = this.instances.filter(i => i.status === 'error').length;
            const pending = this.instances.filter(i => i.status === 'connecting').length;
            
            document.getElementById('tws-total-instances').textContent = this.instances.length;
            document.getElementById('tws-connected-count').textContent = connected;
            document.getElementById('tws-pending-count').textContent = pending;
            document.getElementById('tws-error-count').textContent = errors;
            document.getElementById('tws-instance-count').textContent = this.instances.length;
            
            // Update table
            const tbody = document.getElementById('tws-instances-table');
            
            if (this.instances.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-muted">
                            <i class="fas fa-server me-2"></i>No TWS instances configured.
                            <a href="#" data-bs-toggle="modal" data-bs-target="#addTWSInstanceModal">Add one now</a>
                        </td>
                    </tr>`;
                return;
            }
            
            tbody.innerHTML = this.instances.map(inst => {
                const statusBadge = this.getStatusBadge(inst.status);
                const envBadge = this.getEnvBadge(inst.environment);
                
                return `
                    <tr>
                        <td>
                            <span class="d-inline-block rounded-circle" 
                                  style="width: 12px; height: 12px; background-color: ${inst.color || '#3b82f6'}">
                            </span>
                        </td>
                        <td>
                            <strong>${inst.name}</strong>
                            <br><small class="text-muted">${inst.display_name}</small>
                        </td>
                        <td><code>${inst.host}:${inst.port}</code></td>
                        <td>${envBadge}</td>
                        <td>${statusBadge}</td>
                        <td>
                            ${inst.learning_enabled 
                                ? '<span class="badge bg-success"><i class="fas fa-brain me-1"></i>Active</span>' 
                                : '<span class="badge bg-secondary">Disabled</span>'}
                        </td>
                        <td class="text-end">
                            <div class="btn-group btn-group-sm">
                                ${inst.status === 'connected' 
                                    ? `<button class="btn btn-outline-warning" onclick="TWSInstancesAdmin.disconnect('${inst.id}')" title="Disconnect">
                                         <i class="fas fa-unlink"></i>
                                       </button>`
                                    : `<button class="btn btn-outline-success" onclick="TWSInstancesAdmin.connect('${inst.id}')" title="Connect">
                                         <i class="fas fa-plug"></i>
                                       </button>`
                                }
                                <button class="btn btn-outline-info" onclick="TWSInstancesAdmin.test('${inst.id}')" title="Test">
                                    <i class="fas fa-vial"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="TWSInstancesAdmin.edit('${inst.id}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="TWSInstancesAdmin.delete('${inst.id}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
            }).join('');
        },
        
        getStatusBadge(status) {
            const badges = {
                'connected': '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Connected</span>',
                'disconnected': '<span class="badge bg-secondary"><i class="fas fa-times me-1"></i>Disconnected</span>',
                'connecting': '<span class="badge bg-warning"><i class="fas fa-spinner fa-spin me-1"></i>Connecting</span>',
                'error': '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>Error</span>',
            };
            return badges[status] || badges['disconnected'];
        },
        
        getEnvBadge(env) {
            const badges = {
                'production': '<span class="badge bg-danger">PROD</span>',
                'staging': '<span class="badge bg-warning text-dark">STAGING</span>',
                'development': '<span class="badge bg-info">DEV</span>',
                'dr': '<span class="badge bg-purple" style="background-color:#8b5cf6;">DR</span>',
            };
            return badges[env] || `<span class="badge bg-secondary">${env}</span>`;
        },
        
        async addInstance() {
            const instance = {
                name: document.getElementById('tws-new-name').value.toUpperCase(),
                display_name: document.getElementById('tws-new-display-name').value,
                host: document.getElementById('tws-new-host').value,
                port: parseInt(document.getElementById('tws-new-port').value) || 31116,
                username: document.getElementById('tws-new-username').value,
                password: document.getElementById('tws-new-password').value,
                environment: document.getElementById('tws-new-environment').value,
                color: document.getElementById('tws-new-color').value,
                ssl_enabled: document.getElementById('tws-new-ssl').checked,
                learning_enabled: document.getElementById('tws-new-learning').checked,
                description: document.getElementById('tws-new-description').value,
            };
            
            if (!instance.name || !instance.display_name || !instance.host) {
                this.showError('Please fill in all required fields');
                return;
            }
            
            try {
                const response = await fetch('/api/v1/admin/tws-instances', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(instance),
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    this.showSuccess(`Instance '${instance.name}' created successfully`);
                    bootstrap.Modal.getInstance(document.getElementById('addTWSInstanceModal')).hide();
                    document.getElementById('addTWSInstanceForm').reset();
                    await this.refresh();
                } else {
                    this.showError(result.detail || 'Failed to create instance');
                }
            } catch (error) {
                this.showError('Failed to create instance: ' + error.message);
            }
        },
        
        async connect(instanceId) {
            try {
                const response = await fetch(`/api/v1/admin/tws-instances/${instanceId}/connect`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    this.showSuccess('Connected successfully');
                } else {
                    this.showError(result.message || 'Connection failed');
                }
                await this.refresh();
            } catch (error) {
                this.showError('Connection failed: ' + error.message);
            }
        },
        
        async disconnect(instanceId) {
            try {
                await fetch(`/api/v1/admin/tws-instances/${instanceId}/disconnect`, { method: 'POST' });
                this.showSuccess('Disconnected');
                await this.refresh();
            } catch (error) {
                this.showError('Disconnect failed: ' + error.message);
            }
        },
        
        async test(instanceId) {
            try {
                const response = await fetch(`/api/v1/admin/tws-instances/${instanceId}/test`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    this.showSuccess(`Connection test successful (${result.latency_ms}ms)`);
                } else {
                    this.showError(`Connection test failed: ${result.error}`);
                }
            } catch (error) {
                this.showError('Test failed: ' + error.message);
            }
        },
        
        edit(instanceId) {
            const inst = this.instances.find(i => i.id === instanceId);
            if (!inst) return;
            
            document.getElementById('tws-edit-id').value = inst.id;
            document.getElementById('tws-edit-name').value = inst.name;
            document.getElementById('tws-edit-display-name').value = inst.display_name;
            document.getElementById('tws-edit-host').value = inst.host;
            document.getElementById('tws-edit-port').value = inst.port;
            document.getElementById('tws-edit-environment').value = inst.environment;
            document.getElementById('tws-edit-color').value = inst.color || '#3b82f6';
            document.getElementById('tws-edit-enabled').checked = inst.enabled !== false;
            document.getElementById('tws-edit-learning').checked = inst.learning_enabled !== false;
            
            new bootstrap.Modal(document.getElementById('editTWSInstanceModal')).show();
        },
        
        async saveInstance() {
            const instanceId = document.getElementById('tws-edit-id').value;
            const updates = {
                display_name: document.getElementById('tws-edit-display-name').value,
                host: document.getElementById('tws-edit-host').value,
                port: parseInt(document.getElementById('tws-edit-port').value),
                environment: document.getElementById('tws-edit-environment').value,
                color: document.getElementById('tws-edit-color').value,
                enabled: document.getElementById('tws-edit-enabled').checked,
                learning_enabled: document.getElementById('tws-edit-learning').checked,
            };
            
            try {
                const response = await fetch(`/api/v1/admin/tws-instances/${instanceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates),
                });
                
                if (response.ok) {
                    this.showSuccess('Instance updated successfully');
                    bootstrap.Modal.getInstance(document.getElementById('editTWSInstanceModal')).hide();
                    await this.refresh();
                } else {
                    const result = await response.json();
                    this.showError(result.detail || 'Update failed');
                }
            } catch (error) {
                this.showError('Update failed: ' + error.message);
            }
        },
        
        async delete(instanceId) {
            const inst = this.instances.find(i => i.id === instanceId);
            if (!inst) return;
            
            if (!confirm(`Are you sure you want to delete instance '${inst.name}'?\nThis will also delete all learning data for this instance.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/v1/admin/tws-instances/${instanceId}`, { method: 'DELETE' });
                
                if (response.ok) {
                    this.showSuccess(`Instance '${inst.name}' deleted`);
                    await this.refresh();
                } else {
                    const result = await response.json();
                    this.showError(result.detail || 'Delete failed');
                }
            } catch (error) {
                this.showError('Delete failed: ' + error.message);
            }
        },
        
        async connectAll() {
            try {
                const response = await fetch('/api/v1/admin/tws-instances/bulk/connect', { method: 'POST' });
                const result = await response.json();
                this.showSuccess(`Connected: ${result.connected}, Failed: ${result.failed}`);
                await this.refresh();
            } catch (error) {
                this.showError('Bulk connect failed: ' + error.message);
            }
        },
        
        async disconnectAll() {
            if (!confirm('Disconnect from all TWS instances?')) return;
            
            try {
                await fetch('/api/v1/admin/tws-instances/bulk/disconnect', { method: 'POST' });
                this.showSuccess('All instances disconnected');
                await this.refresh();
            } catch (error) {
                this.showError('Bulk disconnect failed: ' + error.message);
            }
        },
        
        async testNewConnection() {
            // TODO: Implement test for new connection before saving
            this.showSuccess('Connection test not yet implemented for new instances');
        },
        
        showSuccess(message) {
            // Use the existing toast mechanism or create alert
            alert('✅ ' + message);
        },
        
        showError(message) {
            alert('❌ ' + message);
        }
    };
    
    // Initialize when TWS Instances section is shown
    document.querySelector('[data-target="tws-instances"]')?.addEventListener('click', () => {
        setTimeout(() => TWSInstancesAdmin.init(), 100);
    });

    // =========================================================================
    // AI Monitoring Module (Specialists + Evidently)
    // =========================================================================
    const AIMonitoring = {
        config: null,
        initialized: false,
        
        async init() {
            if (this.initialized) return;
            this.initialized = true;
            
            await this.loadConfig();
            await this.loadStatus();
            this.bindEvents();
            
            // Auto-refresh status every 60 seconds
            setInterval(() => this.loadStatus(), 60000);
        },
        
        async loadConfig() {
            try {
                const response = await fetch('/api/v1/admin/ai/config');
                if (!response.ok) throw new Error('Failed to load config');
                
                this.config = await response.json();
                this.updateConfigUI();
                
            } catch (error) {
                console.error('AI config load error:', error);
                showToast('Failed to load AI configuration', 'error');
            }
        },
        
        updateConfigUI() {
            if (!this.config) return;
            
            const { specialists, monitoring } = this.config;
            
            // Specialists config
            document.getElementById('specialistsEnabled').checked = specialists?.enabled ?? true;
            document.getElementById('executionMode').value = specialists?.execution_mode ?? 'coordinate';
            document.getElementById('teamTimeout').value = specialists?.timeout_seconds ?? 45;
            document.getElementById('parallelExecution').checked = specialists?.parallel_execution ?? true;
            document.getElementById('fallbackGeneral').checked = specialists?.fallback_to_general ?? true;
            
            // Job Analyst
            const ja = specialists?.job_analyst || {};
            document.getElementById('jobAnalystEnabled').checked = ja.enabled ?? true;
            document.getElementById('jobAnalystModel').value = ja.model_name ?? 'gpt-4o';
            document.getElementById('jobAnalystTemp').value = ja.temperature ?? 0.2;
            document.getElementById('jobAnalystTimeout').value = ja.timeout_seconds ?? 30;
            
            // Dependency Specialist
            const ds = specialists?.dependency_specialist || {};
            document.getElementById('dependencyEnabled').checked = ds.enabled ?? true;
            document.getElementById('dependencyModel').value = ds.model_name ?? 'gpt-4o';
            document.getElementById('dependencyTemp').value = ds.temperature ?? 0.1;
            document.getElementById('dependencyTimeout').value = ds.timeout_seconds ?? 30;
            
            // Resource Specialist
            const rs = specialists?.resource_specialist || {};
            document.getElementById('resourceEnabled').checked = rs.enabled ?? true;
            document.getElementById('resourceModel').value = rs.model_name ?? 'gpt-4o';
            document.getElementById('resourceTemp').value = rs.temperature ?? 0.2;
            document.getElementById('resourceTimeout').value = rs.timeout_seconds ?? 25;
            
            // Knowledge Specialist
            const ks = specialists?.knowledge_specialist || {};
            document.getElementById('knowledgeEnabled').checked = ks.enabled ?? true;
            document.getElementById('knowledgeModel').value = ks.model_name ?? 'gpt-4o';
            document.getElementById('knowledgeTemp').value = ks.temperature ?? 0.4;
            document.getElementById('knowledgeTimeout').value = ks.timeout_seconds ?? 35;
            
            // Monitoring config
            document.getElementById('monitoringEnabled').checked = monitoring?.enabled ?? true;
            document.getElementById('monitoringSchedule').value = monitoring?.schedule?.type ?? 'daily';
            document.getElementById('monitoringTime').value = monitoring?.schedule?.time ?? '03:00';
            
            // Drift detection
            const drift = monitoring?.drift_detection || {};
            document.getElementById('dataDriftEnabled').checked = drift.data_drift_enabled ?? true;
            document.getElementById('predictionDriftEnabled').checked = drift.prediction_drift_enabled ?? true;
            document.getElementById('targetDriftEnabled').checked = drift.target_drift_enabled ?? true;
            document.getElementById('driftThreshold').value = drift.drift_threshold ?? 0.15;
            document.getElementById('alertThreshold').value = drift.alert_threshold ?? 0.25;
            document.getElementById('referenceWindow').value = drift.reference_window_days ?? 7;
            document.getElementById('currentWindow').value = drift.current_window_hours ?? 24;
            
            // Resource limits
            const limits = monitoring?.resource_limits || {};
            document.getElementById('maxCpuPercent').value = limits.max_cpu_percent ?? 25;
            document.getElementById('maxMemoryMb').value = limits.max_memory_mb ?? 512;
            document.getElementById('maxExecutionTime').value = limits.max_execution_time_seconds ?? 300;
            document.getElementById('niceLevel').value = limits.nice_level ?? 10;
        },
        
        async loadStatus() {
            try {
                const response = await fetch('/api/v1/admin/ai/monitoring/status');
                if (!response.ok) throw new Error('Failed to load status');
                
                const status = await response.json();
                this.updateStatusUI(status);
                
                // Load alerts
                await this.loadAlerts();
                
            } catch (error) {
                console.error('AI monitoring status error:', error);
            }
        },
        
        updateStatusUI(status) {
            const statusIcon = document.getElementById('monitoringStatusIcon');
            const runningText = document.getElementById('monitoringRunning');
            
            if (status.running) {
                statusIcon.innerHTML = '<span class="status-indicator status-connected"></span>';
                runningText.textContent = 'Running';
                runningText.className = 'text-success';
            } else {
                statusIcon.innerHTML = '<span class="status-indicator status-disconnected"></span>';
                runningText.textContent = status.enabled ? 'Stopped' : 'Disabled';
                runningText.className = status.enabled ? 'text-warning' : 'text-muted';
            }
            
            document.getElementById('totalAlerts').textContent = status.total_alerts || 0;
            document.getElementById('lastRunTime').textContent = status.last_run 
                ? new Date(status.last_run).toLocaleString() 
                : 'Never';
        },
        
        async loadAlerts() {
            try {
                const response = await fetch('/api/v1/admin/ai/monitoring/alerts?hours=48');
                if (!response.ok) return;
                
                const alerts = await response.json();
                this.renderAlerts(alerts);
                
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        },
        
        renderAlerts(alerts) {
            const container = document.getElementById('driftAlertsContainer');
            if (!container) return;
            
            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No recent alerts</p>';
                return;
            }
            
            const severityColors = {
                'critical': 'danger',
                'error': 'danger',
                'warning': 'warning',
                'info': 'info'
            };
            
            const driftIcons = {
                'data': 'fa-database',
                'prediction': 'fa-robot',
                'target': 'fa-bullseye',
                'concept': 'fa-exchange-alt'
            };
            
            container.innerHTML = alerts.slice(0, 5).map(alert => `
                <div class="alert alert-${severityColors[alert.severity] || 'secondary'} py-2 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <i class="fas ${driftIcons[alert.drift_type] || 'fa-exclamation'} me-2"></i>
                            <strong>${alert.drift_type.charAt(0).toUpperCase() + alert.drift_type.slice(1)} Drift</strong>
                            <span class="badge bg-${severityColors[alert.severity]}">${alert.severity}</span>
                        </div>
                        <small class="text-muted">${new Date(alert.timestamp).toLocaleString()}</small>
                    </div>
                    <small class="d-block mt-1">${alert.message}</small>
                    <small class="text-muted">Value: ${alert.current_value.toFixed(3)} (threshold: ${alert.threshold})</small>
                </div>
            `).join('');
        },
        
        bindEvents() {
            // Save config button
            document.getElementById('saveAIConfig')?.addEventListener('click', () => this.saveConfig());
            
            // Refresh status button
            document.getElementById('refreshMonitoringStatus')?.addEventListener('click', () => this.loadStatus());
            
            // Run now button
            document.getElementById('runMonitoringNow')?.addEventListener('click', () => this.runMonitoring());
            
            // View reports button
            document.getElementById('viewMonitoringReports')?.addEventListener('click', () => this.viewReports());
        },
        
        async saveConfig() {
            try {
                const config = this.collectConfigFromUI();
                
                const response = await fetch('/api/v1/admin/ai/config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                if (!response.ok) throw new Error('Failed to save config');
                
                const result = await response.json();
                this.config = result;
                
                showToast('AI configuration saved successfully', 'success');
                
            } catch (error) {
                console.error('Save config error:', error);
                showToast('Failed to save configuration: ' + error.message, 'error');
            }
        },
        
        collectConfigFromUI() {
            return {
                specialists: {
                    enabled: document.getElementById('specialistsEnabled').checked,
                    execution_mode: document.getElementById('executionMode').value,
                    timeout_seconds: parseInt(document.getElementById('teamTimeout').value),
                    parallel_execution: document.getElementById('parallelExecution').checked,
                    fallback_to_general: document.getElementById('fallbackGeneral').checked,
                    orchestrator_model: 'gpt-4o',
                    synthesizer_model: 'gpt-4o',
                    max_parallel_specialists: 4,
                    job_analyst: {
                        enabled: document.getElementById('jobAnalystEnabled').checked,
                        model_name: document.getElementById('jobAnalystModel').value,
                        temperature: parseFloat(document.getElementById('jobAnalystTemp').value),
                        timeout_seconds: parseInt(document.getElementById('jobAnalystTimeout').value),
                        max_tokens: 2048,
                        retry_attempts: 3
                    },
                    dependency_specialist: {
                        enabled: document.getElementById('dependencyEnabled').checked,
                        model_name: document.getElementById('dependencyModel').value,
                        temperature: parseFloat(document.getElementById('dependencyTemp').value),
                        timeout_seconds: parseInt(document.getElementById('dependencyTimeout').value),
                        max_tokens: 2048,
                        retry_attempts: 3
                    },
                    resource_specialist: {
                        enabled: document.getElementById('resourceEnabled').checked,
                        model_name: document.getElementById('resourceModel').value,
                        temperature: parseFloat(document.getElementById('resourceTemp').value),
                        timeout_seconds: parseInt(document.getElementById('resourceTimeout').value),
                        max_tokens: 1536,
                        retry_attempts: 3
                    },
                    knowledge_specialist: {
                        enabled: document.getElementById('knowledgeEnabled').checked,
                        model_name: document.getElementById('knowledgeModel').value,
                        temperature: parseFloat(document.getElementById('knowledgeTemp').value),
                        timeout_seconds: parseInt(document.getElementById('knowledgeTimeout').value),
                        max_tokens: 3072,
                        retry_attempts: 3
                    }
                },
                monitoring: {
                    enabled: document.getElementById('monitoringEnabled').checked,
                    schedule: {
                        type: document.getElementById('monitoringSchedule').value,
                        time: document.getElementById('monitoringTime').value,
                        day_of_week: null
                    },
                    drift_detection: {
                        data_drift_enabled: document.getElementById('dataDriftEnabled').checked,
                        prediction_drift_enabled: document.getElementById('predictionDriftEnabled').checked,
                        target_drift_enabled: document.getElementById('targetDriftEnabled').checked,
                        drift_threshold: parseFloat(document.getElementById('driftThreshold').value),
                        alert_threshold: parseFloat(document.getElementById('alertThreshold').value),
                        reference_window_days: parseInt(document.getElementById('referenceWindow').value),
                        current_window_hours: parseInt(document.getElementById('currentWindow').value)
                    },
                    resource_limits: {
                        max_cpu_percent: parseFloat(document.getElementById('maxCpuPercent').value),
                        max_memory_mb: parseInt(document.getElementById('maxMemoryMb').value),
                        max_execution_time_seconds: parseInt(document.getElementById('maxExecutionTime').value),
                        nice_level: parseInt(document.getElementById('niceLevel').value)
                    },
                    reports_path: 'data/evidently_reports',
                    max_reports_stored: 30
                }
            };
        },
        
        async runMonitoring() {
            if (!confirm('Run monitoring check now? This may take a few minutes.')) return;
            
            const btn = document.getElementById('runMonitoringNow');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Running...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/v1/admin/ai/monitoring/run', {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error('Failed to run monitoring');
                
                const result = await response.json();
                
                showToast(`Monitoring completed in ${result.duration_seconds.toFixed(1)}s`, 'success');
                await this.loadStatus();
                
            } catch (error) {
                console.error('Run monitoring error:', error);
                showToast('Failed to run monitoring: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        },
        
        async viewReports() {
            try {
                const response = await fetch('/api/v1/admin/ai/monitoring/reports?limit=10');
                if (!response.ok) throw new Error('Failed to load reports');
                
                const data = await response.json();
                
                if (data.reports.length === 0) {
                    alert('No reports available yet. Run monitoring first.');
                    return;
                }
                
                // Show reports in a simple modal/alert
                const reportsList = data.reports.map(r => 
                    `• ${r.name} (${r.size_kb.toFixed(1)} KB) - ${new Date(r.created).toLocaleString()}`
                ).join('\n');
                
                alert(`📊 Available Reports (${data.total_reports} total)\n\nPath: ${data.reports_path}\n\n${reportsList}`);
                
            } catch (error) {
                console.error('View reports error:', error);
                showToast('Failed to load reports: ' + error.message, 'error');
            }
        }
    };
    
    // Initialize when AI Monitoring section is shown
    document.querySelector('[data-target="ai-monitoring"]')?.addEventListener('click', () => {
        setTimeout(() => AIMonitoring.init(), 100);
    });

    // =========================================================================
    // Threshold Tuning Module
    // =========================================================================
    const ThresholdTuning = {
        modes: ['off', 'low', 'mid', 'high'],
        modeInfo: {
            off: { title: 'Disabled', description: 'Static thresholds. No metrics collection.', color: 'secondary' },
            low: { title: 'Low (Metrics Only)', description: 'Collect metrics. Generate recommendations for manual approval.', color: 'info' },
            mid: { title: 'Mid (Conservative)', description: 'Auto-adjust with tight bounds (±5%), 24h intervals.', color: 'warning' },
            high: { title: 'High (Aggressive)', description: 'Auto-adjust with wide bounds (±10%), 12h intervals.', color: 'success' }
        },
        currentMode: 'off',
        originalMode: 'off',
        
        async init() {
            console.log('Initializing Threshold Tuning module');
            
            // Setup slider events
            const slider = document.getElementById('tuningLevelSlider');
            if (slider) {
                slider.addEventListener('input', (e) => this.updateModeDisplay(parseInt(e.target.value)));
                slider.addEventListener('change', () => {
                    const newMode = this.modes[slider.value];
                    document.getElementById('applyTuningLevel').disabled = (newMode === this.originalMode);
                });
            }
            
            // Setup button events
            document.getElementById('applyTuningLevel')?.addEventListener('click', () => this.applyMode());
            document.getElementById('resetThresholdsBtn')?.addEventListener('click', () => this.resetToDefaults());
            document.getElementById('rollbackThresholdsBtn')?.addEventListener('click', () => this.rollbackThresholds());
            document.getElementById('refreshThresholdTuning')?.addEventListener('click', () => this.loadStatus());
            document.getElementById('resetCircuitBreakerBtn')?.addEventListener('click', () => this.resetCircuitBreaker());
            document.getElementById('generateRecommendationsBtn')?.addEventListener('click', () => this.generateRecommendations());
            
            // Load initial status
            await this.loadStatus();
        },
        
        async loadStatus() {
            try {
                const response = await fetch('/api/v1/admin/threshold-tuning/status');
                const data = await response.json();
                
                if (data.status === 'success') {
                    this.updateUI(data.data);
                }
            } catch (error) {
                console.error('Failed to load threshold tuning status:', error);
            }
        },
        
        updateUI(status) {
            // Update mode slider
            const modeIndex = this.modes.indexOf(status.mode);
            const slider = document.getElementById('tuningLevelSlider');
            if (slider && modeIndex >= 0) {
                slider.value = modeIndex;
                this.currentMode = status.mode;
                this.originalMode = status.mode;
                this.updateModeDisplay(modeIndex);
            }
            
            // Update nav badge
            const badge = document.getElementById('tuningLevelBadge');
            if (badge) {
                badge.textContent = status.mode.toUpperCase();
                badge.className = `badge bg-${this.modeInfo[status.mode].color}`;
            }
            
            // Update circuit breaker alert
            const cbAlert = document.getElementById('circuitBreakerAlert');
            if (cbAlert) {
                cbAlert.classList.toggle('d-none', !status.circuit_breaker_active);
            }
            
            // Update metrics
            if (status.metrics) {
                this.updateMetrics(status.metrics);
            }
            
            // Update thresholds table
            if (status.thresholds) {
                this.updateThresholdsTable(status.thresholds);
            }
            
            // Update recommendations
            const recsCard = document.getElementById('recommendationsCard');
            if (recsCard && status.mode !== 'off') {
                recsCard.style.display = 'block';
                this.updateRecommendations(status.pending_recommendations || []);
            } else if (recsCard) {
                recsCard.style.display = 'none';
            }
            
            // Update audit log
            if (status.recent_audit_log) {
                this.updateAuditLog(status.recent_audit_log);
            }
            
            document.getElementById('applyTuningLevel').disabled = true;
        },
        
        updateModeDisplay(modeIndex) {
            const mode = this.modes[modeIndex];
            const info = this.modeInfo[mode];
            
            const levelInfo = document.getElementById('tuningLevelInfo');
            if (levelInfo) {
                levelInfo.className = `alert alert-${info.color} mb-0`;
            }
            
            document.getElementById('levelTitle').textContent = info.title;
            document.getElementById('levelDescription').textContent = info.description;
            
            // Highlight active slider label
            document.querySelectorAll('.slider-label').forEach((label, idx) => {
                label.classList.toggle('opacity-50', idx !== modeIndex);
            });
        },
        
        updateMetrics(metrics) {
            document.getElementById('metricReviewRate').textContent = (metrics.review_rate || 0).toFixed(1) + '%';
            document.getElementById('metricFPRate').textContent = (metrics.false_positive_rate || 0).toFixed(1) + '%';
            document.getElementById('metricFNRate').textContent = (metrics.false_negative_rate || 0).toFixed(1) + '%';
            document.getElementById('metricF1Score').textContent = (metrics.f1_score || 0).toFixed(1) + '%';
            document.getElementById('metricPrecision').textContent = (metrics.precision || 0).toFixed(1) + '%';
            document.getElementById('metricRecall').textContent = (metrics.recall || 0).toFixed(1) + '%';
            document.getElementById('precisionBar').style.width = (metrics.precision || 0) + '%';
            document.getElementById('recallBar').style.width = (metrics.recall || 0) + '%';
        },
        
        updateThresholdsTable(thresholds) {
            const tbody = document.getElementById('thresholdsTable');
            if (!tbody) return;
            
            const rows = Object.entries(thresholds).map(([name, config]) => `
                <tr>
                    <td><strong>${config.display_name}</strong><br><small class="text-muted">${config.description}</small></td>
                    <td><span class="badge bg-primary">${config.current_value.toFixed(2)}</span></td>
                    <td>${config.min_value.toFixed(2)}</td>
                    <td>${config.max_value.toFixed(2)}</td>
                    <td>${config.default_value.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="ThresholdTuning.editThreshold('${name}', ${config.current_value})">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            tbody.innerHTML = rows || '<tr><td colspan="6" class="text-center text-muted">No thresholds configured</td></tr>';
        },
        
        updateRecommendations(recommendations) {
            const container = document.getElementById('recommendationsList');
            if (!container) return;
            
            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = '<p class="text-center text-muted mb-0">No pending recommendations</p>';
                return;
            }
            
            container.innerHTML = recommendations.map(rec => `
                <div class="border rounded p-3 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${rec.threshold_name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h6>
                            <p class="mb-1 text-muted small">${rec.reason}</p>
                            <div class="d-flex gap-2 align-items-center">
                                <span class="badge bg-secondary">${rec.current_value.toFixed(2)}</span>
                                <i class="fas fa-arrow-right text-muted"></i>
                                <span class="badge bg-primary">${rec.recommended_value.toFixed(2)}</span>
                                <span class="badge bg-info">${rec.confidence}% confidence</span>
                            </div>
                            <small class="text-success"><i class="fas fa-chart-line me-1"></i>${rec.expected_impact}</small>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success" onclick="ThresholdTuning.approveRecommendation(${rec.id})">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="ThresholdTuning.rejectRecommendation(${rec.id})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        },
        
        updateAuditLog(logs) {
            const tbody = document.getElementById('auditLogTable');
            if (!tbody) return;
            
            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No changes recorded</td></tr>';
                return;
            }
            
            const actionIcons = {
                'manual_change': 'fa-user-edit text-primary',
                'auto_adjust': 'fa-robot text-warning',
                'recommendation_applied': 'fa-lightbulb text-success',
                'rollback': 'fa-undo text-danger',
                'reset_to_default': 'fa-sync text-info',
                'mode_change': 'fa-sliders-h text-secondary',
                'circuit_breaker_activated': 'fa-exclamation-triangle text-danger',
                'circuit_breaker_reset': 'fa-check-circle text-success',
                'manual_rollback': 'fa-history text-warning'
            };
            
            tbody.innerHTML = logs.map(log => {
                const icon = actionIcons[log.action] || 'fa-info-circle text-muted';
                const timestamp = new Date(log.timestamp).toLocaleString();
                const change = log.threshold_name === '*' ? '-' : `${log.old_value.toFixed(2)} → ${log.new_value.toFixed(2)}`;
                
                return `
                    <tr>
                        <td class="small">${timestamp}</td>
                        <td><i class="fas ${icon} me-1"></i>${log.action.replace(/_/g, ' ')}</td>
                        <td>${log.threshold_name === '*' ? 'All' : log.threshold_name.replace(/_/g, ' ')}</td>
                        <td>${change}</td>
                        <td>${log.performed_by}</td>
                        <td class="small text-muted">${log.reason.substring(0, 40)}${log.reason.length > 40 ? '...' : ''}</td>
                    </tr>
                `;
            }).join('');
        },
        
        async applyMode() {
            const slider = document.getElementById('tuningLevelSlider');
            const mode = this.modes[slider.value];
            
            try {
                const response = await fetch('/api/v1/admin/threshold-tuning/mode', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode, admin_user: 'admin' })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showToast(`Mode changed to ${mode.toUpperCase()}`, 'success');
                    this.originalMode = mode;
                    document.getElementById('applyTuningLevel').disabled = true;
                    await this.loadStatus();
                } else {
                    showToast(data.message || 'Failed to change mode', 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        },
        
        async resetToDefaults() {
            if (!confirm('Reset all thresholds to default values?')) return;
            
            try {
                const response = await fetch('/api/v1/admin/threshold-tuning/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ admin_user: 'admin' })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showToast('Thresholds reset to defaults', 'success');
                    await this.loadStatus();
                } else {
                    showToast(data.message || 'Failed to reset', 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        },
        
        async rollbackThresholds() {
            if (!confirm('Rollback to last known good thresholds?')) return;
            
            try {
                const response = await fetch('/api/v1/admin/threshold-tuning/rollback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ admin_user: 'admin' })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showToast('Thresholds rolled back', 'success');
                    await this.loadStatus();
                } else {
                    showToast(data.message || 'Failed to rollback', 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        },
        
        async resetCircuitBreaker() {
            if (!confirm('Reset circuit breaker and establish new baseline?')) return;
            
            try {
                const response = await fetch('/api/v1/admin/threshold-tuning/circuit-breaker/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ admin_user: 'admin' })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showToast('Circuit breaker reset', 'success');
                    await this.loadStatus();
                } else {
                    showToast(data.message || 'Failed to reset circuit breaker', 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        },
        
        async generateRecommendations() {
            try {
                const response = await fetch('/api/v1/admin/threshold-tuning/recommendations/generate', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showToast(`Generated ${data.generated} recommendations`, 'success');
                    await this.loadStatus();
                } else {
                    showToast(data.message || 'Failed to generate', 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        },
        
        async approveRecommendation(id) {
            if (!confirm('Apply this recommendation?')) return;
            
            try {
                const response = await fetch(`/api/v1/admin/threshold-tuning/recommendations/${id}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ admin_user: 'admin' })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showToast('Recommendation applied', 'success');
                    await this.loadStatus();
                } else {
                    showToast(data.message || 'Failed to apply', 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        },
        
        async rejectRecommendation(id) {
            if (!confirm('Reject this recommendation?')) return;
            
            try {
                const response = await fetch(`/api/v1/admin/threshold-tuning/recommendations/${id}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ admin_user: 'admin', reason: 'Rejected by admin' })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showToast('Recommendation rejected', 'success');
                    await this.loadStatus();
                } else {
                    showToast(data.message || 'Failed to reject', 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        },
        
        editThreshold(name, currentValue) {
            const newValue = prompt(`Enter new value for ${name.replace(/_/g, ' ')}:`, currentValue);
            if (newValue === null) return;
            
            const value = parseFloat(newValue);
            if (isNaN(value)) {
                showToast('Invalid value', 'error');
                return;
            }
            
            this.setThreshold(name, value);
        },
        
        async setThreshold(name, value) {
            try {
                const response = await fetch(`/api/v1/admin/threshold-tuning/thresholds/${name}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value, admin_user: 'admin', reason: 'Manual adjustment' })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showToast(`Threshold ${name} updated`, 'success');
                    await this.loadStatus();
                } else {
                    showToast(data.message || 'Failed to update', 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }
    };
    
    // Initialize when Threshold Tuning section is shown
    document.querySelector('[data-target="threshold-tuning"]')?.addEventListener('click', () => {
        setTimeout(() => ThresholdTuning.init(), 100);
    });
    
    // ==========================================
    // AI MONITORING CONFIGURATION
    // ==========================================
    const AIMonitoring = {
        initialized: false,
        
        async init() {
            if (this.initialized) {
                await this.loadConfig();
                await this.loadStatus();
                return;
            }
            
            this.initialized = true;
            await this.loadConfig();
            await this.loadStatus();
            this.bindEvents();
        },
        
        bindEvents() {
            // Save configuration
            document.getElementById('saveAIConfig')?.addEventListener('click', () => this.saveConfig());
            
            // Refresh status
            document.getElementById('refreshMonitoringStatus')?.addEventListener('click', () => this.loadStatus());
            
            // Run monitoring now
            document.getElementById('runMonitoringNow')?.addEventListener('click', () => this.runNow());
            
            // View reports
            document.getElementById('viewMonitoringReports')?.addEventListener('click', () => this.viewReports());
            
            // Toggle specialist configs visibility
            ['jobAnalystEnabled', 'dependencyEnabled', 'resourceEnabled', 'knowledgeEnabled'].forEach(id => {
                document.getElementById(id)?.addEventListener('change', (e) => {
                    const configId = id.replace('Enabled', 'Config');
                    const config = document.getElementById(configId);
                    if (config) {
                        config.classList.toggle('show', e.target.checked);
                    }
                });
            });
        },
        
        async loadConfig() {
            try {
                const response = await fetch('/api/v1/admin/ai/config');
                if (!response.ok) throw new Error('Failed to load config');
                
                const config = await response.json();
                this.populateForm(config);
            } catch (error) {
                console.error('Error loading AI config:', error);
                // Use defaults if API fails
            }
        },
        
        populateForm(config) {
            const specialists = config.specialists || {};
            const monitoring = config.monitoring || {};
            
            // Team settings
            document.getElementById('specialistsEnabled').checked = specialists.enabled ?? true;
            document.getElementById('executionMode').value = specialists.execution_mode || 'coordinate';
            document.getElementById('teamTimeout').value = specialists.timeout_seconds || 45;
            document.getElementById('parallelExecution').checked = specialists.parallel_execution ?? true;
            document.getElementById('fallbackGeneral').checked = specialists.fallback_to_general ?? true;
            
            // Job Analyst
            const jobAnalyst = specialists.job_analyst || {};
            document.getElementById('jobAnalystEnabled').checked = jobAnalyst.enabled ?? true;
            document.getElementById('jobAnalystModel').value = jobAnalyst.model_name || 'gpt-4o';
            document.getElementById('jobAnalystTemp').value = jobAnalyst.temperature ?? 0.2;
            document.getElementById('jobAnalystTimeout').value = jobAnalyst.timeout_seconds || 30;
            
            // Dependency
            const dependency = specialists.dependency_specialist || {};
            document.getElementById('dependencyEnabled').checked = dependency.enabled ?? true;
            document.getElementById('dependencyModel').value = dependency.model_name || 'gpt-4o';
            document.getElementById('dependencyTemp').value = dependency.temperature ?? 0.1;
            document.getElementById('dependencyTimeout').value = dependency.timeout_seconds || 30;
            
            // Resource
            const resource = specialists.resource_specialist || {};
            document.getElementById('resourceEnabled').checked = resource.enabled ?? true;
            document.getElementById('resourceModel').value = resource.model_name || 'gpt-4o';
            document.getElementById('resourceTemp').value = resource.temperature ?? 0.2;
            document.getElementById('resourceTimeout').value = resource.timeout_seconds || 25;
            
            // Knowledge
            const knowledge = specialists.knowledge_specialist || {};
            document.getElementById('knowledgeEnabled').checked = knowledge.enabled ?? true;
            document.getElementById('knowledgeModel').value = knowledge.model_name || 'gpt-4o';
            document.getElementById('knowledgeTemp').value = knowledge.temperature ?? 0.4;
            document.getElementById('knowledgeTimeout').value = knowledge.timeout_seconds || 35;
            
            // Monitoring settings
            document.getElementById('monitoringEnabled').checked = monitoring.enabled ?? true;
            
            const schedule = monitoring.schedule || {};
            document.getElementById('monitoringSchedule').value = schedule.type || 'daily';
            document.getElementById('monitoringTime').value = schedule.time || '03:00';
            
            const drift = monitoring.drift_detection || {};
            document.getElementById('dataDriftEnabled').checked = drift.data_drift_enabled ?? true;
            document.getElementById('predictionDriftEnabled').checked = drift.prediction_drift_enabled ?? true;
            document.getElementById('targetDriftEnabled').checked = drift.target_drift_enabled ?? true;
            document.getElementById('driftThreshold').value = drift.drift_threshold ?? 0.15;
            document.getElementById('alertThreshold').value = drift.alert_threshold ?? 0.25;
            document.getElementById('referenceWindow').value = drift.reference_window_days ?? 7;
            document.getElementById('currentWindow').value = drift.current_window_hours ?? 24;
            
            const limits = monitoring.resource_limits || {};
            document.getElementById('maxCpuPercent').value = limits.max_cpu_percent ?? 25;
            document.getElementById('maxMemoryMb').value = limits.max_memory_mb ?? 512;
            document.getElementById('maxExecutionTime').value = limits.max_execution_time_seconds ?? 300;
            document.getElementById('niceLevel').value = limits.nice_level ?? 10;
            
            // Update badge
            const enabledCount = [
                document.getElementById('jobAnalystEnabled').checked,
                document.getElementById('dependencyEnabled').checked,
                document.getElementById('resourceEnabled').checked,
                document.getElementById('knowledgeEnabled').checked
            ].filter(Boolean).length;
            document.getElementById('aiSpecialistsBadge').textContent = enabledCount;
        },
        
        async saveConfig() {
            const config = {
                specialists: {
                    enabled: document.getElementById('specialistsEnabled').checked,
                    execution_mode: document.getElementById('executionMode').value,
                    timeout_seconds: parseInt(document.getElementById('teamTimeout').value),
                    parallel_execution: document.getElementById('parallelExecution').checked,
                    fallback_to_general: document.getElementById('fallbackGeneral').checked,
                    orchestrator_model: 'gpt-4o',
                    synthesizer_model: 'gpt-4o',
                    job_analyst: {
                        enabled: document.getElementById('jobAnalystEnabled').checked,
                        model_name: document.getElementById('jobAnalystModel').value,
                        temperature: parseFloat(document.getElementById('jobAnalystTemp').value),
                        timeout_seconds: parseInt(document.getElementById('jobAnalystTimeout').value),
                        max_tokens: 2048,
                        retry_attempts: 3
                    },
                    dependency_specialist: {
                        enabled: document.getElementById('dependencyEnabled').checked,
                        model_name: document.getElementById('dependencyModel').value,
                        temperature: parseFloat(document.getElementById('dependencyTemp').value),
                        timeout_seconds: parseInt(document.getElementById('dependencyTimeout').value),
                        max_tokens: 2048,
                        retry_attempts: 3
                    },
                    resource_specialist: {
                        enabled: document.getElementById('resourceEnabled').checked,
                        model_name: document.getElementById('resourceModel').value,
                        temperature: parseFloat(document.getElementById('resourceTemp').value),
                        timeout_seconds: parseInt(document.getElementById('resourceTimeout').value),
                        max_tokens: 1536,
                        retry_attempts: 3
                    },
                    knowledge_specialist: {
                        enabled: document.getElementById('knowledgeEnabled').checked,
                        model_name: document.getElementById('knowledgeModel').value,
                        temperature: parseFloat(document.getElementById('knowledgeTemp').value),
                        timeout_seconds: parseInt(document.getElementById('knowledgeTimeout').value),
                        max_tokens: 3072,
                        retry_attempts: 3
                    }
                },
                monitoring: {
                    enabled: document.getElementById('monitoringEnabled').checked,
                    schedule: {
                        type: document.getElementById('monitoringSchedule').value,
                        time: document.getElementById('monitoringTime').value
                    },
                    drift_detection: {
                        data_drift_enabled: document.getElementById('dataDriftEnabled').checked,
                        prediction_drift_enabled: document.getElementById('predictionDriftEnabled').checked,
                        target_drift_enabled: document.getElementById('targetDriftEnabled').checked,
                        drift_threshold: parseFloat(document.getElementById('driftThreshold').value),
                        alert_threshold: parseFloat(document.getElementById('alertThreshold').value),
                        reference_window_days: parseInt(document.getElementById('referenceWindow').value),
                        current_window_hours: parseInt(document.getElementById('currentWindow').value)
                    },
                    resource_limits: {
                        max_cpu_percent: parseFloat(document.getElementById('maxCpuPercent').value),
                        max_memory_mb: parseInt(document.getElementById('maxMemoryMb').value),
                        max_execution_time_seconds: parseInt(document.getElementById('maxExecutionTime').value),
                        nice_level: parseInt(document.getElementById('niceLevel').value)
                    },
                    reports_path: 'data/evidently_reports',
                    max_reports_stored: 30
                }
            };
            
            try {
                const response = await fetch('/api/v1/admin/ai/config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                if (!response.ok) throw new Error('Failed to save config');
                
                showToast('AI configuration saved successfully', 'success');
                
                // Update badge
                const enabledCount = [
                    config.specialists.job_analyst.enabled,
                    config.specialists.dependency_specialist.enabled,
                    config.specialists.resource_specialist.enabled,
                    config.specialists.knowledge_specialist.enabled
                ].filter(Boolean).length;
                document.getElementById('aiSpecialistsBadge').textContent = enabledCount;
                
            } catch (error) {
                showToast('Error saving AI config: ' + error.message, 'error');
            }
        },
        
        async loadStatus() {
            try {
                const response = await fetch('/api/v1/admin/ai/monitoring/status');
                if (!response.ok) throw new Error('Failed to load status');
                
                const status = await response.json();
                
                // Update status display
                const statusIcon = document.getElementById('monitoringStatusIcon');
                const statusText = document.getElementById('monitoringRunning');
                
                if (status.running) {
                    statusIcon.innerHTML = '<span class="status-indicator status-connected"></span>';
                    statusText.textContent = 'Running';
                    statusText.className = 'text-success';
                } else {
                    statusIcon.innerHTML = '<span class="status-indicator status-disconnected"></span>';
                    statusText.textContent = status.enabled ? 'Idle' : 'Disabled';
                    statusText.className = status.enabled ? 'text-warning' : 'text-muted';
                }
                
                document.getElementById('totalAlerts').textContent = status.total_alerts || 0;
                document.getElementById('lastRunTime').textContent = status.last_run 
                    ? new Date(status.last_run).toLocaleString() 
                    : 'Never';
                
                // Load alerts
                await this.loadAlerts();
                
            } catch (error) {
                console.error('Error loading monitoring status:', error);
            }
        },
        
        async loadAlerts() {
            try {
                const response = await fetch('/api/v1/admin/ai/monitoring/alerts?hours=72');
                if (!response.ok) return;
                
                const alerts = await response.json();
                const container = document.getElementById('driftAlertsContainer');
                
                if (!alerts || alerts.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center">No recent alerts</p>';
                    return;
                }
                
                container.innerHTML = alerts.slice(0, 5).map(alert => `
                    <div class="alert alert-${this.getSeverityClass(alert.severity)} py-2 mb-2">
                        <div class="d-flex justify-content-between">
                            <strong>${alert.drift_type.toUpperCase()} Drift</strong>
                            <small>${new Date(alert.timestamp).toLocaleString()}</small>
                        </div>
                        <small>${alert.message}</small>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        },
        
        getSeverityClass(severity) {
            const classes = {
                'info': 'info',
                'warning': 'warning',
                'error': 'danger',
                'critical': 'danger'
            };
            return classes[severity] || 'secondary';
        },
        
        async runNow() {
            if (!confirm('Run AI monitoring now? This may take a few minutes.')) return;
            
            showToast('Starting monitoring run...', 'info');
            
            try {
                const response = await fetch('/api/v1/admin/ai/monitoring/run', {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error('Monitoring run failed');
                
                const result = await response.json();
                
                if (result.error) {
                    showToast('Monitoring error: ' + result.error, 'error');
                } else {
                    const alertCount = (result.alerts || []).length;
                    showToast(`Monitoring completed in ${result.duration_seconds.toFixed(1)}s. ${alertCount} alerts.`, 
                        alertCount > 0 ? 'warning' : 'success');
                }
                
                await this.loadStatus();
                
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        },
        
        async viewReports() {
            try {
                const response = await fetch('/api/v1/admin/ai/monitoring/reports?limit=10');
                if (!response.ok) throw new Error('Failed to load reports');
                
                const data = await response.json();
                
                if (!data.reports || data.reports.length === 0) {
                    showToast('No reports available yet', 'info');
                    return;
                }
                
                // Show reports in modal or alert
                const reportList = data.reports.map(r => 
                    `• ${r.name} (${r.size_kb.toFixed(1)} KB) - ${new Date(r.created).toLocaleString()}`
                ).join('\n');
                
                alert(`Available Reports (${data.total_reports} total):\n\n${reportList}\n\nReports are stored in: ${data.reports_path}`);
                
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }
    };
    
    // Initialize when AI Monitoring section is shown
    document.querySelector('[data-target="ai-monitoring"]')?.addEventListener('click', () => {
        setTimeout(() => AIMonitoring.init(), 100);
    });
    </script>
</body>
</html>