<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resync Admin Configuration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/admin-neumorphic.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
        }
        
        body {
            background-color: #f5f7fb;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .admin-header {
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .sidebar {
            background-color: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            height: calc(100vh - 70px);
            position: sticky;
            top: 70px;
        }
        
        .nav-link {
            color: var(--secondary-color);
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover, .nav-link.active {
            color: var(--primary-color);
            background-color: rgba(0,123,255,0.1);
            border-left: 3px solid var(--primary-color);
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #0069d9);
            border: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #218838);
            border: none;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected {
            background-color: var(--success-color);
        }
        
        .status-disconnected {
            background-color: var(--danger-color);
        }
        
        .status-warning {
            background-color: var(--warning-color);
        }
        
        .section-divider {
            border-top: 1px solid rgba(0,0,0,0.1);
            margin: 2rem 0;
        }
        
        .config-section {
            display: none;
        }
        
        .config-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            background-color: white;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .toast.success {
            border-left-color: var(--success-color);
        }
        
        .toast.error {
            border-left-color: var(--danger-color);
        }
        
        .toast.warning {
            border-left-color: var(--warning-color);
        }
        
        /* Health monitoring cards */
        .health-card {
            transition: all 0.3s ease;
            border-width: 2px;
        }
        
        .health-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .health-card .display-4 {
            font-size: 2.5rem;
            transition: color 0.3s ease;
        }
        
        .health-card .card-text {
            font-weight: 500;
            min-height: 24px;
        }
        
        .health-card small {
            display: block;
            margin-top: 0.25rem;
        }
        
        #healthOverallBanner {
            display: flex;
            align-items: center;
        }
        
        #healthOverallBanner strong {
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container"></div>
    
    <!-- Header -->
    <header class="admin-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1><i class="fas fa-cogs me-2"></i>Resync Administration</h1>
                    <p class="mb-0">System Configuration & Management Console</p>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group">
                        <button class="btn btn-outline-light" id="refreshBtn">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-outline-light" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar Navigation -->
            <div class="col-md-3 col-lg-2 sidebar">
                <nav class="nav flex-column pt-3">
                    <h6 class="px-3 text-muted">CONFIGURATION</h6>
                    <a class="nav-link active" href="#" data-target="teams-config">
                        <i class="fab fa-microsoft me-2"></i>Teams Integration
                    </a>
                    <a class="nav-link" href="#" data-target="tws-config">
                        <i class="fas fa-server me-2"></i>TWS Configuration
                        <span class="badge bg-info" style="margin-left:auto;" id="tws-sidebar-count">0</span>
                    </a>
                    <a class="nav-link" href="#" data-target="system-config">
                        <i class="fas fa-sliders-h me-2"></i>System Settings
                    </a>
                    <a class="nav-link" href="#" data-target="litellm-config">
                        <i class="fas fa-brain me-2"></i>LiteLLM & AI Models
                    </a>
                    
                    <h6 class="px-3 mt-4 text-muted">MONITORING</h6>
                    <a class="nav-link" href="#" data-target="health-monitoring">
                        <span class="badge badge-success" style="margin-left:auto;">OK</span>
                        <i class="fas fa-heartbeat me-2"></i>System Health
                    </a>
                    <a class="nav-link" href="#" data-target="proactive-monitoring">
                        <i class="fas fa-satellite-dish me-2"></i>TWS Proativo
                        <span class="badge badge-info" style="margin-left:auto;">LIVE</span>
                    </a>
                    <a class="nav-link" href="/tws-monitor" target="_blank">
                        <i class="fas fa-chart-line me-2"></i>Dashboard TWS <i class="fas fa-external-link-alt fa-xs"></i>
                    </a>
                    <a class="nav-link" href="#" data-target="notifications">
                        <i class="fas fa-bell me-2"></i>Notifications
                        <span class="badge badge-warning" style="margin-left:auto;">3</span>
                    </a>
                    <a class="nav-link" href="#" data-target="logs">
                        <i class="fas fa-file-alt me-2"></i>System Logs
                    </a>
                    
                    <h6 class="px-3 mt-4 text-muted">AI & LEARNING</h6>
                    <a class="nav-link" href="#" data-target="auto-tuning">
                        <i class="fas fa-sliders-h me-2"></i>Auto-Tuning
                        <span class="badge bg-secondary" id="autoTuningLevelBadge" style="margin-left:auto;">OFF</span>
                    </a>

                    <h6 class="px-3 mt-4 text-muted">TOOLS</h6>
                    <a class="nav-link" href="#" data-target="backup-restore">
                        <i class="fas fa-database me-2"></i>Backup & Restore
                    </a>
                    <a class="nav-link" href="#" data-target="observability">
                        <i class="fas fa-eye me-2"></i>Observability
                        <span class="badge bg-info" style="margin-left:auto;">AI</span>
                    </a>
                    <a class="nav-link" href="#" data-target="revisao-operador">
                        <i class="fas fa-clipboard-check me-2"></i>Revis√£o Operador
                        <span class="badge bg-warning" style="margin-left:auto;" id="revisao-pending-count">0</span>
                    </a>
                    <a class="nav-link" href="#" data-target="audit">
                        <i class="fas fa-scroll me-2"></i>Audit Log
                    </a>
                    <a class="nav-link" href="#" data-target="semantic-cache">
                        <i class="fas fa-brain me-2"></i>Semantic Cache
                        <span class="badge bg-success" style="margin-left:auto;">v5.3.16</span>
                    </a>
                    <a class="nav-link" href="#" data-target="maintenance">
                        <i class="fas fa-tools me-2"></i>Maintenance
                    </a>
                </nav>
            </div>
            
            <!-- Main Content Area -->
            <div class="col-md-9 col-lg-10">
                <!-- Teams Configuration Section -->
                <div id="teams-config" class="config-section active">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fab fa-microsoft me-2"></i>Microsoft Teams Integration</h2>
                        <button class="btn btn-success" id="saveTeamsConfig">
                            <i class="fas fa-save me-1"></i>Save Configuration
                        </button>
                    </div>
                    
                    <div class="row">
                        <div class="col-xl-8">
                            <!-- Basic Configuration Card -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Basic Configuration</h5>
                                </div>
                                <div class="card-body">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="teamsEnabled" checked>
                                        <label class="form-check-label" for="teamsEnabled">
                                            <strong>Enable Teams Integration</strong>
                                            <small class="d-block text-muted">Toggle to enable/disable Teams notifications</small>
                                        </label>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="webhookUrl" class="form-label">Teams Webhook URL</label>
                                        <input type="url" class="form-control" id="webhookUrl" 
                                               placeholder="https://yourcompany.webhook.office.com/webhook...">
                                        <div class="form-text">Incoming webhook URL for your Teams channel</div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="channelName" class="form-label">Channel Name</label>
                                                <input type="text" class="form-control" id="channelName" 
                                                       placeholder="Resync Notifications">
                                                <div class="form-text">Name of the Teams channel</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="botName" class="form-label">Bot Display Name</label>
                                                <input type="text" class="form-control" id="botName" 
                                                       value="Resync Bot">
                                                <div class="form-text">Name displayed in Teams notifications</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="avatarUrl" class="form-label">Bot Avatar URL</label>
                                        <input type="url" class="form-control" id="avatarUrl" 
                                               placeholder="https://example.com/avatar.png">
                                        <div class="form-text">URL to avatar image for the bot (optional)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Advanced Features Card -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-star me-2"></i>Advanced Features</h5>
                                </div>
                                <div class="card-body">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="conversationLearning" checked>
                                        <label class="form-check-label" for="conversationLearning">
                                            <strong>Enable Conversation Learning</strong>
                                            <small class="d-block text-muted">Allow bot to learn from Teams conversations</small>
                                        </label>
                                    </div>
                                    
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="jobNotifications" checked>
                                        <label class="form-check-label" for="jobNotifications">
                                            <strong>Enable Job Status Notifications</strong>
                                            <small class="d-block text-muted">Send notifications for job status changes</small>
                                        </label>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Monitored TWS Instances</label>
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" id="newInstanceInput" 
                                                   placeholder="Enter TWS instance name">
                                            <button class="btn btn-outline-secondary" type="button" id="addInstanceBtn">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                        <div id="instancesList" class="mt-2">
                                            <!-- Instances will be added here dynamically -->
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Job Status Filters</label>
                                        <select multiple class="form-select" id="jobStatusFilters" size="4">
                                            <option value="ABEND" selected>ABEND (Abnormal End)</option>
                                            <option value="ERROR" selected>Error</option>
                                            <option value="FAILED" selected>Failed</option>
                                            <option value="TIMEOUT">Timeout</option>
                                            <option value="CANCELLED">Cancelled</option>
                                            <option value="WARNING">Warning</option>
                                        </select>
                                        <div class="form-text">Select job statuses that trigger notifications</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Notification Types</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="job_status" 
                                                   id="notifyJobStatus" checked>
                                            <label class="form-check-label" for="notifyJobStatus">
                                                Job Status Changes
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="alerts" 
                                                   id="notifyAlerts" checked>
                                            <label class="form-check-label" for="notifyAlerts">
                                                System Alerts
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="performance" 
                                                   id="notifyPerformance" checked>
                                            <label class="form-check-label" for="notifyPerformance">
                                                Performance Issues
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-xl-4">
                            <!-- Health Status Card -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-heartbeat me-2"></i>Integration Status</h5>
                                </div>
                                <div class="card-body">
                                    <div class="text-center mb-3">
                                        <div class="status-indicator status-connected"></div>
                                        <span class="fw-bold">Connected</span>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Last Health Check</label>
                                        <div class="text-muted" id="lastHealthCheck">2 minutes ago</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Connection Status</label>
                                        <div class="text-success">
                                            <i class="fas fa-check-circle me-1"></i> Webhook Accessible
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Features Enabled</label>
                                        <ul class="list-unstyled small">
                                            <li><i class="fas fa-check text-success me-1"></i> Notifications</li>
                                            <li><i class="fas fa-check text-success me-1"></i> Learning</li>
                                            <li><i class="fas fa-times text-danger me-1"></i> Conversations</li>
                                        </ul>
                                    </div>
                                    
                                    <button class="btn btn-outline-primary w-100" id="testNotificationBtn">
                                        <i class="fas fa-paper-plane me-1"></i> Send Test Notification
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Quick Actions Card -->
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-info" id="refreshHealthBtn">
                                            <i class="fas fa-sync me-1"></i> Refresh Health Status
                                        </button>
                                        <button class="btn btn-outline-warning">
                                            <i class="fas fa-exclamation-triangle me-1"></i> View Recent Errors
                                        </button>
                                        <button class="btn btn-outline-secondary">
                                            <i class="fas fa-history me-1"></i> View Notification History
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- TWS Configuration Section (Hidden by default) -->
                <div id="tws-config" class="config-section">
                    <h2><i class="fas fa-server me-2"></i>TWS Configuration</h2>
                    <p class="text-muted">Configure connections to HCL Workload Automation instances</p>

                    <!-- Navigation Tabs -->
                    <ul class="nav nav-tabs mb-4" id="twsConfigTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tws-instances-tab" data-bs-toggle="tab" 
                                    data-bs-target="#tws-instances-content" type="button" role="tab">
                                <i class="fas fa-network-wired me-2"></i>Instances
                                <span class="badge bg-info ms-2" id="tws-instance-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tws-connection-tab" data-bs-toggle="tab" 
                                    data-bs-target="#tws-connection-content" type="button" role="tab">
                                <i class="fas fa-plug me-2"></i>Connection Settings
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tws-monitoring-tab" data-bs-toggle="tab" 
                                    data-bs-target="#tws-monitoring-content" type="button" role="tab">
                                <i class="fas fa-chart-line me-2"></i>Monitoring
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="twsConfigTabContent">
                        <!-- TWS Instances Tab -->
                        <div class="tab-pane fade show active" id="tws-instances-content" role="tabpanel">
                            <!-- Status Cards -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0" id="tws-total-instances">0</h3>
                                            <small class="text-muted">Total Instances</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-0 shadow-sm bg-success bg-opacity-10">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0 text-success" id="tws-connected-count">0</h3>
                                            <small class="text-muted">Connected</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-0 shadow-sm bg-warning bg-opacity-10">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0 text-warning" id="tws-pending-count">0</h3>
                                            <small class="text-muted">Connecting</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-0 shadow-sm bg-danger bg-opacity-10">
                                        <div class="card-body text-center">
                                            <h3 class="mb-0 text-danger" id="tws-error-count">0</h3>
                                            <small class="text-muted">Errors</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Actions Bar -->
                            <div class="card mb-4">
                                <div class="card-body d-flex justify-content-between align-items-center py-2">
                                    <div class="btn-group">
                                        <button class="btn btn-success btn-sm" onclick="TWSInstancesAdmin.connectAll()">
                                            <i class="fas fa-plug me-1"></i>Connect All
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm" onclick="TWSInstancesAdmin.disconnectAll()">
                                            <i class="fas fa-unlink me-1"></i>Disconnect All
                                        </button>
                                    </div>
                                    <div>
                                        <button class="btn btn-outline-secondary btn-sm me-2" onclick="TWSInstancesAdmin.refresh()">
                                            <i class="fas fa-sync-alt me-1"></i>Refresh
                                        </button>
                                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTWSInstanceModal">
                                            <i class="fas fa-plus me-1"></i>Add Instance
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Instances Table -->
                            <div class="card">
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 30px;"></th>
                                                    <th>Instance</th>
                                                    <th>Host</th>
                                                    <th>Environment</th>
                                                    <th>Status</th>
                                                    <th>Learning</th>
                                                    <th class="text-end">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tws-instances-table">
                                                <tr>
                                                    <td colspan="7" class="text-center py-4 text-muted">
                                                        <i class="fas fa-spinner fa-spin me-2"></i>Loading instances...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Connection Settings Tab -->
                        <div class="tab-pane fade" id="tws-connection-content" role="tabpanel">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Primary TWS Instance</label>
                                            <input type="text" id="primaryTwsInstance" class="form-control" placeholder="Primary instance name">
                                            <small class="text-muted">Main instance for operations</small>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Default Timeout (seconds)</label>
                                            <input type="number" id="twsDefaultTimeout" class="form-control" value="30" min="5" max="300">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Monitored TWS Instances</label>
                                        <div id="twsInstancesList" class="mb-2">
                                            <!-- Instances will be added here dynamically -->
                                        </div>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="newTwsInstanceInput" placeholder="Enter instance name">
                                            <button class="btn btn-outline-secondary" type="button" id="addTwsInstanceBtn">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="twsMockMode">
                                                <label class="form-check-label" for="twsMockMode">Mock Mode (Testing)</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="twsVerifySSL" checked>
                                                <label class="form-check-label" for="twsVerifySSL">Verify SSL</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="twsAutoReconnect" checked>
                                                <label class="form-check-label" for="twsAutoReconnect">Auto-Reconnect</label>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-success" id="saveTwsConfig">
                                        <i class="fas fa-save me-1"></i>Save Connection Settings
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Monitoring Tab -->
                        <div class="tab-pane fade" id="tws-monitoring-content" role="tabpanel">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Polling Interval (seconds)</label>
                                            <input type="number" id="twsPollingInterval" class="form-control" value="30" min="10" max="300">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Job Stuck Threshold (minutes)</label>
                                            <input type="number" id="twsStuckThreshold" class="form-control" value="30" min="5" max="120">
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Job Late Threshold (minutes)</label>
                                            <input type="number" id="twsLateThreshold" class="form-control" value="15" min="1" max="60">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Anomaly Failure Rate (%)</label>
                                            <input type="number" id="twsAnomalyThreshold" class="form-control" value="10" min="1" max="100" step="0.1">
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="twsPollingEnabled" checked>
                                                <label class="form-check-label" for="twsPollingEnabled">Enable Polling</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="twsPatternDetection" checked>
                                                <label class="form-check-label" for="twsPatternDetection">Pattern Detection</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="twsSolutionCorrelation" checked>
                                                <label class="form-check-label" for="twsSolutionCorrelation">Solution Correlation</label>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-success" id="saveTwsMonitoringConfig">
                                        <i class="fas fa-save me-1"></i>Save Monitoring Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add TWS Instance Modal -->
                <div class="modal fade" id="addTWSInstanceModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Add TWS Instance</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="addTWSInstanceForm">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Instance Name *</label>
                                            <input type="text" id="tws-new-name" class="form-control" placeholder="e.g., PROD1" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Display Name *</label>
                                            <input type="text" id="tws-new-display-name" class="form-control" placeholder="Production Server 1" required>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-8">
                                            <label class="form-label">Host *</label>
                                            <input type="text" id="tws-new-host" class="form-control" placeholder="tws-server.example.com" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Port</label>
                                            <input type="number" id="tws-new-port" class="form-control" value="31116">
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Username</label>
                                            <input type="text" id="tws-new-username" class="form-control">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Password</label>
                                            <input type="password" id="tws-new-password" class="form-control">
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Environment</label>
                                            <select id="tws-new-environment" class="form-select">
                                                <option value="production">Production</option>
                                                <option value="staging">Staging</option>
                                                <option value="development">Development</option>
                                                <option value="dr">DR</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Color</label>
                                            <input type="color" id="tws-new-color" class="form-control form-control-color" value="#3b82f6">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">&nbsp;</label>
                                            <div class="form-check mt-2">
                                                <input class="form-check-input" type="checkbox" id="tws-new-ssl" checked>
                                                <label class="form-check-label" for="tws-new-ssl">SSL Enabled</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="tws-new-learning" checked>
                                                <label class="form-check-label" for="tws-new-learning">Enable Learning</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea id="tws-new-description" class="form-control" rows="2"></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-secondary" onclick="TWSInstancesAdmin.testNewConnection()">
                                    <i class="fas fa-vial me-1"></i>Test Connection
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="TWSInstancesAdmin.addInstance()">
                                    <i class="fas fa-plus me-1"></i>Add Instance
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit TWS Instance Modal -->
                <div class="modal fade" id="editTWSInstanceModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit TWS Instance</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <input type="hidden" id="tws-edit-id">
                                <div class="mb-3">
                                    <label class="form-label">Instance Name</label>
                                    <input type="text" id="tws-edit-name" class="form-control" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Display Name</label>
                                    <input type="text" id="tws-edit-display-name" class="form-control">
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <label class="form-label">Host</label>
                                        <input type="text" id="tws-edit-host" class="form-control">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Port</label>
                                        <input type="number" id="tws-edit-port" class="form-control">
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Environment</label>
                                        <select id="tws-edit-environment" class="form-select">
                                            <option value="production">Production</option>
                                            <option value="staging">Staging</option>
                                            <option value="development">Development</option>
                                            <option value="dr">DR</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Color</label>
                                        <input type="color" id="tws-edit-color" class="form-control form-control-color">
                                    </div>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="tws-edit-enabled" checked>
                                    <label class="form-check-label" for="tws-edit-enabled">Instance Enabled</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="tws-edit-learning" checked>
                                    <label class="form-check-label" for="tws-edit-learning">Enable Learning</label>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="TWSInstancesAdmin.saveInstance()">
                                    <i class="fas fa-save me-1"></i>Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Proactive Monitoring Section (Hidden by default) -->
                <div id="proactive-monitoring" class="config-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2><i class="fas fa-satellite-dish me-2"></i>Monitoramento Proativo TWS</h2>
                            <p class="text-muted mb-0">Configure o background poller, WebSocket broadcast e notifica√ß√µes</p>
                        </div>
                        <div>
                            <a href="/tws-monitor" target="_blank" class="btn btn-primary me-2">
                                <i class="fas fa-external-link-alt me-1"></i>Abrir Dashboard
                            </a>
                            <button class="btn btn-success" id="saveProactiveConfig">
                                <i class="fas fa-save me-1"></i>Salvar
                            </button>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Background Poller Configuration -->
                        <div class="col-xl-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Background Poller</h5>
                                </div>
                                <div class="card-body">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="pollerEnabled" checked>
                                        <label class="form-check-label" for="pollerEnabled">
                                            <strong>Habilitar Polling Autom√°tico</strong>
                                            <small class="d-block text-muted">Coleta status do TWS automaticamente</small>
                                        </label>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="pollingInterval" class="form-label">
                                            Intervalo de Polling: <span id="pollingIntervalValue">30</span> segundos
                                        </label>
                                        <input type="range" class="form-range" id="pollingInterval" 
                                               min="5" max="300" step="5" value="30">
                                        <div class="d-flex justify-content-between">
                                            <small class="text-muted">5s (mais recursos)</small>
                                            <small class="text-muted">300s (menos recursos)</small>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Modo de Polling</label>
                                        <select class="form-select" id="pollingMode">
                                            <option value="fixed">Fixo (intervalo constante)</option>
                                            <option value="adaptive">Adaptativo (ajusta com carga)</option>
                                            <option value="scheduled">Agendado (hor√°rios espec√≠ficos)</option>
                                        </select>
                                    </div>
                                    
                                    <div id="scheduledPollingConfig" class="d-none">
                                        <div class="mb-3">
                                            <label class="form-label">Hor√°rio de Polling Intensivo</label>
                                            <input type="text" class="form-control" id="pollingSchedule" 
                                                   placeholder="06:00-22:00" value="06:00-22:00">
                                            <small class="text-muted">Fora deste hor√°rio, intervalo ser√° 5 minutos</small>
                                        </div>
                                    </div>
                                    
                                    <hr>
                                    
                                    <h6>Thresholds de Detec√ß√£o</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Job Travado (minutos)</label>
                                                <input type="number" class="form-control" id="jobStuckThreshold" 
                                                       min="10" max="240" value="60">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Job Atrasado (minutos)</label>
                                                <input type="number" class="form-control" id="jobLateThreshold" 
                                                       min="5" max="120" value="30">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Taxa de Falha para Anomalia (%)</label>
                                        <input type="number" class="form-control" id="anomalyThreshold" 
                                               min="5" max="50" value="10">
                                        <small class="text-muted">Alerta se taxa de falha exceder este valor</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- WebSocket & Notifications Configuration -->
                        <div class="col-xl-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-broadcast-tower me-2"></i>WebSocket Broadcast</h5>
                                </div>
                                <div class="card-body">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="websocketEnabled" checked>
                                        <label class="form-check-label" for="websocketEnabled">
                                            <strong>Habilitar WebSocket</strong>
                                            <small class="d-block text-muted">Push de eventos em tempo real</small>
                                        </label>
                                    </div>
                                    
                                    <h6>Filtros de Broadcast</h6>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="wsFilterJobs" checked>
                                            <label class="form-check-label" for="wsFilterJobs">Eventos de Jobs</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="wsFilterWs" checked>
                                            <label class="form-check-label" for="wsFilterWs">Eventos de Workstations</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="wsFilterSystem" checked>
                                            <label class="form-check-label" for="wsFilterSystem">Eventos de Sistema</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="wsFilterCritical" checked>
                                            <label class="form-check-label" for="wsFilterCritical">Apenas Cr√≠ticos</label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Severidade M√≠nima</label>
                                        <select class="form-select" id="wsMinSeverity">
                                            <option value="info">Info (todos)</option>
                                            <option value="warning">Warning</option>
                                            <option value="error" selected>Error</option>
                                            <option value="critical">Critical</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Filtrar Jobs (regex)</label>
                                        <input type="text" class="form-control" id="wsJobFilter" 
                                               placeholder=".*BATCH.*|.*CRITICAL.*">
                                        <small class="text-muted">Deixe vazio para todos os jobs</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-bell me-2"></i>Web Push Notifications</h5>
                                </div>
                                <div class="card-body">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="webpushEnabled" checked>
                                        <label class="form-check-label" for="webpushEnabled">
                                            <strong>Habilitar Notifica√ß√µes Browser</strong>
                                            <small class="d-block text-muted">Push notifications para eventos cr√≠ticos</small>
                                        </label>
                                    </div>
                                    
                                    <h6>Notificar quando:</h6>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="notifyAbend" checked>
                                            <label class="form-check-label" for="notifyAbend">
                                                <i class="fas fa-times-circle text-danger me-1"></i>Job em ABEND
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="notifyWsOffline" checked>
                                            <label class="form-check-label" for="notifyWsOffline">
                                                <i class="fas fa-server text-warning me-1"></i>Workstation Offline
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="notifyStuck">
                                            <label class="form-check-label" for="notifyStuck">
                                                <i class="fas fa-clock text-info me-1"></i>Job Travado
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="notifyPattern">
                                            <label class="form-check-label" for="notifyPattern">
                                                <i class="fas fa-chart-line text-primary me-1"></i>Padr√£o Detectado
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="soundEnabled">
                                        <label class="form-check-label" for="soundEnabled">
                                            <strong>Alerta Sonoro</strong>
                                            <small class="d-block text-muted">Beep para eventos cr√≠ticos</small>
                                        </label>
                                    </div>
                                    
                                    <button class="btn btn-outline-primary btn-sm" id="testNotification">
                                        <i class="fas fa-paper-plane me-1"></i>Testar Notifica√ß√£o
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Retention & Patterns -->
                    <div class="row">
                        <div class="col-xl-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-database me-2"></i>Reten√ß√£o de Dados</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Dados Completos</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="retentionFull" 
                                                           min="1" max="30" value="7">
                                                    <span class="input-group-text">dias</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Sum√°rios/Eventos</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="retentionSummary" 
                                                           min="7" max="90" value="30">
                                                    <span class="input-group-text">dias</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Padr√µes</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="retentionPatterns" 
                                                           min="30" max="365" value="90">
                                                    <span class="input-group-text">dias</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info mb-0">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <strong>Estimativa:</strong> ~150 MB para 30 dias com 9.000 jobs/dia
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-xl-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-brain me-2"></i>Detec√ß√£o de Padr√µes</h5>
                                </div>
                                <div class="card-body">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="patternDetectionEnabled" checked>
                                        <label class="form-check-label" for="patternDetectionEnabled">
                                            <strong>Habilitar Detec√ß√£o de Padr√µes</strong>
                                        </label>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Intervalo de An√°lise</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="patternInterval" 
                                                           min="5" max="60" value="15">
                                                    <span class="input-group-text">min</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Confian√ßa M√≠nima</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="patternConfidence" 
                                                           min="50" max="95" value="70">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <h6>Tipos de Padr√µes</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="patternRecurring" checked>
                                        <label class="form-check-label" for="patternRecurring">Falhas Recorrentes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="patternTime" checked>
                                        <label class="form-check-label" for="patternTime">Correla√ß√µes Temporais</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="patternDependency" checked>
                                        <label class="form-check-label" for="patternDependency">Cadeias de Depend√™ncia</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status & Actions -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Status do Sistema</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-light rounded">
                                        <i class="fas fa-clock fa-2x text-primary mb-2"></i>
                                        <h3 id="pollerStatus" class="mb-0">--</h3>
                                        <small class="text-muted">Polls Realizados</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-light rounded">
                                        <i class="fas fa-broadcast-tower fa-2x text-success mb-2"></i>
                                        <h3 id="eventsGenerated" class="mb-0">--</h3>
                                        <small class="text-muted">Eventos Gerados</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-light rounded">
                                        <i class="fas fa-users fa-2x text-info mb-2"></i>
                                        <h3 id="wsClients" class="mb-0">--</h3>
                                        <small class="text-muted">Clientes WebSocket</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-light rounded">
                                        <i class="fas fa-chart-line fa-2x text-warning mb-2"></i>
                                        <h3 id="patternsDetected" class="mb-0">--</h3>
                                        <small class="text-muted">Padr√µes Detectados</small>
                                    </div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="status-indicator" id="pollerStatusIndicator"></span>
                                    <strong id="pollerStatusText">Verificando...</strong>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-outline-success" id="startPollerBtn">
                                        <i class="fas fa-play me-1"></i>Iniciar
                                    </button>
                                    <button class="btn btn-outline-danger" id="stopPollerBtn">
                                        <i class="fas fa-stop me-1"></i>Parar
                                    </button>
                                    <button class="btn btn-outline-primary" id="forcePollBtn">
                                        <i class="fas fa-sync me-1"></i>For√ßar Poll
                                    </button>
                                    <button class="btn btn-outline-warning" id="detectPatternsBtn">
                                        <i class="fas fa-search me-1"></i>Detectar Padr√µes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- System Configuration Section - Neumorphic -->
                <div id="system-config" class="config-section">
                    <h2><i class="fas fa-cogs me-2"></i>System Configuration</h2>
                    <p class="text-muted">Configure performance, caching, monitoring, and system behavior</p>
                    
                    <!-- Resource Monitor Bar -->
                    <div class="resource-monitor card mb-4">
                        <div class="card-body py-3">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    <span class="resource-label"><i class="fas fa-microchip me-1"></i>CPU</span>
                                    <div class="resource-bar">
                                        <div class="resource-fill cpu" id="cpuBar" style="width: 0%"></div>
                                    </div>
                                    <span class="resource-value" id="cpuValue">0%</span>
                                </div>
                                <div class="col-auto">
                                    <span class="resource-label"><i class="fas fa-memory me-1"></i>Memory</span>
                                    <div class="resource-bar">
                                        <div class="resource-fill memory" id="memoryBar" style="width: 0%"></div>
                                    </div>
                                    <span class="resource-value" id="memoryValue">0 MB</span>
                                </div>
                                <div class="col-auto">
                                    <span class="resource-label"><i class="fas fa-hdd me-1"></i>Disk</span>
                                    <div class="resource-bar">
                                        <div class="resource-fill disk" id="diskBar" style="width: 0%"></div>
                                    </div>
                                    <span class="resource-value" id="diskValue">0%</span>
                                </div>
                                <div class="col-auto ms-auto">
                                    <button class="btn btn-sm btn-outline-primary" onclick="SystemConfig.refreshResources()">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="SystemConfig.triggerGC()" title="Force Garbage Collection">
                                        <i class="fas fa-broom"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Category Tabs -->
                    <ul class="nav nav-pills config-tabs mb-4" id="configCategoryTabs" role="tablist">
                        <!-- Tabs will be populated dynamically -->
                    </ul>
                    
                    <!-- Tab Content -->
                    <div class="tab-content" id="configTabContent">
                        <!-- Content will be populated dynamically -->
                    </div>
                    
                    <!-- Save Bar -->
                    <div class="save-bar card mt-4" id="saveBar" style="display: none;">
                        <div class="card-body d-flex align-items-center justify-content-between py-3">
                            <div>
                                <span class="badge bg-warning me-2" id="changesCount">0</span>
                                <span class="text-muted">unsaved changes</span>
                                <span class="text-warning ms-2" id="restartWarning" style="display: none;">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Some changes require restart
                                </span>
                            </div>
                            <div>
                                <button class="btn btn-outline-secondary me-2" onclick="SystemConfig.discardChanges()">
                                    <i class="fas fa-times me-1"></i>Discard
                                </button>
                                <button class="btn btn-success" onclick="SystemConfig.saveAllChanges()">
                                    <i class="fas fa-save me-1"></i>Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                <!-- LiteLLM Configuration Section - Neumorphic -->
                <div id="litellm-config" class="config-section">
                    <h2><i class="fas fa-brain me-2"></i>LiteLLM Configuration</h2>
                    <p class="text-muted">Multi-provider AI model management, cost monitoring, and smart routing</p>
                    
                    <!-- Status Overview Cards - Neumorphic -->
                    <div class="row mb-4">
                        <!-- Router Status -->
                        <div class="col-md-3 mb-3">
                            <div class="status-card" id="routerStatusCard">
                                <div class="status-icon">
                                    <i class="fas fa-server"></i>
                                </div>
                                <div class="status-info">
                                    <span class="status-label">Router Status</span>
                                    <span class="status-value" id="litellmRouterStatus">Checking...</span>
                                </div>
                                <div class="status-indicator" id="routerIndicator"></div>
                            </div>
                        </div>
                        
                        <!-- Active Models -->
                        <div class="col-md-3 mb-3">
                            <div class="status-card">
                                <div class="status-icon">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div class="status-info">
                                    <span class="status-label">Active Models</span>
                                    <span class="status-value" id="litellmModelCount">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Today's Cost -->
                        <div class="col-md-3 mb-3">
                            <div class="status-card">
                                <div class="status-icon cost">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <div class="status-info">
                                    <span class="status-label">Today's Cost</span>
                                    <span class="status-value" id="litellmTodayCost">$0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Total Requests -->
                        <div class="col-md-3 mb-3">
                            <div class="status-card">
                                <div class="status-icon requests">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                                <div class="status-info">
                                    <span class="status-label">Total Requests</span>
                                    <span class="status-value" id="litellmTotalRequests">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Budget Progress - Neumorphic -->
                    <div class="budget-card card mb-4">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="budget-label">
                                    <i class="fas fa-chart-pie me-2"></i>Monthly Budget Usage
                                </span>
                                <span class="budget-amount">
                                    <span id="litellmBudgetUsed">$0.00</span> / <span id="litellmBudgetLimit">$500.00</span>
                                </span>
                            </div>
                            <div class="budget-progress">
                                <div class="budget-fill" id="litellmBudgetBar" style="width: 0%"></div>
                            </div>
                            <div class="budget-info">
                                <span class="text-muted">Projected: <span id="litellmProjectedCost">$0.00</span>/month</span>
                                <span class="budget-alert" id="litellmBudgetAlert" style="display: none;">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Approaching limit
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabs - Neumorphic -->
                    <ul class="nav nav-pills litellm-tabs mb-4" id="litellmTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#litellm-providers">
                                <i class="fas fa-cloud me-2"></i>Providers
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#litellm-models">
                                <i class="fas fa-cubes me-2"></i>Models
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#litellm-routing">
                                <i class="fas fa-route me-2"></i>Smart Routing
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#litellm-costs">
                                <i class="fas fa-coins me-2"></i>Costs & Analytics
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content">
                        <!-- Providers Tab -->
                        <div class="tab-pane fade show active" id="litellm-providers">
                            <div class="row" id="litellmProvidersGrid">
                                <!-- Provider cards will be populated dynamically -->
                            </div>
                        </div>
                        
                        <!-- Models Tab -->
                        <div class="tab-pane fade" id="litellm-models">
                            <div class="models-toolbar mb-3">
                                <div class="row align-items-center">
                                    <div class="col-md-4">
                                        <input type="text" class="form-control config-input" id="litellmModelSearch" 
                                               placeholder="Search models..." style="max-width: 100%;">
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select config-select" id="litellmProviderFilter">
                                            <option value="">All Providers</option>
                                            <option value="openai">OpenAI</option>
                                            <option value="anthropic">Anthropic</option>
                                            <option value="ollama">Ollama (Local)</option>
                                            <option value="together_ai">Together AI</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="config-toggle">
                                            <input type="checkbox" id="litellmLocalOnly">
                                            <span class="config-toggle-slider"></span>
                                        </label>
                                        <span class="ms-2">Local Only (Free)</span>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <button class="btn btn-primary btn-sm" onclick="LiteLLMAdmin.refreshModels()">
                                            <i class="fas fa-sync-alt me-1"></i>Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="models-grid" id="litellmModelsGrid">
                                <!-- Model cards will be populated dynamically -->
                            </div>
                        </div>
                        
                        <!-- Routing Tab -->
                        <div class="tab-pane fade" id="litellm-routing">
                            <div class="config-card">
                                <div class="config-card-header">
                                    <div>
                                        <h5 class="config-card-title"><i class="fas fa-magic me-2"></i>Smart Model Routing</h5>
                                        <p class="config-card-description">Configure automatic model selection based on query complexity</p>
                                    </div>
                                </div>
                                
                                <div class="config-field">
                                    <div class="config-field-info">
                                        <div class="config-field-name">Enable Smart Routing</div>
                                        <div class="config-field-desc">Automatically select models based on query complexity</div>
                                    </div>
                                    <div class="config-field-control">
                                        <label class="config-toggle">
                                            <input type="checkbox" id="litellmRoutingEnabled" checked>
                                            <span class="config-toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="routing-models mt-4">
                                    <div class="routing-item">
                                        <div class="routing-label">
                                            <i class="fas fa-bolt text-success me-2"></i>
                                            <strong>Simple Queries</strong>
                                            <span class="text-muted ms-2">(Status checks, basic info)</span>
                                        </div>
                                        <select class="form-select config-select" id="litellmSimpleModel">
                                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                            <option value="gpt-4o-mini">GPT-4o Mini</option>
                                            <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                                            <option value="ollama/llama3">Llama 3 (Local)</option>
                                            <option value="ollama/mistral">Mistral (Local)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="routing-item">
                                        <div class="routing-label">
                                            <i class="fas fa-brain text-primary me-2"></i>
                                            <strong>Complex Queries</strong>
                                            <span class="text-muted ms-2">(Analysis, troubleshooting)</span>
                                        </div>
                                        <select class="form-select config-select" id="litellmComplexModel">
                                            <option value="gpt-4o">GPT-4o</option>
                                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                            <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                                            <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                                        </select>
                                    </div>
                                    
                                    <div class="routing-item">
                                        <div class="routing-label">
                                            <i class="fas fa-life-ring text-warning me-2"></i>
                                            <strong>Fallback Model</strong>
                                            <span class="text-muted ms-2">(When primary is unavailable)</span>
                                        </div>
                                        <select class="form-select config-select" id="litellmFallbackModel">
                                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                            <option value="ollama/llama3">Llama 3 (Local)</option>
                                            <option value="ollama/mistral">Mistral (Local)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="config-field mt-3">
                                    <div class="config-field-info">
                                        <div class="config-field-name"><i class="fas fa-home me-2"></i>Prefer Local Models</div>
                                        <div class="config-field-desc">Use local models when available (zero cost)</div>
                                    </div>
                                    <div class="config-field-control">
                                        <label class="config-toggle">
                                            <input type="checkbox" id="litellmPreferLocal">
                                            <span class="config-toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                                
                                <button class="btn btn-success mt-4" onclick="LiteLLMAdmin.saveRouting()">
                                    <i class="fas fa-save me-1"></i>Save Routing Configuration
                                </button>
                            </div>
                        </div>
                        
                        <!-- Costs Tab -->
                        <div class="tab-pane fade" id="litellm-costs">
                            <div class="row">
                                <!-- Daily Costs Chart -->
                                <div class="col-md-8 mb-4">
                                    <div class="config-card">
                                        <div class="config-card-header">
                                            <h6 class="config-card-title"><i class="fas fa-chart-line me-2"></i>Daily Cost Trend</h6>
                                        </div>
                                        <canvas id="litellmCostChart" height="250"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Model Breakdown -->
                                <div class="col-md-4 mb-4">
                                    <div class="config-card">
                                        <div class="config-card-header">
                                            <h6 class="config-card-title"><i class="fas fa-chart-pie me-2"></i>Cost by Model</h6>
                                        </div>
                                        <canvas id="litellmModelCostChart" height="250"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Usage Stats -->
                            <div class="config-card">
                                <div class="config-card-header">
                                    <h6 class="config-card-title"><i class="fas fa-tachometer-alt me-2"></i>Usage Statistics</h6>
                                </div>
                                <div class="row text-center">
                                    <div class="col-md-2">
                                        <div class="stat-box">
                                            <div class="stat-value" id="litellmStatRequests">0</div>
                                            <div class="stat-label">Total Requests</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="stat-box">
                                            <div class="stat-value" id="litellmStatInputTokens">0</div>
                                            <div class="stat-label">Input Tokens</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="stat-box">
                                            <div class="stat-value" id="litellmStatOutputTokens">0</div>
                                            <div class="stat-label">Output Tokens</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="stat-box">
                                            <div class="stat-value" id="litellmStatLatency">0ms</div>
                                            <div class="stat-label">Avg Latency</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="stat-box">
                                            <div class="stat-value" id="litellmStatErrorRate">0%</div>
                                            <div class="stat-label">Error Rate</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="stat-box">
                                            <div class="stat-value" id="litellmStatTotalCost">$0.00</div>
                                            <div class="stat-label">Total Cost</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Test Model Modal -->
                    <div class="modal fade" id="testModelModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title"><i class="fas fa-flask me-2"></i>Test Model</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">Model</label>
                                        <input type="text" class="form-control config-input" id="testModelName" readonly style="max-width: 100%;">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Test Prompt</label>
                                        <textarea class="form-control" id="testModelPrompt" rows="3">Hello, respond with 'OK' if you're working.</textarea>
                                    </div>
                                    <div id="testModelResult" style="display: none;">
                                        <div class="alert" id="testResultAlert">
                                            <div id="testResultContent"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-primary" onclick="LiteLLMAdmin.runTest()">
                                        <i class="fas fa-play me-1"></i>Run Test
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Health Monitoring Section (Hidden by default) -->
                <div id="health-monitoring" class="config-section">
                    <h2><i class="fas fa-heartbeat me-2"></i>System Health Monitoring</h2>
                    <p class="text-muted">Monitor system performance and health status in real-time</p>
                    
                    <!-- Overall Status Banner -->
                    <div class="alert alert-success mb-4" id="healthOverallBanner" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>System Status:</strong> <span id="healthOverallStatus">All systems operational</span>
                        <button class="btn btn-sm btn-outline-light float-end" onclick="refreshHealthStatus()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                    
                    <!-- Component Cards - Row 1: Core Infrastructure -->
                    <h5 class="mb-3"><i class="fas fa-server me-2"></i>Core Infrastructure</h5>
                    <div class="row mb-4">
                        <div class="col-md-4 mb-3">
                            <div class="card text-center health-card" id="healthCardDatabase">
                                <div class="card-body">
                                    <div class="display-4 text-success" id="healthIconDatabase">
                                        <i class="fas fa-database"></i>
                                    </div>
                                    <h5 class="card-title mt-2">Database</h5>
                                    <p class="card-text" id="healthDatabaseStatus">Checking...</p>
                                    <small class="text-muted" id="healthDatabaseLatency"></small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="card text-center health-card" id="healthCardRedis">
                                <div class="card-body">
                                    <div class="display-4 text-success" id="healthIconRedis">
                                        <i class="fas fa-bolt"></i>
                                    </div>
                                    <h5 class="card-title mt-2">Redis Cache</h5>
                                    <p class="card-text" id="healthRedisStatus">Checking...</p>
                                    <small class="text-muted" id="healthRedisLatency"></small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="card text-center health-card" id="healthCardLLM">
                                <div class="card-body">
                                    <div class="display-4 text-success" id="healthIconLLM">
                                        <i class="fas fa-brain"></i>
                                    </div>
                                    <h5 class="card-title mt-2">LLM Service</h5>
                                    <p class="card-text" id="healthLLMStatus">Checking...</p>
                                    <small class="text-muted" id="healthLLMLatency"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Component Cards - Row 2: Integrations -->
                    <h5 class="mb-3"><i class="fas fa-plug me-2"></i>Integrations</h5>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card text-center health-card" id="healthCardRAG">
                                <div class="card-body">
                                    <div class="display-4 text-success" id="healthIconRAG">
                                        <i class="fas fa-search"></i>
                                    </div>
                                    <h5 class="card-title mt-2">RAG (Qdrant)</h5>
                                    <p class="card-text" id="healthRAGStatus">Checking...</p>
                                    <small class="text-muted" id="healthRAGLatency"></small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="card text-center health-card" id="healthCardTeams">
                                <div class="card-body">
                                    <div class="display-4 text-success" id="healthIconTeams">
                                        <i class="fab fa-microsoft"></i>
                                    </div>
                                    <h5 class="card-title mt-2">Teams</h5>
                                    <p class="card-text" id="healthTeamsStatus">Checking...</p>
                                    <small class="text-muted" id="healthTeamsLatency"></small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="card text-center health-card" id="healthCardTWS">
                                <div class="card-body">
                                    <div class="display-4 text-success" id="healthIconTWS">
                                        <i class="fas fa-cogs"></i>
                                    </div>
                                    <h5 class="card-title mt-2">TWS (HWA)</h5>
                                    <p class="card-text" id="healthTWSStatus">Checking...</p>
                                    <small class="text-muted" id="healthTWSLatency"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Health History / Last Check Info -->
                    <div class="card mt-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-clock me-2"></i>Last checked: <span id="healthLastCheck">Never</span></span>
                                <div>
                                    <label class="form-check-label me-2">
                                        <input type="checkbox" class="form-check-input" id="healthAutoRefresh" checked>
                                        Auto-refresh (30s)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

                <!-- Notifications Section (Hidden by default) -->
                <div id="notifications" class="config-section">
                    <h2><i class="fas fa-bell me-2"></i>Notifications
                        <span class="badge badge-warning" style="margin-left:auto;">3</span></h2>
                    <p class="text-muted">Configure which job statuses and system alerts trigger notifications</p>

                    <div class="card">
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Job Status Filters</label>
                                <select multiple class="form-select" id="notifStatusFilters" size="6">
                                    <option value="ABEND">ABEND (Abnormal End)</option>
                                    <option value="ERROR">Error</option>
                                    <option value="FAILED">Failed</option>
                                    <option value="TIMEOUT">Timeout</option>
                                    <option value="CANCELLED">Cancelled</option>
                                    <option value="WARNING">Warning</option>
                                </select>
                                <div class="form-text">Select job statuses that trigger notifications</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Notification Types</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="notifyJobStatus">
                                    <label class="form-check-label" for="notifyJobStatus">Job Status Changes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="notifyAlerts">
                                    <label class="form-check-label" for="notifyAlerts">System Alerts</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="notifyPerformance">
                                    <label class="form-check-label" for="notifyPerformance">Performance Issues</label>
                                </div>
                            </div>

                            <button class="btn btn-success" id="saveNotificationsBtn">
                                <i class="fas fa-save me-1"></i>Save Notifications
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Logs Section (Hidden by default) -->
                <div id="logs" class="config-section">
                    <h2><i class="fas fa-file-alt me-2"></i>System Logs</h2>
                    <p class="text-muted">View recent entries from application logs</p>

                    <div class="card">
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Log File</label>
                                    <input type="text" class="form-control" id="logFileName" value="app.log">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Lines</label>
                                    <input type="number" class="form-control" id="logLines" value="100" min="10" max="1000">
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button class="btn btn-outline-primary w-100" id="loadLogsBtn">
                                        <i class="fas fa-eye me-1"></i>Load Logs
                                    </button>
                                </div>
                            </div>
                            <pre id="logContent" class="p-3 bg-light" style="height: 300px; overflow-y: scroll; white-space: pre-wrap;"></pre>
                        </div>
                    </div>
                </div>

                <!-- Backup & Restore Section (Hidden by default) -->
                <div id="backup-restore" class="config-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2><i class="fas fa-database me-2"></i>Backup & Restore</h2>
                            <p class="text-muted mb-0">Gerenciamento de backups e agendamentos</p>
                        </div>
                        <button class="btn btn-outline-primary" onclick="BackupAdmin.refresh()">
                            <i class="fas fa-sync-alt me-1"></i>Atualizar
                        </button>
                    </div>

                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h3 class="mb-0" id="backupTotalCount">--</h3>
                                    <small class="text-muted">Total Backups</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h3 class="mb-0 text-primary" id="backupTotalSize">--</h3>
                                    <small class="text-muted">Espa√ßo Utilizado</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h3 class="mb-0 text-success" id="backupScheduleCount">--</h3>
                                    <small class="text-muted">Agendamentos Ativos</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h3 class="mb-0 text-info" id="backupLastDate">--</h3>
                                    <small class="text-muted">√öltimo Backup</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Backup Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Criar Backup Manual</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <button class="btn btn-primary w-100 mb-2" onclick="BackupAdmin.createBackup('database')">
                                        <i class="fas fa-database me-2"></i>Backup Banco
                                    </button>
                                    <small class="text-muted d-block text-center">PostgreSQL dump completo</small>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-info w-100 mb-2" onclick="BackupAdmin.createBackup('config')">
                                        <i class="fas fa-cog me-2"></i>Backup Config
                                    </button>
                                    <small class="text-muted d-block text-center">Arquivos de configura√ß√£o</small>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-success w-100 mb-2" onclick="BackupAdmin.createBackup('full')">
                                        <i class="fas fa-archive me-2"></i>Backup Completo
                                    </button>
                                    <small class="text-muted d-block text-center">Banco + Config + Prompts</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Backups List Card -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Backups Dispon√≠veis</h5>
                            <select class="form-select form-select-sm" style="width: auto;" id="backupTypeFilter" onchange="BackupAdmin.loadBackups()">
                                <option value="">Todos os tipos</option>
                                <option value="database">Banco de Dados</option>
                                <option value="config">Configura√ß√£o</option>
                                <option value="full">Completo</option>
                            </select>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-hover table-sm">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>Arquivo</th>
                                            <th>Tipo</th>
                                            <th>Tamanho</th>
                                            <th>Data</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="backupsTableBody">
                                        <tr><td colspan="6" class="text-center text-muted">Carregando...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Schedules Card -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Agendamentos</h5>
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
                                <i class="fas fa-plus me-1"></i>Novo Agendamento
                            </button>
                        </div>
                        <div class="card-body">
                            <table class="table table-hover table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Nome</th>
                                        <th>Tipo</th>
                                        <th>Cron</th>
                                        <th>Reten√ß√£o</th>
                                        <th>Pr√≥xima Execu√ß√£o</th>
                                        <th>Status</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="schedulesTableBody">
                                    <tr><td colspan="7" class="text-center text-muted">Carregando...</td></tr>
                                </tbody>
                            </table>

                            <div class="mt-3 p-3 bg-light rounded">
                                <h6 class="mb-2"><i class="fas fa-info-circle me-1"></i>Exemplos de Cron</h6>
                                <div class="row small">
                                    <div class="col-md-3"><code>0 2 * * *</code> - Di√°rio √†s 2:00 AM</div>
                                    <div class="col-md-3"><code>0 0 * * 0</code> - Domingos √† meia-noite</div>
                                    <div class="col-md-3"><code>0 0 1 * *</code> - Dia 1 de cada m√™s</div>
                                    <div class="col-md-3"><code>0 */6 * * *</code> - A cada 6 horas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Observability Section -->
                <div id="observability" class="config-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2><i class="fas fa-eye me-2"></i>Observability & AI Monitoring</h2>
                            <p class="text-muted mb-0">LangFuse tracing e Evidently drift detection</p>
                        </div>
                        <button class="btn btn-outline-primary" onclick="ObservabilityAdmin.refresh()">
                            <i class="fas fa-sync-alt me-1"></i>Atualizar
                        </button>
                    </div>

                    <div class="row">
                        <!-- LangFuse Card -->
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>LangFuse</h5>
                                    <span class="badge bg-secondary" id="langfuseStatusBadge">--</span>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <div class="p-3 border rounded text-center">
                                                <span class="d-block" id="langfuseEnabled">--</span>
                                                <small class="text-muted">Status</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-3 border rounded text-center">
                                                <span class="d-block" id="langfuseConnected">--</span>
                                                <small class="text-muted">Conex√£o</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <div class="p-3 border rounded text-center">
                                                <span class="d-block" id="langfuseHost">--</span>
                                                <small class="text-muted">Host</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-3 border rounded text-center">
                                                <span class="d-block" id="langfuseConfigured">--</span>
                                                <small class="text-muted">Configurado</small>
                                            </div>
                                        </div>
                                    </div>

                                    <hr>
                                    <h6><i class="fas fa-chart-bar me-2"></i>Estat√≠sticas</h6>
                                    <div class="row">
                                        <div class="col-3 text-center">
                                            <h4 class="mb-0" id="langfuseTraces">--</h4>
                                            <small class="text-muted">Traces</small>
                                        </div>
                                        <div class="col-3 text-center">
                                            <h4 class="mb-0 text-success" id="langfuseSuccessRate">--%</h4>
                                            <small class="text-muted">Success</small>
                                        </div>
                                        <div class="col-3 text-center">
                                            <h4 class="mb-0 text-info" id="langfuseTokens">--</h4>
                                            <small class="text-muted">Tokens</small>
                                        </div>
                                        <div class="col-3 text-center">
                                            <h4 class="mb-0 text-warning" id="langfuseCost">$--</h4>
                                            <small class="text-muted">Custo</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Evidently Card -->
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-search me-2"></i>Evidently AI</h5>
                                    <span class="badge bg-secondary" id="evidentlyStatusBadge">--</span>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <div class="p-3 border rounded text-center">
                                                <span class="d-block" id="evidentlyEnabled">--</span>
                                                <small class="text-muted">Status</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-3 border rounded text-center">
                                                <span class="d-block" id="evidentlyActive">--</span>
                                                <small class="text-muted">Monitoramento</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <div class="p-3 border rounded text-center">
                                                <span class="d-block" id="evidentlyRefData">--</span>
                                                <small class="text-muted">Dados Refer√™ncia</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-3 border rounded text-center">
                                                <span class="d-block" id="evidentlyCurrentData">--</span>
                                                <small class="text-muted">Dados Atuais</small>
                                            </div>
                                        </div>
                                    </div>

                                    <hr>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-warning flex-fill" onclick="ObservabilityAdmin.checkDrift()">
                                            <i class="fas fa-search me-1"></i>Verificar Drift
                                        </button>
                                        <button class="btn btn-info flex-fill" onclick="ObservabilityAdmin.showReports()">
                                            <i class="fas fa-file-alt me-1"></i>Ver Relat√≥rios
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Drift Result Card (hidden initially) -->
                    <div class="card mb-4" id="driftResultCard" style="display: none;">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Resultado da Verifica√ß√£o de Drift</h5>
                        </div>
                        <div class="card-body" id="driftResultBody">
                        </div>
                    </div>

                    <!-- Reports Card (hidden initially) -->
                    <div class="card mb-4" id="driftReportsCard" style="display: none;">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-history me-2"></i>Relat√≥rios de Drift</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Arquivo</th>
                                        <th>Data</th>
                                        <th>Drift Detectado</th>
                                    </tr>
                                </thead>
                                <tbody id="driftReportsTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Environment Variables Card -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-key me-2"></i>Vari√°veis de Ambiente</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-muted">LangFuse</h6>
                                    <div id="langfuseEnvVars" class="small">
                                        <div class="mb-1"><code>LANGFUSE_PUBLIC_KEY</code>: <span class="text-muted">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span></div>
                                        <div class="mb-1"><code>LANGFUSE_SECRET_KEY</code>: <span class="text-muted">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span></div>
                                        <div class="mb-1"><code>LANGFUSE_HOST</code>: <span id="envLangfuseHost">--</span></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted">Evidently</h6>
                                    <div id="evidentlyEnvVars" class="small">
                                        <div class="mb-1"><code>EVIDENTLY_ENABLED</code>: <span id="envEvidentlyEnabled">--</span></div>
                                        <div class="mb-1"><code>EVIDENTLY_REPORTS_PATH</code>: <span id="envEvidentlyPath">--</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Revis√£o Operador Section -->
                <div id="revisao-operador" class="config-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2><i class="fas fa-clipboard-check me-2"></i>Revis√£o de Mem√≥rias</h2>
                            <p class="text-muted">Revis√£o de intera√ß√µes sinalizadas pelo Active Learning</p>
                        </div>
                        <button class="btn btn-outline-primary" onclick="RevisaoAdmin.loadAudits()">
                            <i class="fas fa-sync-alt me-1"></i>Atualizar
                        </button>
                    </div>

                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 class="text-warning" id="revisao-stat-pending">0</h3>
                                    <p class="text-muted mb-0">Pendentes</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 class="text-success" id="revisao-stat-approved">0</h3>
                                    <p class="text-muted mb-0">Aprovadas</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h3 class="text-danger" id="revisao-stat-rejected">0</h3>
                                    <p class="text-muted mb-0">Rejeitadas</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="fas fa-filter me-2"></i>Filtros
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <select class="form-select" id="revisao-status-filter" onchange="RevisaoAdmin.loadAudits()">
                                        <option value="pending" selected>Pendentes</option>
                                        <option value="approved">Aprovadas</option>
                                        <option value="rejected">Rejeitadas</option>
                                        <option value="">Todas</option>
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <input type="text" class="form-control" id="revisao-search" placeholder="Buscar por query...">
                                </div>
                                <div class="col-md-2">
                                    <input type="date" class="form-control" id="revisao-date-filter">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-primary w-100" onclick="RevisaoAdmin.loadAudits()">
                                        <i class="fas fa-search me-1"></i>Filtrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Review Items Container -->
                    <div id="revisao-items-container">
                        <!-- Items will be loaded here dynamically -->
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                            <p>Carregando itens para revis√£o...</p>
                        </div>
                    </div>
                </div>

                <!-- Audit Section (Hidden by default) -->
                <div id="audit" class="config-section">
                    <h2><i class="fas fa-scroll me-2"></i>Audit Log</h2>
                    <p class="text-muted">Inspect recent audit trail entries</p>

                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button class="btn btn-outline-primary" id="loadAuditBtn">
                                    <i class="fas fa-eye me-1"></i>Load Audit Logs
                                </button>
                            </div>
                            <div style="height: 300px; overflow-y: scroll;">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th scope="col">#</th>
                                            <th scope="col">Timestamp</th>
                                            <th scope="col">Message</th>
                                        </tr>
                                    </thead>
                                    <tbody id="auditTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Semantic Cache Section (v5.3.16) -->
                <div id="semantic-cache" class="config-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2><i class="fas fa-brain me-2"></i>Semantic Cache</h2>
                            <p class="text-muted mb-0">Cache inteligente para respostas LLM - Reduz custos em at√© 70%</p>
                        </div>
                        <button class="btn btn-outline-primary" id="refreshSemanticCache">
                            <i class="fas fa-sync-alt me-1"></i>Atualizar
                        </button>
                    </div>

                    <!-- Status Cards Row -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="fas fa-database fa-2x text-primary mb-2"></i>
                                    <h5 class="card-title" id="cache-entries">-</h5>
                                    <p class="card-text text-muted">Entradas Cacheadas</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="fas fa-bullseye fa-2x text-success mb-2"></i>
                                    <h5 class="card-title" id="cache-hit-rate">-%</h5>
                                    <p class="card-text text-muted">Hit Rate</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="fas fa-dollar-sign fa-2x text-warning mb-2"></i>
                                    <h5 class="card-title" id="cache-savings">$0</h5>
                                    <p class="card-text text-muted">Economia Estimada</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <i class="fas fa-clock fa-2x text-info mb-2"></i>
                                    <h5 class="card-title" id="cache-avg-latency">-ms</h5>
                                    <p class="card-text text-muted">Lat√™ncia M√©dia</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Health Status Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="fas fa-heartbeat me-2"></i>Status do Sistema
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="status-indicator" id="redis-status-indicator"></span>
                                        <strong>Redis:</strong>
                                        <span class="ms-2" id="redis-status-text">Verificando...</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="status-indicator" id="redis-stack-indicator"></span>
                                        <strong>Redis Stack:</strong>
                                        <span class="ms-2" id="redis-stack-text">Verificando...</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="status-indicator" id="embedding-model-indicator"></span>
                                        <strong>Embedding Model:</strong>
                                        <span class="ms-2" id="embedding-model-text">Verificando...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <small class="text-muted">
                                        <strong>Mem√≥ria Redis:</strong> <span id="redis-memory">-</span>
                                    </small>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted">
                                        <strong>Modelo:</strong> <span id="embedding-model-name">-</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="fas fa-cog me-2"></i>Configura√ß√£o do Cache
                        </div>
                        <div class="card-body">
                            <form id="cacheConfigForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="cacheThreshold" class="form-label">
                                                <i class="fas fa-sliders-h me-1"></i>Threshold de Similaridade
                                                <i class="fas fa-info-circle text-muted ms-1" 
                                                   data-bs-toggle="tooltip" 
                                                   title="Dist√¢ncia m√°xima para considerar cache hit. Menor = mais restritivo."></i>
                                            </label>
                                            <div class="input-group">
                                                <input type="range" class="form-range" id="cacheThresholdSlider" 
                                                       min="0.1" max="0.5" step="0.05" value="0.25"
                                                       oninput="document.getElementById('cacheThreshold').value = this.value">
                                                <input type="number" class="form-control ms-3" id="cacheThreshold" 
                                                       min="0.1" max="0.5" step="0.01" value="0.25" style="max-width: 100px;">
                                            </div>
                                            <div class="form-text">
                                                <span class="text-success">0.15-0.20</span> Muito preciso |
                                                <span class="text-primary">0.25</span> Balanceado |
                                                <span class="text-warning">0.30-0.40</span> Agressivo
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="cacheTTL" class="form-label">
                                                <i class="fas fa-clock me-1"></i>TTL Padr√£o (segundos)
                                            </label>
                                            <select class="form-select" id="cacheTTL">
                                                <option value="3600">1 hora</option>
                                                <option value="21600">6 horas</option>
                                                <option value="43200">12 horas</option>
                                                <option value="86400" selected>24 horas</option>
                                                <option value="259200">3 dias</option>
                                                <option value="604800">7 dias</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-primary" id="saveThresholdBtn">
                                        <i class="fas fa-save me-1"></i>Salvar Threshold
                                    </button>
                                    <button type="button" class="btn btn-outline-info" id="preloadModelBtn">
                                        <i class="fas fa-download me-1"></i>Pr√©-carregar Modelo
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Test Cache Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="fas fa-vial me-2"></i>Testar Cache
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="testQuery" class="form-label">Query de Teste</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="testQuery" 
                                           placeholder="Ex: Como reiniciar um job TWS?">
                                    <button class="btn btn-outline-primary" type="button" id="testCacheBtn">
                                        <i class="fas fa-search me-1"></i>Buscar no Cache
                                    </button>
                                </div>
                            </div>
                            <div id="testCacheResult" class="alert d-none" role="alert">
                                <!-- Result will be shown here -->
                            </div>
                        </div>
                    </div>

                    <!-- Cache Invalidation Card -->
                    <div class="card mb-4">
                        <div class="card-header bg-warning bg-opacity-10">
                            <i class="fas fa-trash-alt me-2"></i>Invalida√ß√£o de Cache
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="invalidateQuery" class="form-label">Invalidar Query Espec√≠fica</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="invalidateQuery" 
                                                   placeholder="Query a remover do cache">
                                            <button class="btn btn-outline-warning" type="button" id="invalidateQueryBtn">
                                                <i class="fas fa-times me-1"></i>Invalidar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="invalidatePattern" class="form-label">Invalidar por Padr√£o</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="invalidatePattern" 
                                                   placeholder="Ex: *job*">
                                            <button class="btn btn-outline-warning" type="button" id="invalidatePatternBtn">
                                                <i class="fas fa-filter me-1"></i>Invalidar Padr√£o
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-danger">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    Limpar todo o cache remove todas as respostas cacheadas
                                </span>
                                <button class="btn btn-danger" id="clearAllCacheBtn">
                                    <i class="fas fa-trash me-1"></i>Limpar Todo Cache
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Card -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-bar me-2"></i>Estat√≠sticas Detalhadas
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td><strong>Total de Hits</strong></td>
                                            <td id="stat-hits">-</td>
                                            <td><strong>Total de Misses</strong></td>
                                            <td id="stat-misses">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Total de Sets</strong></td>
                                            <td id="stat-sets">-</td>
                                            <td><strong>Erros</strong></td>
                                            <td id="stat-errors">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Threshold Atual</strong></td>
                                            <td id="stat-threshold">-</td>
                                            <td><strong>TTL Padr√£o</strong></td>
                                            <td id="stat-ttl">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>M√°x. Entradas</strong></td>
                                            <td id="stat-max-entries">-</td>
                                            <td><strong>Redis Stack</strong></td>
                                            <td id="stat-redis-stack">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Redis Configuration Card -->
                    <div class="card mb-4 mt-4">
                        <div class="card-header bg-danger bg-opacity-10">
                            <i class="fas fa-server me-2"></i>Configura√ß√£o Redis
                            <span class="badge bg-info float-end" id="redis-version-badge">-</span>
                        </div>
                        <div class="card-body">
                            <!-- Redis Connection Info -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-plug me-2"></i>Conex√£o</h6>
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <td class="text-muted" style="width: 120px;">Host:</td>
                                            <td><code id="redis-host">-</code></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Porta:</td>
                                            <td><code id="redis-port">-</code></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Database:</td>
                                            <td><code id="redis-database">-</code></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Status:</td>
                                            <td>
                                                <span class="badge" id="redis-connection-status">-</span>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-memory me-2"></i>Mem√≥ria</h6>
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <td class="text-muted" style="width: 120px;">Usada:</td>
                                            <td><span id="redis-used-memory-detail">-</span></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">M√°xima:</td>
                                            <td><span id="redis-max-memory">-</span></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">% Uso:</td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar" id="redis-memory-bar" role="progressbar" 
                                                         style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                        <span id="redis-memory-percent">0%</span>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Pol√≠tica:</td>
                                            <td><code id="redis-eviction-policy">-</code></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <!-- Redis Stack Modules -->
                            <h6><i class="fas fa-puzzle-piece me-2"></i>M√≥dulos Redis Stack</h6>
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card text-center border-0 bg-light">
                                        <div class="card-body py-2">
                                            <i class="fas fa-search fa-lg mb-1" id="module-search-icon"></i>
                                            <p class="small mb-0">RediSearch</p>
                                            <span class="badge" id="module-search-status">-</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center border-0 bg-light">
                                        <div class="card-body py-2">
                                            <i class="fas fa-code fa-lg mb-1" id="module-json-icon"></i>
                                            <p class="small mb-0">ReJSON</p>
                                            <span class="badge" id="module-json-status">-</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center border-0 bg-light">
                                        <div class="card-body py-2">
                                            <i class="fas fa-chart-line fa-lg mb-1" id="module-timeseries-icon"></i>
                                            <p class="small mb-0">TimeSeries</p>
                                            <span class="badge" id="module-timeseries-status">-</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center border-0 bg-light">
                                        <div class="card-body py-2">
                                            <i class="fas fa-filter fa-lg mb-1" id="module-bloom-icon"></i>
                                            <p class="small mb-0">RedisBloom</p>
                                            <span class="badge" id="module-bloom-status">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Database Usage -->
                            <h6><i class="fas fa-database me-2"></i>Databases em Uso</h6>
                            <div class="table-responsive mb-4">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>DB</th>
                                            <th>Prop√≥sito</th>
                                            <th>Chaves</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="redis-databases-table">
                                        <tr>
                                            <td>DB 0</td>
                                            <td>Connection Pools</td>
                                            <td id="db0-keys">-</td>
                                            <td><span class="badge bg-secondary" id="db0-status">-</span></td>
                                        </tr>
                                        <tr>
                                            <td>DB 1</td>
                                            <td>Sessions</td>
                                            <td id="db1-keys">-</td>
                                            <td><span class="badge bg-secondary" id="db1-status">-</span></td>
                                        </tr>
                                        <tr>
                                            <td>DB 2</td>
                                            <td>Cache Geral</td>
                                            <td id="db2-keys">-</td>
                                            <td><span class="badge bg-secondary" id="db2-status">-</span></td>
                                        </tr>
                                        <tr class="table-info">
                                            <td><strong>DB 3</strong></td>
                                            <td><strong>Semantic Cache</strong></td>
                                            <td id="db3-keys">-</td>
                                            <td><span class="badge bg-success" id="db3-status">Ativo</span></td>
                                        </tr>
                                        <tr>
                                            <td>DB 4</td>
                                            <td>Idempotency</td>
                                            <td id="db4-keys">-</td>
                                            <td><span class="badge bg-secondary" id="db4-status">-</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Performance Metrics -->
                            <h6><i class="fas fa-tachometer-alt me-2"></i>Performance</h6>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted">Conex√µes Ativas:</span>
                                        <strong id="redis-connected-clients">-</strong>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted">Ops/segundo:</span>
                                        <strong id="redis-ops-per-sec">-</strong>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted">Uptime:</span>
                                        <strong id="redis-uptime">-</strong>
                                    </div>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                                <div>
                                    <button class="btn btn-outline-primary btn-sm me-2" id="refreshRedisInfo">
                                        <i class="fas fa-sync-alt me-1"></i>Atualizar Info
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" id="testRedisConnection">
                                        <i class="fas fa-plug me-1"></i>Testar Conex√£o
                                    </button>
                                </div>
                                <div>
                                    <a href="https://redis.io/docs/install/install-stack/linux/" target="_blank" 
                                       class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-external-link-alt me-1"></i>Instalar Redis Stack
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Threshold Tuning Guide Card -->
                    <div class="card mb-4">
                        <div class="card-header bg-info bg-opacity-10">
                            <i class="fas fa-graduation-cap me-2"></i>Guia de Ajuste de Threshold
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">
                                O threshold define qu√£o "similar" uma query precisa ser para resultar em cache hit.
                                Valores menores s√£o mais precisos, valores maiores geram mais hits.
                            </p>
                            
                            <div class="table-responsive mb-4">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Threshold</th>
                                            <th>Comportamento</th>
                                            <th>Recomendado Para</th>
                                            <th>Risco</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="table-success">
                                            <td><code>0.15 - 0.20</code></td>
                                            <td>Muito restritivo</td>
                                            <td>Alta precis√£o necess√°ria</td>
                                            <td><span class="badge bg-success">Baixo</span></td>
                                        </tr>
                                        <tr class="table-primary">
                                            <td><code>0.25</code> ‚≠ê</td>
                                            <td><strong>Balanceado (Recomendado)</strong></td>
                                            <td>Uso geral, come√ßar aqui</td>
                                            <td><span class="badge bg-primary">M√©dio-Baixo</span></td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td><code>0.30 - 0.35</code></td>
                                            <td>Mais agressivo</td>
                                            <td>Priorizar economia</td>
                                            <td><span class="badge bg-warning text-dark">M√©dio</span></td>
                                        </tr>
                                        <tr class="table-danger">
                                            <td><code>0.40+</code></td>
                                            <td>Muito permissivo</td>
                                            <td>N√£o recomendado</td>
                                            <td><span class="badge bg-danger">Alto</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="alert alert-info mb-0">
                                <h6 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>Processo de Tuning</h6>
                                <ol class="mb-0 ps-3">
                                    <li>Comece com <strong>0.25</strong> e monitore por 1-2 semanas</li>
                                    <li>Observe o <strong>hit rate</strong> (meta: &gt;60%)</li>
                                    <li>Verifique <strong>false positives</strong> (usu√°rios reclamando de respostas erradas)</li>
                                    <li>Se hit rate baixo e sem false positives ‚Üí aumente para 0.30</li>
                                    <li>Se houver false positives ‚Üí reduza para 0.20</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <!-- Embedding Model Info Card -->
                    <div class="card">
                        <div class="card-header" style="background-color: rgba(128, 0, 128, 0.1);">
                            <i class="fas fa-robot me-2"></i>Modelo de Embeddings
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <td class="text-muted" style="width: 140px;">Modelo:</td>
                                            <td><code id="embedding-model-full-name">-</code></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Dimens√µes:</td>
                                            <td><span id="embedding-dimensions">-</span></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Tamanho:</td>
                                            <td><span id="embedding-size">~80MB</span></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Status:</td>
                                            <td>
                                                <span class="badge" id="embedding-load-status">-</span>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <div class="alert alert-secondary mb-0">
                                        <small>
                                            <strong>all-MiniLM-L6-v2</strong> √© um modelo leve e eficiente que:
                                            <ul class="mb-0 mt-1">
                                                <li>Roda em CPU (~10ms/embedding)</li>
                                                <li>Usa ~200MB de RAM</li>
                                                <li>Qualidade suficiente para cache sem√¢ntico</li>
                                                <li>100% offline e gratuito</li>
                                            </ul>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="auto-tuning" class="config-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2><i class="fas fa-sliders-h me-2"></i>Auto-Tuning de Thresholds</h2>
                            <p class="text-muted mb-0">Calibra√ß√£o autom√°tica dos thresholds do Active Learning</p>
                        </div>
                        <button class="btn btn-outline-primary" id="refreshAutoTuning">
                            <i class="fas fa-sync-alt me-1"></i>Atualizar
                        </button>
                    </div>

                    <!-- Level Selector Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-gauge-high me-2"></i>N√≠vel de Auto-Tuning</h5>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="auto-tuning-slider-container">
                                        <input type="range" class="form-range" min="0" max="3" step="1"
                                               id="autoTuningSlider" value="0">
                                        <div class="d-flex justify-content-between mt-2">
                                            <span class="badge bg-secondary slider-label" data-level="0">OFF</span>
                                            <span class="badge bg-info slider-label" data-level="1">LOW</span>
                                            <span class="badge bg-warning slider-label" data-level="2">MID</span>
                                            <span class="badge bg-success slider-label" data-level="3">HIGH</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div id="autoTuningLevelInfo" class="alert alert-secondary mb-0">
                                        <strong id="levelTitle">Desativado</strong>
                                        <p class="mb-0 small" id="levelDescription">Thresholds est√°ticos. Sem coleta de m√©tricas.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-primary" id="applyAutoTuningLevel" disabled>
                                    <i class="fas fa-check me-1"></i>Aplicar N√≠vel
                                </button>
                                <button class="btn btn-outline-secondary ms-2" id="resetThresholds">
                                    <i class="fas fa-undo me-1"></i>Resetar Thresholds
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Metrics Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>M√©tricas de Efic√°cia (24h)</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <h3 class="mb-0" id="metricReviewRate">--%</h3>
                                        <small class="text-muted">Taxa de Review</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <h3 class="mb-0 text-warning" id="metricFPRate">--%</h3>
                                        <small class="text-muted">False Positive Rate</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <h3 class="mb-0 text-danger" id="metricFNRate">--%</h3>
                                        <small class="text-muted">False Negative Rate</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 border rounded">
                                        <h3 class="mb-0 text-success" id="metricF1Score">--%</h3>
                                        <small class="text-muted">F1 Score</small>
                                    </div>
                                </div>
                            </div>
                            <div id="metricsInterpretation" class="mt-3"></div>
                        </div>
                    </div>

                    <!-- Current Thresholds Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Thresholds Atuais</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Threshold</th>
                                        <th>Valor Atual</th>
                                        <th>M√≠nimo</th>
                                        <th>M√°ximo</th>
                                        <th>Padr√£o</th>
                                    </tr>
                                </thead>
                                <tbody id="thresholdsTable">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Suggestions Card (visible in MID mode) -->
                    <div class="card mb-4" id="suggestionsCard" style="display: none;">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Sugest√µes de Ajuste</h5>
                        </div>
                        <div class="card-body">
                            <div id="suggestionsList"></div>
                        </div>
                    </div>

                    <!-- History Card -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-history me-2"></i>Hist√≥rico de Ajustes</h5>
                        </div>
                        <div class="card-body">
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Data/Hora</th>
                                            <th>Threshold</th>
                                            <th>Anterior</th>
                                            <th>Novo</th>
                                            <th>Tipo</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="adjustmentHistory">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">Nenhum ajuste registrado</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

    <script>
        // Navigation handling
        document.addEventListener('DOMContentLoaded', function() {
            // Navigation tab switching
            const navLinks = document.querySelectorAll('.nav-link');
            const configSections = document.querySelectorAll('.config-section');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all links and sections
                    navLinks.forEach(l => l.classList.remove('active'));
                    configSections.forEach(s => s.classList.remove('active'));
                    
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    // Show corresponding section
                    const target = this.getAttribute('data-target');
                    document.getElementById(target).classList.add('active');
                });
            });
            
            // Add instance functionality
            document.getElementById('addInstanceBtn').addEventListener('click', function() {
                const input = document.getElementById('newInstanceInput');
                const value = input.value.trim();
                
                if (value) {
                    const instancesList = document.getElementById('instancesList');
                    const instanceDiv = document.createElement('div');
                    instanceDiv.className = 'alert alert-secondary alert-sm d-flex justify-content-between align-items-center mb-2';
                    instanceDiv.innerHTML = `
                        <span>${value}</span>
                        <button class="btn-close" type="button"></button>
                    `;
                    
                    instancesList.appendChild(instanceDiv);
                    input.value = '';
                    
                    // Add remove functionality
                    instanceDiv.querySelector('.btn-close').addEventListener('click', function() {
                        instanceDiv.remove();
                    });
                }
            });
            
            // Test notification button
            document.getElementById('testNotificationBtn').addEventListener('click', function() {
                showToast('Test notification sent successfully!', 'success');
            });
            
            // Save configuration button ‚Äì call API to persist Teams settings
            document.getElementById('saveTeamsConfig').addEventListener('click', async function() {
                try {
                    await saveTeamsConfig();
                    showToast('Teams configuration saved successfully!', 'success');
                } catch (err) {
                    console.error('Failed to save Teams configuration:', err);
                    showToast('Erro ao salvar a configura√ß√£o do Teams.', 'error');
                }
            });
            
            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', function() {
                showToast('Configuration refreshed', 'info');
            });
            
            // Initialize with some sample instances for Teams integration
            const sampleInstances = ['TWS_NAZ', 'TWS_SAZ'];
            const instancesList = document.getElementById('instancesList');
            
            sampleInstances.forEach(instance => {
                const instanceDiv = document.createElement('div');
                instanceDiv.className = 'alert alert-secondary alert-sm d-flex justify-content-between align-items-center mb-2';
                instanceDiv.innerHTML = `
                    <span>${instance}</span>
                    <button class="btn-close" type="button"></button>
                `;
                
                instancesList.appendChild(instanceDiv);
                
                // Add remove functionality
                instanceDiv.querySelector('.btn-close').addEventListener('click', function() {
                    instanceDiv.remove();
                });
            });

            // Event listener for adding TWS instances
            document.getElementById('addTwsInstanceBtn').addEventListener('click', function() {
                const input = document.getElementById('newTwsInstanceInput');
                const value = input.value.trim();
                if (value) {
                    const list = document.getElementById('twsInstancesList');
                    const div = document.createElement('div');
                    div.className = 'alert alert-secondary alert-sm d-flex justify-content-between align-items-center mb-2';
                    div.innerHTML = `<span>${value}</span><button class="btn-close" type="button"></button>`;
                    list.appendChild(div);
                    input.value = '';
                    div.querySelector('.btn-close').addEventListener('click', function() { div.remove(); });
                }
            });

            // Save TWS configuration
            document.getElementById('saveTwsConfig').addEventListener('click', async function() {
                try {
                    await saveTwsConfig();
                    showToast('TWS configuration saved successfully!', 'success');
                } catch (err) {
                    console.error('Failed to save TWS configuration:', err);
                    showToast('Erro ao salvar a configura√ß√£o TWS.', 'error');
                }
            });

            // Save system settings
            document.getElementById('saveSystemSettings').addEventListener('click', async function() {
                try {
                    await saveSystemSettings();
                    showToast('System settings saved successfully!', 'success');
                } catch (err) {
                    console.error('Failed to save system settings:', err);
                    showToast('Erro ao salvar configura√ß√µes de sistema.', 'error');
                }
            });

            // Save notifications
            document.getElementById('saveNotificationsBtn').addEventListener('click', async function() {
                try {
                    await saveNotifications();
                    showToast('Notification settings saved successfully!', 'success');
                } catch (err) {
                    console.error('Failed to save notifications:', err);
                    showToast('Erro ao salvar configura√ß√µes de notifica√ß√µes.', 'error');
                }
            });

            // Load logs
            document.getElementById('loadLogsBtn').addEventListener('click', function() {
                loadLogs();
            });

            // Create backup
            document.getElementById('createBackupBtn').addEventListener('click', function() {
                createBackup();
            });

            // Restore backup
            document.getElementById('restoreBackupBtn').addEventListener('click', function() {
                restoreBackup();
            });

            // Load audit logs
            document.getElementById('loadAuditBtn').addEventListener('click', function() {
                loadAudit();
            });

            // Refresh health status
            document.getElementById('refreshHealthBtn').addEventListener('click', function() {
                loadHealthStatus();
            });

            // Load persisted configuration when the page loads
            loadTeamsConfig();
            loadTwsConfig();
            loadSystemSettings();
            loadNotifications();
            loadHealthStatus();
        });
        
        // Fetch current Teams configuration from the backend and populate form fields
        async function loadTeamsConfig() {
            try {
                const resp = await fetch('/api/v1/admin/teams-config');
                if (!resp.ok) {
                    throw new Error(`Erro HTTP ${resp.status}`);
                }
                const data = await resp.json();
                // Populate the form fields with the returned values
                document.getElementById('teamsEnabled').checked = Boolean(data.enabled);
                document.getElementById('webhookUrl').value = data.webhook_url || '';
                document.getElementById('channelName').value = data.channel_name || '';
                document.getElementById('botName').value = data.bot_name || '';
                document.getElementById('avatarUrl').value = data.avatar_url || '';
            } catch (error) {
                console.error('Failed to load Teams configuration:', error);
                showToast('Erro ao carregar a configura√ß√£o do Teams.', 'error');
            }
        }

        // Save Teams configuration to the backend
        async function saveTeamsConfig() {
            const payload = {
                enabled: document.getElementById('teamsEnabled').checked,
                webhook_url: document.getElementById('webhookUrl').value.trim(),
                channel_name: document.getElementById('channelName').value.trim(),
                bot_name: document.getElementById('botName').value.trim(),
                avatar_url: document.getElementById('avatarUrl').value.trim(),
            };
            const resp = await fetch('/api/v1/admin/teams-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            if (!resp.ok) {
                const detail = await resp.text();
                throw new Error(`Erro ${resp.status}: ${detail}`);
            }
            // HTTP 204 No Content indicates success
        }

        // Load TWS configuration from backend and populate the form
        async function loadTwsConfig() {
            try {
                const resp = await fetch('/api/v1/admin/tws-config');
                if (!resp.ok) {
                    throw new Error(`Erro HTTP ${resp.status}`);
                }
                const data = await resp.json();
                // Set primary instance
                document.getElementById('primaryTwsInstance').value = data.primary_instance || '';
                // Clear existing list
                const list = document.getElementById('twsInstancesList');
                list.innerHTML = '';
                (data.monitored_instances || []).forEach(instance => {
                    const div = document.createElement('div');
                    div.className = 'alert alert-secondary alert-sm d-flex justify-content-between align-items-center mb-2';
                    div.innerHTML = `<span>${instance}</span><button class="btn-close" type="button"></button>`;
                    list.appendChild(div);
                    div.querySelector('.btn-close').addEventListener('click', function() {
                        div.remove();
                    });
                });
            } catch (error) {
                console.error('Failed to load TWS configuration:', error);
                showToast('Erro ao carregar a configura√ß√£o TWS.', 'error');
            }
        }

        // Save TWS configuration to backend
        async function saveTwsConfig() {
            const primary = document.getElementById('primaryTwsInstance').value.trim();
            const list = document.getElementById('twsInstancesList');
            const instances = [];
            list.querySelectorAll('span').forEach(el => {
                const name = el.textContent.trim();
                if (name) instances.push(name);
            });
            const payload = {
                primary_instance: primary,
                monitored_instances: instances
            };
            const resp = await fetch('/api/v1/admin/tws-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!resp.ok) {
                const detail = await resp.text();
                throw new Error(`Erro ${resp.status}: ${detail}`);
            }
        }

        // Load system settings from backend and populate the form
        async function loadSystemSettings() {
            try {
                const resp = await fetch('/api/v1/admin/system-settings');
                if (!resp.ok) throw new Error(`Erro HTTP ${resp.status}`);
                const data = await resp.json();
                // Environment select
                const envSelect = document.getElementById('envSelect');
                envSelect.value = data.environment || 'Production';
                // Debug select
                const debugSelect = document.getElementById('debugSelect');
                debugSelect.value = data.debug_mode ? 'Enabled' : 'Disabled';
                // Toggles
                document.getElementById('sslEnabled').checked = Boolean(data.ssl_enabled);
                document.getElementById('cspEnabled').checked = Boolean(data.csp_enabled);
                document.getElementById('corsEnabled').checked = Boolean(data.cors_enabled);
            } catch (error) {
                console.error('Failed to load system settings:', error);
                showToast('Erro ao carregar configura√ß√µes de sistema.', 'error');
            }
        }

        // Save system settings to backend
        async function saveSystemSettings() {
            const env = document.getElementById('envSelect').value;
            const debugMode = document.getElementById('debugSelect').value === 'Enabled';
            const payload = {
                environment: env,
                debug_mode: debugMode,
                ssl_enabled: document.getElementById('sslEnabled').checked,
                csp_enabled: document.getElementById('cspEnabled').checked,
                cors_enabled: document.getElementById('corsEnabled').checked,
            };
            const resp = await fetch('/api/v1/admin/system-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!resp.ok) {
                const detail = await resp.text();
                throw new Error(`Erro ${resp.status}: ${detail}`);
            }
        }

        // Load notifications settings
        async function loadNotifications() {
            try {
                const resp = await fetch('/api/v1/admin/notifications');
                if (!resp.ok) throw new Error(`Erro HTTP ${resp.status}`);
                const data = await resp.json();
                // Set selected options for job status filters
                const select = document.getElementById('notifStatusFilters');
                const filters = data.job_status_filters || [];
                Array.from(select.options).forEach(opt => {
                    opt.selected = filters.includes(opt.value);
                });
                // Set toggles
                document.getElementById('notifyJobStatus').checked = Boolean(data.notify_job_status);
                document.getElementById('notifyAlerts').checked = Boolean(data.notify_alerts);
                document.getElementById('notifyPerformance').checked = Boolean(data.notify_performance);
            } catch (error) {
                console.error('Failed to load notifications:', error);
                showToast('Erro ao carregar notifica√ß√µes.', 'error');
            }
        }

        // Save notifications settings
        async function saveNotifications() {
            const select = document.getElementById('notifStatusFilters');
            const filters = Array.from(select.options)
                .filter(opt => opt.selected)
                .map(opt => opt.value);
            const payload = {
                job_status_filters: filters,
                notify_job_status: document.getElementById('notifyJobStatus').checked,
                notify_alerts: document.getElementById('notifyAlerts').checked,
                notify_performance: document.getElementById('notifyPerformance').checked,
            };
            const resp = await fetch('/api/v1/admin/notifications', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!resp.ok) {
                const detail = await resp.text();
                throw new Error(`Erro ${resp.status}: ${detail}`);
            }
        }

        // Load logs from backend and display in textarea
        async function loadLogs() {
            const file = document.getElementById('logFileName').value.trim() || 'app.log';
            const lines = parseInt(document.getElementById('logLines').value, 10) || 100;
            try {
                const params = new URLSearchParams({ file, lines: lines.toString() });
                const resp = await fetch(`/api/v1/admin/logs?${params.toString()}`);
                if (!resp.ok) throw new Error(`Erro HTTP ${resp.status}`);
                const data = await resp.json();
                document.getElementById('logContent').textContent = data.content || '';
            } catch (error) {
                console.error('Failed to load logs:', error);
                showToast('Erro ao carregar logs.', 'error');
            }
        }

        // Create a backup via backend
        async function createBackup() {
            try {
                const resp = await fetch('/api/v1/admin/backup', { method: 'POST' });
                if (!resp.ok) throw new Error(`Erro HTTP ${resp.status}`);
                const data = await resp.json();
                document.getElementById('backupStatus').textContent = JSON.stringify(data, null, 2);
                showToast('Backup criado com sucesso!', 'success');
            } catch (error) {
                console.error('Failed to create backup:', error);
                showToast('Erro ao criar backup.', 'error');
            }
        }

        // Restore from latest backup via backend
        async function restoreBackup() {
            try {
                const resp = await fetch('/api/v1/admin/restore', { method: 'POST' });
                if (!resp.ok) throw new Error(`Erro HTTP ${resp.status}`);
                const data = await resp.json();
                document.getElementById('backupStatus').textContent = JSON.stringify(data, null, 2);
                showToast('Restaura√ß√£o conclu√≠da!', 'success');
            } catch (error) {
                console.error('Failed to restore backup:', error);
                showToast('Erro ao restaurar backup.', 'error');
            }
        }

        // Load audit records from backend
        async function loadAudit() {
            try {
                const resp = await fetch('/api/v1/admin/audit');
                if (!resp.ok) throw new Error(`Erro HTTP ${resp.status}`);
                const data = await resp.json();
                const tbody = document.getElementById('auditTableBody');
                tbody.innerHTML = '';
                (data.records || []).forEach((rec, idx) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<th scope="row">${idx + 1}</th><td>${rec.timestamp || rec.time || ''}</td><td>${rec.message || rec.action || JSON.stringify(rec)}</td>`;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Failed to load audit logs:', error);
                showToast('Erro ao carregar logs de auditoria.', 'error');
            }
        }

        // Health monitoring auto-refresh interval
        let healthRefreshInterval = null;

        // Update component card styling based on status
        function updateHealthCard(component, data) {
            const iconEl = document.getElementById(`healthIcon${component}`);
            const statusEl = document.getElementById(`health${component}Status`);
            const latencyEl = document.getElementById(`health${component}Latency`);
            const cardEl = document.getElementById(`healthCard${component}`);
            
            if (!statusEl) return;
            
            const status = data.status || 'unknown';
            const message = data.message || status;
            const latency = data.latency_ms;
            
            // Update status text
            statusEl.textContent = message;
            
            // Update latency if available
            if (latencyEl) {
                latencyEl.textContent = latency ? `${latency.toFixed(1)}ms` : '';
            }
            
            // Update icon color based on status
            if (iconEl) {
                iconEl.classList.remove('text-success', 'text-warning', 'text-danger', 'text-secondary');
                if (status === 'healthy') {
                    iconEl.classList.add('text-success');
                } else if (status === 'degraded') {
                    iconEl.classList.add('text-warning');
                } else if (status === 'unhealthy') {
                    iconEl.classList.add('text-danger');
                } else {
                    iconEl.classList.add('text-secondary');
                }
            }
            
            // Update card border
            if (cardEl) {
                cardEl.classList.remove('border-success', 'border-warning', 'border-danger');
                if (status === 'healthy') {
                    cardEl.classList.add('border-success');
                } else if (status === 'degraded') {
                    cardEl.classList.add('border-warning');
                } else if (status === 'unhealthy') {
                    cardEl.classList.add('border-danger');
                }
            }
        }

        // Load health status from backend and update all cards
        async function loadHealthStatus() {
            try {
                const resp = await fetch('/api/v1/admin/health');
                if (!resp.ok) throw new Error(`Erro HTTP ${resp.status}`);
                const data = await resp.json();
                
                // Update overall status banner
                const banner = document.getElementById('healthOverallBanner');
                const overallStatus = document.getElementById('healthOverallStatus');
                if (banner && overallStatus) {
                    banner.classList.remove('alert-success', 'alert-warning', 'alert-danger');
                    if (data.overall_status === 'healthy') {
                        banner.classList.add('alert-success');
                        overallStatus.textContent = 'All systems operational';
                    } else if (data.overall_status === 'degraded') {
                        banner.classList.add('alert-warning');
                        overallStatus.textContent = 'Some components degraded';
                    } else {
                        banner.classList.add('alert-danger');
                        overallStatus.textContent = 'System issues detected';
                    }
                }
                
                // Update individual component cards
                const components = data.components || {};
                
                // Map backend component names to frontend IDs
                const componentMap = {
                    'database': 'Database',
                    'redis': 'Redis',
                    'llm': 'LLM',
                    'rag': 'RAG',
                    'teams': 'Teams',
                    'tws': 'TWS'
                };
                
                for (const [backendName, frontendName] of Object.entries(componentMap)) {
                    if (components[backendName]) {
                        updateHealthCard(frontendName, components[backendName]);
                    }
                }
                
                // Update last check timestamp
                const lastCheckEl = document.getElementById('healthLastCheck');
                if (lastCheckEl) {
                    lastCheckEl.textContent = new Date().toLocaleTimeString();
                }
                
            } catch (error) {
                console.error('Failed to load health status:', error);
                showToast('Erro ao carregar status de sa√∫de.', 'error');
            }
        }
        
        // Refresh health status (called by button)
        function refreshHealthStatus() {
            loadHealthStatus();
            showToast('Health status refreshed', 'info');
        }
        
        // Setup auto-refresh for health monitoring
        function setupHealthAutoRefresh() {
            const checkbox = document.getElementById('healthAutoRefresh');
            if (!checkbox) return;
            
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    healthRefreshInterval = setInterval(loadHealthStatus, 30000);
                } else {
                    if (healthRefreshInterval) {
                        clearInterval(healthRefreshInterval);
                        healthRefreshInterval = null;
                    }
                }
            });
            
            // Start auto-refresh if checked by default
            if (checkbox.checked) {
                healthRefreshInterval = setInterval(loadHealthStatus, 30000);
            }
        }
        
        // Initialize health auto-refresh on page load
        document.addEventListener('DOMContentLoaded', setupHealthAutoRefresh);

        // Toast notification function
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type} show`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="toast-header">
                    <strong class="me-auto">
                        ${type === 'success' ? '<i class="fas fa-check-circle me-1"></i>' : ''}
                        ${type === 'error' ? '<i class="fas fa-exclamation-circle me-1"></i>' : ''}
                        ${type === 'warning' ? '<i class="fas fa-exclamation-triangle me-1"></i>' : ''}
                        ${type === 'info' ? '<i class="fas fa-info-circle me-1"></i>' : ''}
                        Notification
                    </strong>
                    <small>Just now</small>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/admin.js"></script>
    
    <!-- System Config Module - Neumorphic -->
    <script>
    const SystemConfig = {
        categories: [],
        originalValues: {},
        currentValues: {},
        changedFields: new Set(),
        initialized: false,
        
        async init() {
            if (this.initialized) return;
            this.initialized = true;
            
            await this.loadCategories();
            this.renderTabs();
            this.renderContent();
            this.bindEvents();
            this.refreshResources();
            
            // Auto-refresh resources every 10 seconds
            setInterval(() => this.refreshResources(), 10000);
        },
        
        async loadCategories() {
            try {
                const response = await fetch('/api/v1/system-config/categories', {
                    headers: {
                        'Authorization': 'Basic ' + btoa(adminCredentials || 'admin:admin'),
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load configuration');
                
                this.categories = await response.json();
                
                // Store original values
                this.categories.forEach(cat => {
                    cat.fields.forEach(field => {
                        this.originalValues[field.name] = field.value;
                        this.currentValues[field.name] = field.value;
                    });
                });
                
            } catch (error) {
                console.error('Error loading config:', error);
                showToast('Failed to load configuration', 'error');
            }
        },
        
        renderTabs() {
            const tabsContainer = document.getElementById('configCategoryTabs');
            if (!tabsContainer || !this.categories.length) return;
            
            tabsContainer.innerHTML = this.categories.map((cat, index) => `
                <li class="nav-item" role="presentation">
                    <button class="nav-link ${index === 0 ? 'active' : ''}" 
                            id="tab-${cat.name}" 
                            data-bs-toggle="pill" 
                            data-bs-target="#content-${cat.name}" 
                            type="button" 
                            role="tab">
                        <i class="fas ${cat.icon}"></i>
                        <span class="d-none d-md-inline ms-2">${cat.display_name}</span>
                    </button>
                </li>
            `).join('');
        },
        
        renderContent() {
            const contentContainer = document.getElementById('configTabContent');
            if (!contentContainer || !this.categories.length) return;
            
            contentContainer.innerHTML = this.categories.map((cat, index) => `
                <div class="tab-pane fade ${index === 0 ? 'show active' : ''}" 
                     id="content-${cat.name}" 
                     role="tabpanel">
                    <div class="config-card">
                        <div class="config-card-header">
                            <div>
                                <h5 class="config-card-title">
                                    <i class="fas ${cat.icon} me-2"></i>${cat.display_name}
                                </h5>
                                <p class="config-card-description">${cat.description}</p>
                            </div>
                        </div>
                        <div class="config-fields">
                            ${cat.fields.map(field => this.renderField(field)).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        },
        
        renderField(field) {
            const restartBadge = field.requires_restart 
                ? '<span class="restart-badge">Requires Restart</span>' 
                : '';
            
            return `
                <div class="config-field" data-field="${field.name}">
                    <div class="config-field-info">
                        <div class="config-field-name">
                            ${this.formatFieldName(field.name)}
                            ${restartBadge}
                        </div>
                        <div class="config-field-desc">${field.description || ''}</div>
                    </div>
                    <div class="config-field-control">
                        ${this.renderControl(field)}
                    </div>
                </div>
            `;
        },
        
        renderControl(field) {
            switch (field.type) {
                case 'bool':
                    return `
                        <label class="config-toggle">
                            <input type="checkbox" 
                                   data-field="${field.name}"
                                   ${field.value ? 'checked' : ''}
                                   onchange="SystemConfig.handleChange('${field.name}', this.checked)">
                            <span class="config-toggle-slider"></span>
                        </label>
                    `;
                
                case 'string':
                    if (field.options && field.options.length > 0) {
                        return `
                            <select class="config-select" 
                                    data-field="${field.name}"
                                    onchange="SystemConfig.handleChange('${field.name}', this.value)">
                                ${field.options.map(opt => `
                                    <option value="${opt}" ${opt === field.value ? 'selected' : ''}>${opt}</option>
                                `).join('')}
                            </select>
                        `;
                    }
                    return `
                        <input type="text" 
                               class="config-input" 
                               data-field="${field.name}"
                               value="${field.value || ''}"
                               onchange="SystemConfig.handleChange('${field.name}', this.value)">
                    `;
                
                case 'int':
                case 'float':
                    const step = field.type === 'float' ? '0.1' : '1';
                    const min = field.min_value !== null ? `min="${field.min_value}"` : '';
                    const max = field.max_value !== null ? `max="${field.max_value}"` : '';
                    
                    return `
                        <input type="number" 
                               class="config-input" 
                               data-field="${field.name}"
                               value="${field.value}"
                               step="${step}"
                               ${min} ${max}
                               onchange="SystemConfig.handleChange('${field.name}', this.value)">
                    `;
                
                default:
                    return `<span class="text-muted">${field.value}</span>`;
            }
        },
        
        formatFieldName(name) {
            return name
                .replace(/_/g, ' ')
                .replace(/\b\w/g, c => c.toUpperCase())
                .replace(/Tws/g, 'TWS')
                .replace(/Llm/g, 'LLM')
                .replace(/Rag/g, 'RAG')
                .replace(/Db/g, 'DB')
                .replace(/Mb/g, 'MB');
        },
        
        handleChange(fieldName, newValue) {
            const field = this.findField(fieldName);
            if (field) {
                if (field.type === 'int') newValue = parseInt(newValue);
                if (field.type === 'float') newValue = parseFloat(newValue);
            }
            
            this.currentValues[fieldName] = newValue;
            
            if (newValue !== this.originalValues[fieldName]) {
                this.changedFields.add(fieldName);
            } else {
                this.changedFields.delete(fieldName);
            }
            
            this.updateFieldUI(fieldName);
            this.updateSaveBar();
        },
        
        findField(name) {
            for (const cat of this.categories) {
                for (const field of cat.fields) {
                    if (field.name === name) return field;
                }
            }
            return null;
        },
        
        updateFieldUI(fieldName) {
            const input = document.querySelector(`[data-field="${fieldName}"]`);
            if (input) {
                if (this.changedFields.has(fieldName)) {
                    input.classList.add('changed');
                } else {
                    input.classList.remove('changed');
                }
            }
        },
        
        updateSaveBar() {
            const saveBar = document.getElementById('saveBar');
            const changesCount = document.getElementById('changesCount');
            const restartWarning = document.getElementById('restartWarning');
            
            if (this.changedFields.size > 0) {
                saveBar.style.display = 'block';
                changesCount.textContent = this.changedFields.size;
                
                let needsRestart = false;
                this.changedFields.forEach(name => {
                    const field = this.findField(name);
                    if (field && field.requires_restart) needsRestart = true;
                });
                restartWarning.style.display = needsRestart ? 'inline' : 'none';
            } else {
                saveBar.style.display = 'none';
            }
        },
        
        discardChanges() {
            this.changedFields.forEach(name => {
                const input = document.querySelector(`[data-field="${name}"]`);
                if (input) {
                    if (input.type === 'checkbox') {
                        input.checked = this.originalValues[name];
                    } else {
                        input.value = this.originalValues[name];
                    }
                    input.classList.remove('changed');
                }
                this.currentValues[name] = this.originalValues[name];
            });
            
            this.changedFields.clear();
            this.updateSaveBar();
            showToast('Changes discarded', 'info');
        },
        
        async saveAllChanges() {
            if (this.changedFields.size === 0) return;
            
            const updates = {};
            this.changedFields.forEach(name => {
                updates[name] = this.currentValues[name];
            });
            
            try {
                const response = await fetch('/api/v1/system-config/update', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa(adminCredentials || 'admin:admin'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ updates })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    result.updated_fields.forEach(name => {
                        this.originalValues[name] = this.currentValues[name];
                        const input = document.querySelector(`[data-field="${name}"]`);
                        if (input) input.classList.remove('changed');
                    });
                    
                    this.changedFields.clear();
                    this.updateSaveBar();
                    
                    let message = `${result.updated_fields.length} setting(s) saved`;
                    if (result.requires_restart) {
                        message += '. Restart required for some changes.';
                        showToast(message, 'warning');
                    } else {
                        showToast(message, 'success');
                    }
                } else {
                    throw new Error(result.message || 'Update failed');
                }
                
            } catch (error) {
                console.error('Save error:', error);
                showToast('Failed to save changes: ' + error.message, 'error');
            }
        },
        
        async refreshResources() {
            try {
                const response = await fetch('/api/v1/system-config/resources', {
                    headers: {
                        'Authorization': 'Basic ' + btoa(adminCredentials || 'admin:admin')
                    }
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                
                const cpuBar = document.getElementById('cpuBar');
                const memoryBar = document.getElementById('memoryBar');
                const diskBar = document.getElementById('diskBar');
                
                if (cpuBar) {
                    cpuBar.style.width = `${data.cpu_percent}%`;
                    document.getElementById('cpuValue').textContent = `${data.cpu_percent}%`;
                }
                
                if (memoryBar) {
                    memoryBar.style.width = `${data.memory_percent}%`;
                    document.getElementById('memoryValue').textContent = `${Math.round(data.memory_used_mb)} MB`;
                }
                
                if (diskBar) {
                    diskBar.style.width = `${data.disk_percent}%`;
                    document.getElementById('diskValue').textContent = `${data.disk_percent}%`;
                }
                
            } catch (error) {
                console.error('Failed to refresh resources:', error);
            }
        },
        
        async triggerGC() {
            try {
                const response = await fetch('/api/v1/system-config/gc', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa(adminCredentials || 'admin:admin')
                    }
                });
                
                const result = await response.json();
                showToast(`GC complete: ${result.objects_collected} objects collected, ${result.memory_freed_mb}MB freed`, 'success');
                this.refreshResources();
                
            } catch (error) {
                showToast('Failed to trigger GC', 'error');
            }
        },
        
        bindEvents() {
            document.querySelectorAll('#configCategoryTabs button').forEach(button => {
                button.addEventListener('shown.bs.tab', () => {
                    // Could load additional data here if needed
                });
            });
        }
    };
    
    // Initialize when System Config section is shown
    document.querySelector('[data-target="system-config"]')?.addEventListener('click', () => {
        setTimeout(() => SystemConfig.init(), 100);
    });
    </script>
    
    <!-- LiteLLM Admin Module -->
    <script>
    const LiteLLMAdmin = {
        data: null,
        costChart: null,
        modelCostChart: null,
        initialized: false,
        
        async init() {
            if (this.initialized) return;
            this.initialized = true;
            
            await this.loadData();
            this.initCharts();
            this.bindEvents();
            
            // Auto-refresh every 30 seconds
            setInterval(() => this.loadData(), 30000);
        },
        
        async loadData() {
            try {
                const response = await fetch('/api/v1/litellm/dashboard-data', {
                    headers: { 'Authorization': 'Basic ' + btoa(adminCredentials || 'admin:admin') }
                });
                
                if (!response.ok) throw new Error('Failed to load');
                
                this.data = await response.json();
                this.updateUI();
                
            } catch (error) {
                console.error('LiteLLM data error:', error);
            }
        },
        
        updateUI() {
            if (!this.data) return;
            
            const { status, usage, costs, providers } = this.data;
            
            // Router status - Neumorphic
            const routerStatus = document.getElementById('litellmRouterStatus');
            const routerIndicator = document.getElementById('routerIndicator');
            if (routerStatus) {
                if (status.router_available) {
                    routerStatus.textContent = 'Online';
                    if (routerIndicator) routerIndicator.className = 'status-indicator online';
                } else {
                    routerStatus.textContent = 'Offline';
                    if (routerIndicator) routerIndicator.className = 'status-indicator offline';
                }
            }
            
            // Stats
            const modelCount = document.getElementById('litellmModelCount');
            const todayCost = document.getElementById('litellmTodayCost');
            const totalRequests = document.getElementById('litellmTotalRequests');
            
            if (modelCount) modelCount.textContent = this.data.models_count || 0;
            if (todayCost) todayCost.textContent = '$' + usage.cost_today_usd.toFixed(2);
            if (totalRequests) totalRequests.textContent = this.formatNumber(usage.total_requests);
            
            // Budget - Neumorphic
            const budgetUsed = document.getElementById('litellmBudgetUsed');
            const budgetLimit = document.getElementById('litellmBudgetLimit');
            const projectedCost = document.getElementById('litellmProjectedCost');
            const budgetBar = document.getElementById('litellmBudgetBar');
            const budgetAlert = document.getElementById('litellmBudgetAlert');
            
            if (budgetUsed) budgetUsed.textContent = '$' + costs.total_cost_usd.toFixed(2);
            if (budgetLimit) budgetLimit.textContent = '$' + costs.budget_limit_usd.toFixed(2);
            if (projectedCost) projectedCost.textContent = '$' + costs.projected_monthly_cost.toFixed(2);
            
            if (budgetBar) {
                const budgetPercent = Math.min(costs.budget_used_percent, 100);
                budgetBar.style.width = budgetPercent + '%';
                // Apply neumorphic classes
                if (budgetPercent >= 90) {
                    budgetBar.className = 'budget-fill danger';
                } else if (budgetPercent >= 70) {
                    budgetBar.className = 'budget-fill warning';
                } else {
                    budgetBar.className = 'budget-fill';
                }
            }
            
            if (budgetAlert) {
                budgetAlert.style.display = costs.budget_used_percent > 70 ? 'inline' : 'none';
            }
            
            // Usage stats
            const statRequests = document.getElementById('litellmStatRequests');
            const statInputTokens = document.getElementById('litellmStatInputTokens');
            const statOutputTokens = document.getElementById('litellmStatOutputTokens');
            const statLatency = document.getElementById('litellmStatLatency');
            const statErrorRate = document.getElementById('litellmStatErrorRate');
            const statTotalCost = document.getElementById('litellmStatTotalCost');
            
            if (statRequests) statRequests.textContent = this.formatNumber(usage.total_requests);
            if (statInputTokens) statInputTokens.textContent = this.formatNumber(usage.total_input_tokens);
            if (statOutputTokens) statOutputTokens.textContent = this.formatNumber(usage.total_output_tokens);
            if (statLatency) statLatency.textContent = Math.round(usage.avg_response_time_ms) + 'ms';
            if (statErrorRate) statErrorRate.textContent = (usage.error_rate * 100).toFixed(1) + '%';
            if (statTotalCost) statTotalCost.textContent = '$' + usage.total_cost_usd.toFixed(2);
            
            // Render providers
            this.renderProviders(providers);
            
            // Update charts
            this.updateCharts();
        },
        
        renderProviders(providers) {
            const grid = document.getElementById('litellmProvidersGrid');
            if (!grid) return;
            
            const providerStyles = {
                'OpenAI': { icon: 'fa-robot', class: 'openai' },
                'Anthropic': { icon: 'fa-brain', class: 'anthropic' },
                'Ollama (Local)': { icon: 'fa-home', class: 'ollama' },
                'Together AI': { icon: 'fa-layer-group', class: 'together' },
                'NVIDIA NIM': { icon: 'fa-microchip', class: 'nvidia' },
                'OpenRouter': { icon: 'fa-random', class: 'openrouter' }
            };
            
            grid.innerHTML = providers.map(p => {
                const style = providerStyles[p.name] || { icon: 'fa-cloud', class: '' };
                const statusClass = p.configured ? 'active' : 'inactive';
                const statusText = p.configured ? 'Configured' : 'Not Configured';
                
                return `
                <div class="col-md-4 mb-3">
                    <div class="provider-card ${!p.configured ? 'disabled' : ''}">
                        <div class="provider-header">
                            <div class="provider-logo ${style.class}">
                                <i class="fas ${style.icon}"></i>
                            </div>
                            <span class="provider-name">${p.name}</span>
                            <span class="provider-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="provider-models">
                            <strong>Models:</strong> ${p.models_available.slice(0, 3).join(', ')}
                            ${p.models_available.length > 3 ? `+${p.models_available.length - 3} more` : ''}
                        </div>
                    </div>
                </div>
            `;
            `).join('');
        },
        
        async refreshModels() {
            try {
                const response = await fetch('/api/v1/litellm/models', {
                    headers: { 'Authorization': 'Basic ' + btoa(adminCredentials || 'admin:admin') }
                });
                
                if (!response.ok) return;
                
                const models = await response.json();
                const grid = document.getElementById('litellmModelsGrid');
                if (!grid) return;
                
                grid.innerHTML = models.map(m => `
                    <div class="model-card" data-provider="${m.provider}" data-local="${m.is_local}">
                        <div class="model-header">
                            <span class="model-name">${m.name}</span>
                            <span class="model-provider">${m.provider}</span>
                        </div>
                        <div class="model-details">
                            <div>Max tokens: ${m.max_tokens ? this.formatNumber(m.max_tokens) : 'N/A'}</div>
                            <div>Type: ${m.model_type || 'chat'}</div>
                        </div>
                        <div class="model-cost">
                            ${m.is_local ? 
                                '<span class="free"><i class="fas fa-check me-1"></i>Free (Local)</span>' :
                                `<span>In: $${m.input_cost_per_1k}/1K</span>
                                 <span>Out: $${m.output_cost_per_1k}/1K</span>`
                            }
                        </div>
                        <div class="model-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="LiteLLMAdmin.testModel('${m.name}')">
                                <i class="fas fa-flask me-1"></i>Test
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Failed to load models:', error);
            }
        },
        
        initCharts() {
            // Daily cost chart
            const costCtx = document.getElementById('litellmCostChart')?.getContext('2d');
            if (costCtx) {
                this.costChart = new Chart(costCtx, {
                    type: 'line',
                    data: { labels: [], datasets: [{ label: 'Daily Cost ($)', data: [], borderColor: '#667eea', fill: true, backgroundColor: 'rgba(102, 126, 234, 0.1)' }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }
            
            // Model cost chart
            const modelCtx = document.getElementById('litellmModelCostChart')?.getContext('2d');
            if (modelCtx) {
                this.modelCostChart = new Chart(modelCtx, {
                    type: 'doughnut',
                    data: { labels: [], datasets: [{ data: [], backgroundColor: ['#667eea', '#764ba2', '#48c774', '#ffb347', '#f66d9b'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            }
        },
        
        updateCharts() {
            if (!this.data) return;
            const { costs } = this.data;
            
            if (this.costChart && costs.daily_costs) {
                const labels = Object.keys(costs.daily_costs).slice(-7);
                const data = labels.map(d => costs.daily_costs[d]);
                this.costChart.data.labels = labels;
                this.costChart.data.datasets[0].data = data;
                this.costChart.update();
            }
            
            if (this.modelCostChart && costs.model_costs) {
                this.modelCostChart.data.labels = Object.keys(costs.model_costs);
                this.modelCostChart.data.datasets[0].data = Object.values(costs.model_costs);
                this.modelCostChart.update();
            }
        },
        
        testModel(modelName) {
            document.getElementById('testModelName').value = modelName;
            document.getElementById('testModelResult').style.display = 'none';
            new bootstrap.Modal(document.getElementById('testModelModal')).show();
        },
        
        async runTest() {
            const model = document.getElementById('testModelName').value;
            const prompt = document.getElementById('testModelPrompt').value;
            const resultDiv = document.getElementById('testModelResult');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'alert alert-info';
            resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
            
            try {
                const response = await fetch('/api/v1/litellm/test', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa(adminCredentials || 'admin:admin'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ model, prompt })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.className = 'alert alert-success';
                    resultDiv.innerHTML = `<i class="fas fa-check-circle me-2"></i><strong>Success!</strong><br>
                        <small>Response: ${result.response}</small><br>
                        <small>Latency: ${Math.round(result.latency_ms)}ms</small>`;
                } else {
                    resultDiv.className = 'alert alert-danger';
                    resultDiv.innerHTML = `<i class="fas fa-times-circle me-2"></i><strong>Failed</strong><br>
                        <small>Error: ${result.error}</small>`;
                }
            } catch (error) {
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = `<i class="fas fa-times-circle me-2"></i>Error: ${error.message}`;
            }
        },
        
        async saveRouting() {
            const config = {
                LLM_ROUTING_ENABLED: document.getElementById('litellmRoutingEnabled').checked,
                LLM_ROUTING_SIMPLE_MODEL: document.getElementById('litellmSimpleModel').value,
                LLM_ROUTING_COMPLEX_MODEL: document.getElementById('litellmComplexModel').value,
                LLM_ROUTING_FALLBACK_MODEL: document.getElementById('litellmFallbackModel').value,
                LLM_PREFER_LOCAL_MODELS: document.getElementById('litellmPreferLocal').checked
            };
            
            try {
                const response = await fetch('/api/v1/system-config/update', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa(adminCredentials || 'admin:admin'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ updates: config })
                });
                
                const result = await response.json();
                showToast(result.success ? 'Routing configuration saved!' : 'Failed to save', result.success ? 'success' : 'error');
                
            } catch (error) {
                showToast('Error saving configuration', 'error');
            }
        },
        
        bindEvents() {
            // Model search filter
            document.getElementById('litellmModelSearch')?.addEventListener('input', (e) => {
                const search = e.target.value.toLowerCase();
                document.querySelectorAll('#litellmModelsGrid > div').forEach(card => {
                    const name = card.querySelector('h6')?.textContent.toLowerCase() || '';
                    card.style.display = name.includes(search) ? '' : 'none';
                });
            });
            
            // Provider filter
            document.getElementById('litellmProviderFilter')?.addEventListener('change', (e) => {
                const provider = e.target.value.toLowerCase();
                document.querySelectorAll('#litellmModelsGrid > div').forEach(card => {
                    const cardProvider = card.dataset.provider?.toLowerCase() || '';
                    card.style.display = !provider || cardProvider === provider ? '' : 'none';
                });
            });
            
            // Local only filter
            document.getElementById('litellmLocalOnly')?.addEventListener('change', (e) => {
                const localOnly = e.target.checked;
                document.querySelectorAll('#litellmModelsGrid > div').forEach(card => {
                    const isLocal = card.dataset.local === 'true';
                    card.style.display = !localOnly || isLocal ? '' : 'none';
                });
            });
        },
        
        formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }
    };
    
    // Initialize when LiteLLM section is shown
    document.querySelector('[data-target="litellm-config"]')?.addEventListener('click', () => {
        setTimeout(() => {
            LiteLLMAdmin.init();
            LiteLLMAdmin.refreshModels();
        }, 100);
    });
    
    // ===========================================
    // TWS Instances Admin Module
    // ===========================================
    const TWSInstancesAdmin = {
        instances: [],
        
        async init() {
            await this.refresh();
        },
        
        async refresh() {
            try {
                const response = await fetch('/api/v1/admin/tws-instances');
                const data = await response.json();
                this.instances = data.instances || [];
                this.updateUI();
            } catch (error) {
                console.error('Failed to load TWS instances:', error);
                this.showError('Failed to load TWS instances');
            }
        },
        
        updateUI() {
            // Update counts
            const connected = this.instances.filter(i => i.status === 'connected').length;
            const errors = this.instances.filter(i => i.status === 'error').length;
            const pending = this.instances.filter(i => i.status === 'connecting').length;
            
            document.getElementById('tws-total-instances').textContent = this.instances.length;
            document.getElementById('tws-connected-count').textContent = connected;
            document.getElementById('tws-pending-count').textContent = pending;
            document.getElementById('tws-error-count').textContent = errors;
            document.getElementById('tws-instance-count').textContent = this.instances.length;
            
            // Update table
            const tbody = document.getElementById('tws-instances-table');
            
            if (this.instances.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-muted">
                            <i class="fas fa-server me-2"></i>No TWS instances configured.
                            <a href="#" data-bs-toggle="modal" data-bs-target="#addTWSInstanceModal">Add one now</a>
                        </td>
                    </tr>`;
                return;
            }
            
            tbody.innerHTML = this.instances.map(inst => {
                const statusBadge = this.getStatusBadge(inst.status);
                const envBadge = this.getEnvBadge(inst.environment);
                
                return `
                    <tr>
                        <td>
                            <span class="d-inline-block rounded-circle" 
                                  style="width: 12px; height: 12px; background-color: ${inst.color || '#3b82f6'}">
                            </span>
                        </td>
                        <td>
                            <strong>${inst.name}</strong>
                            <br><small class="text-muted">${inst.display_name}</small>
                        </td>
                        <td><code>${inst.host}:${inst.port}</code></td>
                        <td>${envBadge}</td>
                        <td>${statusBadge}</td>
                        <td>
                            ${inst.learning_enabled 
                                ? '<span class="badge bg-success"><i class="fas fa-brain me-1"></i>Active</span>' 
                                : '<span class="badge bg-secondary">Disabled</span>'}
                        </td>
                        <td class="text-end">
                            <div class="btn-group btn-group-sm">
                                ${inst.status === 'connected' 
                                    ? `<button class="btn btn-outline-warning" onclick="TWSInstancesAdmin.disconnect('${inst.id}')" title="Disconnect">
                                         <i class="fas fa-unlink"></i>
                                       </button>`
                                    : `<button class="btn btn-outline-success" onclick="TWSInstancesAdmin.connect('${inst.id}')" title="Connect">
                                         <i class="fas fa-plug"></i>
                                       </button>`
                                }
                                <button class="btn btn-outline-info" onclick="TWSInstancesAdmin.test('${inst.id}')" title="Test">
                                    <i class="fas fa-vial"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="TWSInstancesAdmin.edit('${inst.id}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="TWSInstancesAdmin.delete('${inst.id}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
            }).join('');
        },
        
        getStatusBadge(status) {
            const badges = {
                'connected': '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Connected</span>',
                'disconnected': '<span class="badge bg-secondary"><i class="fas fa-times me-1"></i>Disconnected</span>',
                'connecting': '<span class="badge bg-warning"><i class="fas fa-spinner fa-spin me-1"></i>Connecting</span>',
                'error': '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>Error</span>',
            };
            return badges[status] || badges['disconnected'];
        },
        
        getEnvBadge(env) {
            const badges = {
                'production': '<span class="badge bg-danger">PROD</span>',
                'staging': '<span class="badge bg-warning text-dark">STAGING</span>',
                'development': '<span class="badge bg-info">DEV</span>',
                'dr': '<span class="badge bg-purple" style="background-color:#8b5cf6;">DR</span>',
            };
            return badges[env] || `<span class="badge bg-secondary">${env}</span>`;
        },
        
        async addInstance() {
            const instance = {
                name: document.getElementById('tws-new-name').value.toUpperCase(),
                display_name: document.getElementById('tws-new-display-name').value,
                host: document.getElementById('tws-new-host').value,
                port: parseInt(document.getElementById('tws-new-port').value) || 31116,
                username: document.getElementById('tws-new-username').value,
                password: document.getElementById('tws-new-password').value,
                environment: document.getElementById('tws-new-environment').value,
                color: document.getElementById('tws-new-color').value,
                ssl_enabled: document.getElementById('tws-new-ssl').checked,
                learning_enabled: document.getElementById('tws-new-learning').checked,
                description: document.getElementById('tws-new-description').value,
            };
            
            if (!instance.name || !instance.display_name || !instance.host) {
                this.showError('Please fill in all required fields');
                return;
            }
            
            try {
                const response = await fetch('/api/v1/admin/tws-instances', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(instance),
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    this.showSuccess(`Instance '${instance.name}' created successfully`);
                    bootstrap.Modal.getInstance(document.getElementById('addTWSInstanceModal')).hide();
                    document.getElementById('addTWSInstanceForm').reset();
                    await this.refresh();
                } else {
                    this.showError(result.detail || 'Failed to create instance');
                }
            } catch (error) {
                this.showError('Failed to create instance: ' + error.message);
            }
        },
        
        async connect(instanceId) {
            try {
                const response = await fetch(`/api/v1/admin/tws-instances/${instanceId}/connect`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    this.showSuccess('Connected successfully');
                } else {
                    this.showError(result.message || 'Connection failed');
                }
                await this.refresh();
            } catch (error) {
                this.showError('Connection failed: ' + error.message);
            }
        },
        
        async disconnect(instanceId) {
            try {
                await fetch(`/api/v1/admin/tws-instances/${instanceId}/disconnect`, { method: 'POST' });
                this.showSuccess('Disconnected');
                await this.refresh();
            } catch (error) {
                this.showError('Disconnect failed: ' + error.message);
            }
        },
        
        async test(instanceId) {
            try {
                const response = await fetch(`/api/v1/admin/tws-instances/${instanceId}/test`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    this.showSuccess(`Connection test successful (${result.latency_ms}ms)`);
                } else {
                    this.showError(`Connection test failed: ${result.error}`);
                }
            } catch (error) {
                this.showError('Test failed: ' + error.message);
            }
        },
        
        edit(instanceId) {
            const inst = this.instances.find(i => i.id === instanceId);
            if (!inst) return;
            
            document.getElementById('tws-edit-id').value = inst.id;
            document.getElementById('tws-edit-name').value = inst.name;
            document.getElementById('tws-edit-display-name').value = inst.display_name;
            document.getElementById('tws-edit-host').value = inst.host;
            document.getElementById('tws-edit-port').value = inst.port;
            document.getElementById('tws-edit-environment').value = inst.environment;
            document.getElementById('tws-edit-color').value = inst.color || '#3b82f6';
            document.getElementById('tws-edit-enabled').checked = inst.enabled !== false;
            document.getElementById('tws-edit-learning').checked = inst.learning_enabled !== false;
            
            new bootstrap.Modal(document.getElementById('editTWSInstanceModal')).show();
        },
        
        async saveInstance() {
            const instanceId = document.getElementById('tws-edit-id').value;
            const updates = {
                display_name: document.getElementById('tws-edit-display-name').value,
                host: document.getElementById('tws-edit-host').value,
                port: parseInt(document.getElementById('tws-edit-port').value),
                environment: document.getElementById('tws-edit-environment').value,
                color: document.getElementById('tws-edit-color').value,
                enabled: document.getElementById('tws-edit-enabled').checked,
                learning_enabled: document.getElementById('tws-edit-learning').checked,
            };
            
            try {
                const response = await fetch(`/api/v1/admin/tws-instances/${instanceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates),
                });
                
                if (response.ok) {
                    this.showSuccess('Instance updated successfully');
                    bootstrap.Modal.getInstance(document.getElementById('editTWSInstanceModal')).hide();
                    await this.refresh();
                } else {
                    const result = await response.json();
                    this.showError(result.detail || 'Update failed');
                }
            } catch (error) {
                this.showError('Update failed: ' + error.message);
            }
        },
        
        async delete(instanceId) {
            const inst = this.instances.find(i => i.id === instanceId);
            if (!inst) return;
            
            if (!confirm(`Are you sure you want to delete instance '${inst.name}'?\nThis will also delete all learning data for this instance.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/v1/admin/tws-instances/${instanceId}`, { method: 'DELETE' });
                
                if (response.ok) {
                    this.showSuccess(`Instance '${inst.name}' deleted`);
                    await this.refresh();
                } else {
                    const result = await response.json();
                    this.showError(result.detail || 'Delete failed');
                }
            } catch (error) {
                this.showError('Delete failed: ' + error.message);
            }
        },
        
        async connectAll() {
            try {
                const response = await fetch('/api/v1/admin/tws-instances/bulk/connect', { method: 'POST' });
                const result = await response.json();
                this.showSuccess(`Connected: ${result.connected}, Failed: ${result.failed}`);
                await this.refresh();
            } catch (error) {
                this.showError('Bulk connect failed: ' + error.message);
            }
        },
        
        async disconnectAll() {
            if (!confirm('Disconnect from all TWS instances?')) return;
            
            try {
                await fetch('/api/v1/admin/tws-instances/bulk/disconnect', { method: 'POST' });
                this.showSuccess('All instances disconnected');
                await this.refresh();
            } catch (error) {
                this.showError('Bulk disconnect failed: ' + error.message);
            }
        },
        
        async testNewConnection() {
            // TODO: Implement test for new connection before saving
            this.showSuccess('Connection test not yet implemented for new instances');
        },
        
        showSuccess(message) {
            // Use the existing toast mechanism or create alert
            alert('‚úÖ ' + message);
        },
        
        showError(message) {
            alert('‚ùå ' + message);
        }
    };
    
    // Initialize when TWS Configuration section is shown
    document.querySelector('[data-target="tws-config"]')?.addEventListener('click', () => {
        setTimeout(() => TWSInstancesAdmin.init(), 100);
    });
    
    // Also update sidebar badge when instances change
    TWSInstancesAdmin.updateSidebarBadge = function() {
        const sidebarBadge = document.getElementById('tws-sidebar-count');
        if (sidebarBadge) {
            sidebarBadge.textContent = this.instances.length;
        }
    };
    
    // Patch updateUI to also update sidebar badge
    const originalUpdateUI = TWSInstancesAdmin.updateUI;
    TWSInstancesAdmin.updateUI = function() {
        originalUpdateUI.call(this);
        this.updateSidebarBadge();
    };

    // =============================================================================
    // BACKUP ADMIN
    // =============================================================================
    const BackupAdmin = {
        async init() {
            await this.loadStats();
            await this.loadBackups();
            await this.loadSchedules();
        },
        
        async loadStats() {
            try {
                const response = await fetch('/api/v1/admin/backup/stats');
                const stats = await response.json();
                
                document.getElementById('backupTotalCount').textContent = stats.total_backups || 0;
                document.getElementById('backupTotalSize').textContent = this.formatSize(stats.total_size_bytes || 0);
                document.getElementById('backupScheduleCount').textContent = stats.active_schedules || 0;
                
                if (stats.last_backup_at) {
                    const date = new Date(stats.last_backup_at);
                    document.getElementById('backupLastDate').textContent = date.toLocaleDateString('pt-BR');
                }
            } catch (error) {
                console.error('Error loading backup stats:', error);
            }
        },
        
        async loadBackups() {
            try {
                const filter = document.getElementById('backupTypeFilter')?.value || '';
                const url = `/api/v1/admin/backup/list?limit=50${filter ? '&backup_type=' + filter : ''}`;
                const response = await fetch(url);
                const data = await response.json();
                
                const tbody = document.getElementById('backupsTableBody');
                if (!data.backups || data.backups.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum backup encontrado</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.backups.map(backup => `
                    <tr>
                        <td><code class="small">${backup.filename || backup.file_path?.split('/').pop()}</code></td>
                        <td><span class="badge ${this.getTypeBadge(backup.backup_type)}">${this.formatType(backup.backup_type)}</span></td>
                        <td>${this.formatSize(backup.size_bytes)}</td>
                        <td>${new Date(backup.created_at).toLocaleString('pt-BR')}</td>
                        <td><span class="badge ${backup.status === 'completed' ? 'bg-success' : 'bg-warning'}">${backup.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="BackupAdmin.download(${backup.id})" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="BackupAdmin.delete(${backup.id})" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading backups:', error);
            }
        },
        
        async loadSchedules() {
            try {
                const response = await fetch('/api/v1/admin/backup/schedules');
                const data = await response.json();
                
                const tbody = document.getElementById('schedulesTableBody');
                if (!data.schedules || data.schedules.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum agendamento configurado</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.schedules.map(schedule => `
                    <tr>
                        <td>${schedule.name}</td>
                        <td><span class="badge ${this.getTypeBadge(schedule.backup_type)}">${this.formatType(schedule.backup_type)}</span></td>
                        <td><code>${schedule.cron_expression}</code></td>
                        <td>${schedule.retention_days} dias</td>
                        <td>${schedule.next_run ? new Date(schedule.next_run).toLocaleString('pt-BR') : '--'}</td>
                        <td>
                            <span class="badge ${schedule.enabled ? 'bg-success' : 'bg-secondary'}">
                                ${schedule.enabled ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-${schedule.enabled ? 'warning' : 'success'}" 
                                    onclick="BackupAdmin.toggleSchedule('${schedule.id}', ${!schedule.enabled})" 
                                    title="${schedule.enabled ? 'Desativar' : 'Ativar'}">
                                <i class="fas fa-${schedule.enabled ? 'pause' : 'play'}"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="BackupAdmin.deleteSchedule('${schedule.id}')" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading schedules:', error);
            }
        },
        
        async createBackup(type) {
            try {
                showToast(`Criando backup ${type}...`, 'info');
                const response = await fetch(`/api/v1/admin/backup/${type}`, { method: 'POST' });
                const result = await response.json();
                
                if (response.ok) {
                    showToast(`Backup ${type} criado com sucesso!`, 'success');
                    await this.refresh();
                } else {
                    showToast(result.detail || 'Erro ao criar backup', 'error');
                }
            } catch (error) {
                showToast('Erro ao criar backup: ' + error.message, 'error');
            }
        },
        
        async download(backupId) {
            window.open(`/api/v1/admin/backup/${backupId}/download`, '_blank');
        },
        
        async delete(backupId) {
            if (!confirm('Tem certeza que deseja excluir este backup?')) return;
            
            try {
                const response = await fetch(`/api/v1/admin/backup/${backupId}`, { method: 'DELETE' });
                if (response.ok) {
                    showToast('Backup exclu√≠do', 'success');
                    await this.refresh();
                } else {
                    showToast('Erro ao excluir backup', 'error');
                }
            } catch (error) {
                showToast('Erro: ' + error.message, 'error');
            }
        },
        
        async toggleSchedule(scheduleId, enabled) {
            try {
                const response = await fetch(`/api/v1/admin/backup/schedules/${scheduleId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                
                if (response.ok) {
                    showToast(`Agendamento ${enabled ? 'ativado' : 'desativado'}`, 'success');
                    await this.loadSchedules();
                }
            } catch (error) {
                showToast('Erro: ' + error.message, 'error');
            }
        },
        
        async deleteSchedule(scheduleId) {
            if (!confirm('Excluir este agendamento?')) return;
            
            try {
                const response = await fetch(`/api/v1/admin/backup/schedules/${scheduleId}`, { method: 'DELETE' });
                if (response.ok) {
                    showToast('Agendamento exclu√≠do', 'success');
                    await this.loadSchedules();
                }
            } catch (error) {
                showToast('Erro: ' + error.message, 'error');
            }
        },
        
        async refresh() {
            await this.loadStats();
            await this.loadBackups();
            await this.loadSchedules();
        },
        
        formatSize(bytes) {
            if (!bytes) return '0 B';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
        },
        
        formatType(type) {
            const types = { database: 'Banco', config: 'Config', full: 'Completo' };
            return types[type] || type;
        },
        
        getTypeBadge(type) {
            const badges = { database: 'bg-primary', config: 'bg-info', full: 'bg-success' };
            return badges[type] || 'bg-secondary';
        }
    };

    // =============================================================================
    // OBSERVABILITY ADMIN
    // =============================================================================
    const ObservabilityAdmin = {
        async init() {
            await this.refresh();
        },
        
        async refresh() {
            await this.loadStatus();
            await this.loadLangfuseStats();
            await this.loadEvidentlyStats();
            await this.loadConfig();
        },
        
        async loadStatus() {
            try {
                const response = await fetch('/api/v1/admin/observability/status');
                const status = await response.json();
                
                // LangFuse
                const lf = status.langfuse || {};
                document.getElementById('langfuseEnabled').textContent = lf.enabled ? '‚úÖ Habilitado' : '‚ùå Desabilitado';
                document.getElementById('langfuseConnected').textContent = lf.connected ? '‚úÖ Conectado' : '‚ùå Desconectado';
                document.getElementById('langfuseHost').textContent = lf.host || '--';
                document.getElementById('langfuseConfigured').textContent = lf.configured ? '‚úÖ Sim' : '‚ùå N√£o';
                document.getElementById('langfuseStatusBadge').textContent = lf.enabled ? 'ATIVO' : 'INATIVO';
                document.getElementById('langfuseStatusBadge').className = `badge ${lf.enabled ? 'bg-success' : 'bg-secondary'}`;
                
                // Evidently
                const ev = status.evidently || {};
                document.getElementById('evidentlyEnabled').textContent = ev.enabled ? '‚úÖ Habilitado' : '‚ùå Desabilitado';
                document.getElementById('evidentlyActive').textContent = ev.active ? '‚úÖ Ativo' : '‚è∏Ô∏è Pausado';
                document.getElementById('evidentlyRefData').textContent = ev.reference_data ? '‚úÖ Carregado' : '‚ùå N√£o carregado';
                document.getElementById('evidentlyCurrentData').textContent = ev.current_data ? '‚úÖ Dispon√≠vel' : '‚ùå Pendente';
                document.getElementById('evidentlyStatusBadge').textContent = ev.enabled ? 'ATIVO' : 'INATIVO';
                document.getElementById('evidentlyStatusBadge').className = `badge ${ev.enabled ? 'bg-success' : 'bg-secondary'}`;
                
            } catch (error) {
                console.error('Error loading observability status:', error);
            }
        },
        
        async loadLangfuseStats() {
            try {
                const response = await fetch('/api/v1/admin/observability/langfuse/stats');
                const stats = await response.json();
                
                document.getElementById('langfuseTraces').textContent = this.formatNumber(stats.total_traces || 0);
                document.getElementById('langfuseSuccessRate').textContent = (stats.success_rate || 0).toFixed(1) + '%';
                document.getElementById('langfuseTokens').textContent = this.formatNumber(stats.total_tokens || 0);
                document.getElementById('langfuseCost').textContent = '$' + (stats.total_cost || 0).toFixed(2);
                
            } catch (error) {
                console.error('Error loading LangFuse stats:', error);
            }
        },
        
        async loadEvidentlyStats() {
            try {
                const response = await fetch('/api/v1/admin/observability/evidently/stats');
                const stats = await response.json();
                // Stats are loaded in loadStatus
            } catch (error) {
                console.error('Error loading Evidently stats:', error);
            }
        },
        
        async loadConfig() {
            try {
                const response = await fetch('/api/v1/admin/observability/config');
                const config = await response.json();
                
                document.getElementById('envLangfuseHost').textContent = config.langfuse?.host || '--';
                document.getElementById('envEvidentlyEnabled').textContent = config.evidently?.enabled ? 'true' : 'false';
                document.getElementById('envEvidentlyPath').textContent = config.evidently?.reports_path || '--';
                
            } catch (error) {
                console.error('Error loading config:', error);
            }
        },
        
        async checkDrift() {
            try {
                showToast('Verificando drift...', 'info');
                const response = await fetch('/api/v1/admin/observability/evidently/check', { method: 'POST' });
                const result = await response.json();
                
                const card = document.getElementById('driftResultCard');
                const body = document.getElementById('driftResultBody');
                
                card.style.display = 'block';
                
                if (result.drift_detected) {
                    body.innerHTML = `
                        <div class="alert alert-warning mb-3">
                            <strong>‚ö†Ô∏è Drift Detectado!</strong>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Timestamp:</strong> ${new Date(result.timestamp).toLocaleString('pt-BR')}</p>
                                <p><strong>Dados de Refer√™ncia:</strong> ${result.reference_data_size} amostras</p>
                                <p><strong>Dados Atuais:</strong> ${result.current_data_size} amostras</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Colunas com Drift:</strong></p>
                                <ul>${(result.drifted_columns || []).map(c => `<li>${c}</li>`).join('')}</ul>
                            </div>
                        </div>
                    `;
                    showToast('Drift detectado!', 'warning');
                } else {
                    body.innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ Nenhum drift detectado</strong>
                            <p class="mb-0">Os dados atuais est√£o consistentes com os dados de refer√™ncia.</p>
                        </div>
                    `;
                    showToast('Nenhum drift detectado', 'success');
                }
                
            } catch (error) {
                showToast('Erro ao verificar drift: ' + error.message, 'error');
            }
        },
        
        async showReports() {
            try {
                const response = await fetch('/api/v1/admin/observability/evidently/reports');
                const data = await response.json();
                
                const card = document.getElementById('driftReportsCard');
                const tbody = document.getElementById('driftReportsTableBody');
                
                card.style.display = 'block';
                
                if (!data.reports || data.reports.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Nenhum relat√≥rio encontrado</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.reports.map(report => `
                    <tr>
                        <td><code>${report.filename}</code></td>
                        <td>${new Date(report.created_at).toLocaleString('pt-BR')}</td>
                        <td>
                            <span class="badge ${report.drift_detected ? 'bg-warning' : 'bg-success'}">
                                ${report.drift_detected ? 'Sim' : 'N√£o'}
                            </span>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                showToast('Erro ao carregar relat√≥rios: ' + error.message, 'error');
            }
        },
        
        formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }
    };

    // Revis√£o Operador Admin Module
    const RevisaoAdmin = {
        async init() {
            await this.loadMetrics();
            await this.loadAudits();
        },

        async loadMetrics() {
            try {
                const response = await fetch('/api/audit/metrics');
                if (response.ok) {
                    const metrics = await response.json();
                    document.getElementById('revisao-stat-pending').textContent = metrics.pending || 0;
                    document.getElementById('revisao-stat-approved').textContent = metrics.approved || 0;
                    document.getElementById('revisao-stat-rejected').textContent = metrics.rejected || 0;
                    document.getElementById('revisao-pending-count').textContent = metrics.pending || 0;
                }
            } catch (error) {
                console.error('Error loading revisao metrics:', error);
            }
        },

        async loadAudits() {
            try {
                const status = document.getElementById('revisao-status-filter').value;
                const search = document.getElementById('revisao-search').value;
                const date = document.getElementById('revisao-date-filter').value;
                
                let url = '/api/audit/flags?';
                if (status) url += `status=${status}&`;
                if (search) url += `query=${encodeURIComponent(search)}&`;
                if (date) url += `date=${date}&`;

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load audits');
                
                const items = await response.json();
                const container = document.getElementById('revisao-items-container');
                
                if (!items || items.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>Nenhum item encontrado para revis√£o</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = items.map(item => this.renderReviewItem(item)).join('');
                
            } catch (error) {
                console.error('Error loading audits:', error);
                document.getElementById('revisao-items-container').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        N√£o foi poss√≠vel carregar os itens. <a href="#" onclick="RevisaoAdmin.loadAudits()">Tentar novamente</a>
                    </div>
                `;
            }
        },

        renderReviewItem(item) {
            const statusClass = {
                'pending': 'warning',
                'approved': 'success',
                'rejected': 'danger'
            }[item.status] || 'secondary';
            
            const statusLabel = {
                'pending': 'Pendente',
                'approved': 'Aprovada',
                'rejected': 'Rejeitada'
            }[item.status] || item.status;

            return `
                <div class="card mb-3" style="border-left: 4px solid var(--bs-${statusClass});">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-memory me-2"></i>${item.memory_id || item.id}</h6>
                        <span class="badge bg-${statusClass}">${statusLabel}</span>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label text-muted"><i class="fas fa-user me-1"></i>Pergunta do Usu√°rio</label>
                                <div class="p-3 bg-light rounded">${this.escapeHtml(item.user_query || item.query)}</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted"><i class="fas fa-robot me-1"></i>Resposta do Agente</label>
                                <div class="p-3 bg-light rounded">${this.escapeHtml(item.agent_response || item.response)}</div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label text-muted">Motivo da Sinaliza√ß√£o</label>
                                <div class="alert alert-info mb-0 py-2">
                                    <i class="fas fa-info-circle me-1"></i>${item.reason || 'Baixa confian√ßa'}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-muted">Confian√ßa</label>
                                <div class="text-center p-2 bg-light rounded">
                                    <h5 class="mb-0 text-${item.confidence >= 0.85 ? 'success' : item.confidence >= 0.6 ? 'warning' : 'danger'}">
                                        ${((item.confidence || 0) * 100).toFixed(0)}%
                                    </h5>
                                    <small class="text-muted">Threshold: 85%</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-muted">Timestamp</label>
                                <div class="text-center p-2 bg-light rounded">
                                    <p class="mb-0">${new Date(item.timestamp || item.created_at).toLocaleDateString('pt-BR')}</p>
                                    <small class="text-muted">${new Date(item.timestamp || item.created_at).toLocaleTimeString('pt-BR')}</small>
                                </div>
                            </div>
                        </div>
                        ${item.status === 'pending' ? `
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="RevisaoAdmin.approve('${item.id}')">
                                <i class="fas fa-check me-1"></i>Aprovar
                            </button>
                            <button class="btn btn-danger" onclick="RevisaoAdmin.reject('${item.id}')">
                                <i class="fas fa-times me-1"></i>Rejeitar
                            </button>
                            <button class="btn btn-outline-secondary" onclick="RevisaoAdmin.edit('${item.id}')">
                                <i class="fas fa-edit me-1"></i>Editar Resposta
                            </button>
                        </div>
                        ` : `
                        <div class="text-muted">
                            <i class="fas fa-check-circle text-${statusClass} me-1"></i>
                            ${statusLabel} por <strong>${item.reviewed_by || 'sistema'}</strong> 
                            em ${new Date(item.reviewed_at || item.updated_at).toLocaleString('pt-BR')}
                        </div>
                        `}
                    </div>
                </div>
            `;
        },

        async approve(id) {
            try {
                const response = await fetch(`/api/audit/flags/${id}/approve`, { method: 'POST' });
                if (response.ok) {
                    showToast('Item aprovado com sucesso', 'success');
                    await this.loadAudits();
                    await this.loadMetrics();
                } else {
                    throw new Error('Failed to approve');
                }
            } catch (error) {
                showToast('Erro ao aprovar item', 'error');
            }
        },

        async reject(id) {
            try {
                const response = await fetch(`/api/audit/flags/${id}/reject`, { method: 'POST' });
                if (response.ok) {
                    showToast('Item rejeitado', 'warning');
                    await this.loadAudits();
                    await this.loadMetrics();
                } else {
                    throw new Error('Failed to reject');
                }
            } catch (error) {
                showToast('Erro ao rejeitar item', 'error');
            }
        },

        edit(id) {
            showToast('Fun√ß√£o de edi√ß√£o em desenvolvimento', 'info');
        },

        escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    };

    // Initialize sections when shown
    document.querySelector('[data-target="backup-restore"]')?.addEventListener('click', () => {
        setTimeout(() => BackupAdmin.init(), 100);
    });
    
    document.querySelector('[data-target="observability"]')?.addEventListener('click', () => {
        setTimeout(() => ObservabilityAdmin.init(), 100);
    });

    document.querySelector('[data-target="revisao-operador"]')?.addEventListener('click', () => {
        setTimeout(() => RevisaoAdmin.init(), 100);
    });
    </script>

    <!-- Add Schedule Modal -->
    <div class="modal fade" id="addScheduleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-clock me-2"></i>Novo Agendamento de Backup</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addScheduleForm">
                        <div class="mb-3">
                            <label class="form-label">Nome do Agendamento</label>
                            <input type="text" class="form-control" id="scheduleName" required placeholder="Ex: Backup Di√°rio">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo de Backup</label>
                            <select class="form-select" id="scheduleType" required>
                                <option value="database">Banco de Dados</option>
                                <option value="config">Configura√ß√£o</option>
                                <option value="full">Completo</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Express√£o Cron</label>
                            <input type="text" class="form-control" id="scheduleCron" required placeholder="0 2 * * *">
                            <small class="text-muted">Formato: minuto hora dia m√™s dia-semana</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reten√ß√£o (dias)</label>
                            <input type="number" class="form-control" id="scheduleRetention" value="30" min="1" max="365">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveSchedule()">
                        <i class="fas fa-save me-1"></i>Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    async function saveSchedule() {
        const schedule = {
            name: document.getElementById('scheduleName').value,
            backup_type: document.getElementById('scheduleType').value,
            cron_expression: document.getElementById('scheduleCron').value,
            retention_days: parseInt(document.getElementById('scheduleRetention').value),
            enabled: true
        };
        
        if (!schedule.name || !schedule.cron_expression) {
            showToast('Preencha todos os campos obrigat√≥rios', 'error');
            return;
        }
        
        try {
            const response = await fetch('/api/v1/admin/backup/schedules', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(schedule)
            });
            
            if (response.ok) {
                showToast('Agendamento criado com sucesso!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addScheduleModal')).hide();
                document.getElementById('addScheduleForm').reset();
                await BackupAdmin.loadSchedules();
            } else {
                const result = await response.json();
                showToast(result.detail || 'Erro ao criar agendamento', 'error');
            }
        } catch (error) {
            showToast('Erro: ' + error.message, 'error');
        }
    }
    </script>

    <!-- Semantic Cache JavaScript (v5.3.16) -->
    <script>
    const SemanticCacheAdmin = {
        API_BASE: '/api/v1/admin/semantic-cache',
        
        async init() {
            // Bind event listeners
            document.getElementById('refreshSemanticCache')?.addEventListener('click', () => this.loadStats());
            document.getElementById('saveThresholdBtn')?.addEventListener('click', () => this.saveThreshold());
            document.getElementById('preloadModelBtn')?.addEventListener('click', () => this.preloadModel());
            document.getElementById('testCacheBtn')?.addEventListener('click', () => this.testCache());
            document.getElementById('invalidateQueryBtn')?.addEventListener('click', () => this.invalidateQuery());
            document.getElementById('invalidatePatternBtn')?.addEventListener('click', () => this.invalidatePattern());
            document.getElementById('clearAllCacheBtn')?.addEventListener('click', () => this.clearAllCache());
            
            // Redis buttons
            document.getElementById('refreshRedisInfo')?.addEventListener('click', () => this.loadRedisInfo());
            document.getElementById('testRedisConnection')?.addEventListener('click', () => this.testRedisConnection());
            
            // Sync threshold slider with input
            const slider = document.getElementById('cacheThresholdSlider');
            const input = document.getElementById('cacheThreshold');
            if (slider && input) {
                slider.addEventListener('input', () => input.value = slider.value);
                input.addEventListener('input', () => slider.value = input.value);
            }
            
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
            
            console.log('SemanticCacheAdmin initialized');
        },
        
        async loadStats() {
            try {
                // Load stats
                const statsResponse = await fetch(`${this.API_BASE}/stats`);
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    this.updateStatsUI(stats);
                }
                
                // Load health
                const healthResponse = await fetch(`${this.API_BASE}/health`);
                if (healthResponse.ok) {
                    const health = await healthResponse.json();
                    this.updateHealthUI(health);
                }
                
                // Load Redis info
                await this.loadRedisInfo();
            } catch (error) {
                console.error('Failed to load semantic cache stats:', error);
                showToast('Erro ao carregar estat√≠sticas do cache', 'error');
            }
        },
        
        updateStatsUI(stats) {
            // Update summary cards
            document.getElementById('cache-entries').textContent = stats.entries?.toLocaleString() || '0';
            document.getElementById('cache-hit-rate').textContent = `${stats.hit_rate_percent?.toFixed(1) || 0}%`;
            document.getElementById('cache-avg-latency').textContent = `${stats.avg_lookup_time_ms?.toFixed(1) || 0}ms`;
            
            // Calculate estimated savings ($0.02 per LLM call avoided)
            const savings = (stats.hits || 0) * 0.02;
            document.getElementById('cache-savings').textContent = `$${savings.toFixed(2)}`;
            
            // Update detailed stats table
            document.getElementById('stat-hits').textContent = stats.hits?.toLocaleString() || '0';
            document.getElementById('stat-misses').textContent = stats.misses?.toLocaleString() || '0';
            document.getElementById('stat-sets').textContent = stats.sets?.toLocaleString() || '0';
            document.getElementById('stat-errors').textContent = stats.errors?.toLocaleString() || '0';
            document.getElementById('stat-threshold').textContent = stats.threshold || '-';
            document.getElementById('stat-ttl').textContent = this.formatTTL(stats.default_ttl);
            document.getElementById('stat-max-entries').textContent = stats.max_entries?.toLocaleString() || '-';
            document.getElementById('stat-redis-stack').textContent = stats.redis_stack_available ? 'Dispon√≠vel ‚úì' : 'N√£o dispon√≠vel';
            
            // Update form with current threshold
            const thresholdSlider = document.getElementById('cacheThresholdSlider');
            const thresholdInput = document.getElementById('cacheThreshold');
            if (thresholdSlider && stats.threshold) {
                thresholdSlider.value = stats.threshold;
                thresholdInput.value = stats.threshold;
            }
        },
        
        updateHealthUI(health) {
            // Redis status
            const redisIndicator = document.getElementById('redis-status-indicator');
            const redisText = document.getElementById('redis-status-text');
            if (health.redis_status === 'healthy') {
                redisIndicator.className = 'status-indicator status-connected';
                redisText.textContent = `Conectado (${health.redis_latency_ms?.toFixed(1)}ms)`;
            } else {
                redisIndicator.className = 'status-indicator status-disconnected';
                redisText.textContent = 'Desconectado';
            }
            
            // Redis Stack status
            const stackIndicator = document.getElementById('redis-stack-indicator');
            const stackText = document.getElementById('redis-stack-text');
            if (health.redis_stack_available) {
                stackIndicator.className = 'status-indicator status-connected';
                stackText.textContent = 'RediSearch Ativo';
            } else {
                stackIndicator.className = 'status-indicator status-warning';
                stackText.textContent = 'Usando Fallback';
            }
            
            // Embedding model status
            const modelIndicator = document.getElementById('embedding-model-indicator');
            const modelText = document.getElementById('embedding-model-text');
            const modelInfo = health.embedding_model_info || {};
            if (modelInfo.status === 'loaded') {
                modelIndicator.className = 'status-indicator status-connected';
                modelText.textContent = 'Carregado';
            } else if (modelInfo.status === 'fallback') {
                modelIndicator.className = 'status-indicator status-warning';
                modelText.textContent = 'Hash Fallback';
            } else {
                modelIndicator.className = 'status-indicator status-disconnected';
                modelText.textContent = 'N√£o dispon√≠vel';
            }
            
            // Additional info
            document.getElementById('redis-memory').textContent = health.used_memory_human || '-';
            document.getElementById('embedding-model-name').textContent = 
                `${modelInfo.model_name || '-'} (${modelInfo.dimension || '-'}d)`;
        },
        
        formatTTL(seconds) {
            if (!seconds) return '-';
            if (seconds < 3600) return `${Math.round(seconds / 60)} minutos`;
            if (seconds < 86400) return `${Math.round(seconds / 3600)} horas`;
            return `${Math.round(seconds / 86400)} dias`;
        },
        
        async loadRedisInfo() {
            try {
                const response = await fetch(`${this.API_BASE}/redis-info`);
                if (response.ok) {
                    const info = await response.json();
                    this.updateRedisUI(info);
                }
            } catch (error) {
                console.error('Failed to load Redis info:', error);
            }
        },
        
        updateRedisUI(info) {
            // Connection info
            document.getElementById('redis-host').textContent = info.host || '-';
            document.getElementById('redis-port').textContent = info.port || '-';
            document.getElementById('redis-database').textContent = `DB ${info.database}`;
            
            const connStatus = document.getElementById('redis-connection-status');
            if (info.connected) {
                connStatus.className = 'badge bg-success';
                connStatus.textContent = 'Conectado';
            } else {
                connStatus.className = 'badge bg-danger';
                connStatus.textContent = 'Desconectado';
            }
            
            // Version badge
            const versionBadge = document.getElementById('redis-version-badge');
            versionBadge.textContent = info.version ? `v${info.version}` : '-';
            
            // Memory info
            document.getElementById('redis-used-memory-detail').textContent = info.used_memory_human || '-';
            document.getElementById('redis-max-memory').textContent = info.max_memory_human || '-';
            document.getElementById('redis-eviction-policy').textContent = info.maxmemory_policy || '-';
            
            // Memory bar
            const memoryBar = document.getElementById('redis-memory-bar');
            const memoryPercent = document.getElementById('redis-memory-percent');
            const percent = Math.min(info.memory_usage_percent || 0, 100);
            memoryBar.style.width = `${percent}%`;
            memoryBar.setAttribute('aria-valuenow', percent);
            memoryPercent.textContent = `${percent.toFixed(1)}%`;
            
            // Color based on usage
            if (percent < 50) {
                memoryBar.className = 'progress-bar bg-success';
            } else if (percent < 80) {
                memoryBar.className = 'progress-bar bg-warning';
            } else {
                memoryBar.className = 'progress-bar bg-danger';
            }
            
            // Modules status
            const modules = info.modules || {};
            this.updateModuleStatus('search', modules.search);
            this.updateModuleStatus('json', modules.json);
            this.updateModuleStatus('timeseries', modules.timeseries);
            this.updateModuleStatus('bloom', modules.bloom);
            
            // Database keys
            const databases = info.databases || {};
            for (let i = 0; i <= 4; i++) {
                const dbInfo = databases[`db${i}`] || {};
                const keysEl = document.getElementById(`db${i}-keys`);
                const statusEl = document.getElementById(`db${i}-status`);
                if (keysEl) keysEl.textContent = (dbInfo.keys || 0).toLocaleString();
                if (statusEl) {
                    if (dbInfo.active) {
                        statusEl.className = 'badge bg-success';
                        statusEl.textContent = 'Ativo';
                    } else if (dbInfo.keys > 0) {
                        statusEl.className = 'badge bg-info';
                        statusEl.textContent = 'Em uso';
                    } else {
                        statusEl.className = 'badge bg-secondary';
                        statusEl.textContent = 'Vazio';
                    }
                }
            }
            
            // Performance metrics
            document.getElementById('redis-connected-clients').textContent = info.connected_clients || '0';
            document.getElementById('redis-ops-per-sec').textContent = (info.ops_per_sec || 0).toLocaleString();
            document.getElementById('redis-uptime').textContent = info.uptime_days ? `${info.uptime_days} dias` : '-';
            
            // Embedding model extended info
            document.getElementById('embedding-model-full-name').textContent = 'all-MiniLM-L6-v2';
            document.getElementById('embedding-dimensions').textContent = '384';
        },
        
        updateModuleStatus(moduleName, available) {
            const icon = document.getElementById(`module-${moduleName}-icon`);
            const status = document.getElementById(`module-${moduleName}-status`);
            
            if (icon && status) {
                if (available) {
                    icon.className = 'fas fa-' + this.getModuleIcon(moduleName) + ' fa-lg mb-1 text-success';
                    status.className = 'badge bg-success';
                    status.textContent = 'Ativo';
                } else {
                    icon.className = 'fas fa-' + this.getModuleIcon(moduleName) + ' fa-lg mb-1 text-secondary';
                    status.className = 'badge bg-secondary';
                    status.textContent = 'Inativo';
                }
            }
        },
        
        getModuleIcon(moduleName) {
            const icons = {
                'search': 'search',
                'json': 'code',
                'timeseries': 'chart-line',
                'bloom': 'filter'
            };
            return icons[moduleName] || 'puzzle-piece';
        },
        
        async testRedisConnection() {
            const btn = document.getElementById('testRedisConnection');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Testando...';
            
            try {
                const response = await fetch(`${this.API_BASE}/redis-test`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showToast(`Conex√£o Redis OK! Lat√™ncia: ${result.latency_ms}ms`, 'success');
                } else {
                    showToast(`Falha na conex√£o: ${result.message}`, 'error');
                }
            } catch (error) {
                showToast('Erro ao testar conex√£o: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        },
        
        async saveThreshold() {
            const threshold = parseFloat(document.getElementById('cacheThreshold').value);
            if (isNaN(threshold) || threshold < 0.1 || threshold > 0.5) {
                showToast('Threshold deve estar entre 0.1 e 0.5', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${this.API_BASE}/threshold`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ threshold })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showToast(`Threshold atualizado: ${result.old_threshold} ‚Üí ${result.new_threshold}`, 'success');
                    this.loadStats();
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Erro ao atualizar threshold', 'error');
                }
            } catch (error) {
                showToast('Erro: ' + error.message, 'error');
            }
        },
        
        async preloadModel() {
            const btn = document.getElementById('preloadModelBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Carregando...';
            
            try {
                const response = await fetch(`${this.API_BASE}/preload-model`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showToast('Modelo de embeddings carregado com sucesso!', 'success');
                } else {
                    showToast('Usando fallback: ' + result.message, 'warning');
                }
                this.loadStats();
            } catch (error) {
                showToast('Erro: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-download me-1"></i>Pr√©-carregar Modelo';
            }
        },
        
        async testCache() {
            const query = document.getElementById('testQuery').value.trim();
            if (!query) {
                showToast('Digite uma query para testar', 'warning');
                return;
            }
            
            const resultDiv = document.getElementById('testCacheResult');
            resultDiv.className = 'alert alert-info';
            resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Buscando no cache...';
            resultDiv.classList.remove('d-none');
            
            try {
                const response = await fetch(`${this.API_BASE}/test?query=${encodeURIComponent(query)}`);
                const result = await response.json();
                
                if (result.hit) {
                    resultDiv.className = 'alert alert-success';
                    resultDiv.innerHTML = `
                        <strong><i class="fas fa-check-circle me-1"></i>Cache HIT!</strong>
                        <p class="mb-1 mt-2"><strong>Dist√¢ncia:</strong> ${result.distance?.toFixed(4)}</p>
                        <p class="mb-1"><strong>Tempo:</strong> ${result.lookup_time_ms?.toFixed(1)}ms</p>
                        <p class="mb-1"><strong>Hit Count:</strong> ${result.hit_count}</p>
                        <p class="mb-0"><strong>Query Original:</strong> ${result.cached_query || query}</p>
                        ${result.response ? `<hr><small class="text-muted">${result.response}</small>` : ''}
                    `;
                } else {
                    resultDiv.className = 'alert alert-warning';
                    resultDiv.innerHTML = `
                        <strong><i class="fas fa-times-circle me-1"></i>Cache MISS</strong>
                        <p class="mb-0 mt-2">Nenhuma entrada similar encontrada no cache.
                        <br><small>Tempo de busca: ${result.lookup_time_ms?.toFixed(1)}ms</small></p>
                    `;
                }
            } catch (error) {
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = `<strong>Erro:</strong> ${error.message}`;
            }
        },
        
        async invalidateQuery() {
            const query = document.getElementById('invalidateQuery').value.trim();
            if (!query) {
                showToast('Digite a query a invalidar', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${this.API_BASE}/invalidate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                
                const result = await response.json();
                if (result.invalidated_count > 0) {
                    showToast('Query invalidada com sucesso', 'success');
                    document.getElementById('invalidateQuery').value = '';
                } else {
                    showToast('Query n√£o encontrada no cache', 'info');
                }
                this.loadStats();
            } catch (error) {
                showToast('Erro: ' + error.message, 'error');
            }
        },
        
        async invalidatePattern() {
            const pattern = document.getElementById('invalidatePattern').value.trim();
            if (!pattern) {
                showToast('Digite o padr√£o a invalidar', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${this.API_BASE}/invalidate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pattern })
                });
                
                const result = await response.json();
                showToast(`${result.invalidated_count} entradas invalidadas`, 'success');
                document.getElementById('invalidatePattern').value = '';
                this.loadStats();
            } catch (error) {
                showToast('Erro: ' + error.message, 'error');
            }
        },
        
        async clearAllCache() {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja limpar TODO o cache?\n\nIsso remover√° todas as respostas cacheadas e pode aumentar temporariamente os custos de API.')) {
                return;
            }
            
            try {
                const response = await fetch(`${this.API_BASE}/invalidate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ all: true })
                });
                
                if (response.ok) {
                    showToast('Cache limpo com sucesso', 'success');
                    this.loadStats();
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Erro ao limpar cache', 'error');
                }
            } catch (error) {
                showToast('Erro: ' + error.message, 'error');
            }
        }
    };
    
    // Initialize when Semantic Cache section is shown
    document.addEventListener('DOMContentLoaded', () => {
        SemanticCacheAdmin.init();
        
        // Load stats when section becomes visible
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.target.id === 'semantic-cache' && 
                    mutation.target.classList.contains('active')) {
                    SemanticCacheAdmin.loadStats();
                }
            });
        });
        
        const semanticCacheSection = document.getElementById('semantic-cache');
        if (semanticCacheSection) {
            observer.observe(semanticCacheSection, { attributes: true, attributeFilter: ['class'] });
        }
    });
    </script>
</body>
</html>