# üêß Resync v5.9.3 - Linux VM Deployment Guide

This guide details how to deploy **Resync v5.9.3** on a Linux VM (Ubuntu/Debian) for the first time.

## üìã Prerequisites
- **OS**: Ubuntu 20.04 LTS / 22.04 LTS or Debian 11/12
- **Root/Sudo Access**: Required for installation
- **External Services**:
    - PostgreSQL Database (Connection string required)
    - Redis (Can be local or external, script installs local by default)

## üöÄ Quick Install (Automated)

1. **Upload Files**: Transfer the project folder to your VM (e.g., `/opt/resync`).
2. **Run Setup Script**:
   ```bash
   cd /opt/resync
   sudo chmod +x scripts/setup_linux.sh
   sudo ./scripts/setup_linux.sh
   ```
   *This script installs Python 3.10, Redis, creates a virtualenv, and installs dependencies.*

3. **Configure Secrets**:
   Edit the `.env` file generated by the script:
   ```bash
   nano .env
   ```
   **CRITICAL**: You MUST update `APP_SECRET_KEY`, `APP_DATABASE_URL`, and `APP_TWS_*` settings.

4. **Initialize Database**:
   ```bash
   source .venv/bin/activate
   alembic upgrade head
   ```

5. **Start Service**:
   ```bash
   sudo systemctl start resync
   sudo systemctl enable resync
   ```

6. **Verify**:
   ```bash
   curl http://localhost:8000/health
   # Should return {"status": "ok", ...}
   ```

---

## üõ† Manual Configuration Details

### 1. Service Management
The application runs as a **Systemd** service named `resync`.

- **Start**: `sudo systemctl start resync`
- **Stop**: `sudo systemctl stop resync`
- **Restart**: `sudo systemctl restart resync`
- **Logs**: `journalctl -u resync -f`

### 2. Environment Variables (.env)
The `.env` file is the **single source of truth**.
- **APP_WORKERS**: Default is 4. Set to `(CPU_CORES * 2) + 1`.
- **APP_LOG_LEVEL**: Keep at `INFO` for production.

### 3. Gunicorn Tuning
The `gunicorn.conf.py` is pre-tuned for VM usage:
- **Workers**: Uses `uvicorn.workers.UvicornWorker` for high-performance async.
- **Timeouts**: Set to 120s to handle long-running TWS operations.

## üîç Verification & Troubleshooting

### Check Service Status
```bash
sudo systemctl status resync
```

### Check Logs
```bash
# Real-time logs
journalctl -u resync -f

# Check for errors specifically
journalctl -u resync | grep ERROR
```

### Run Health Checks (Manual)
Inside the project directory:
```bash
source .venv/bin/activate
# Run specifically health/connection tests
pytest tests/health/ -v
```

### Common Issues
1. **Database Connection Failed**:
   - Check `APP_DATABASE_URL` in `.env`.
   - Ensure VM IP is allowlisted in PostgreSQL pg_hba.conf.
2. **Redis Connection Error**:
   - Ensure Redis is running: `systemctl status redis-server`
3. **Permission Denied**:
   - Ensure the user running the service (default `www-data`) owns the `uploads/` directory.
   ```bash
   chown -R www-data:www-data /opt/resync/uploads
   ```

---
**Ready for Production!** üöÄ
