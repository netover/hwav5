# Ollama Systemd Override Configuration for Resync
# v5.2.3.21: Optimized for 4-core CPU / 16GB RAM
#
# Installation:
#   sudo mkdir -p /etc/systemd/system/ollama.service.d/
#   sudo cp deploy/ollama-override.conf /etc/systemd/system/ollama.service.d/override.conf
#   sudo systemctl daemon-reload
#   sudo systemctl restart ollama

[Service]
# Network binding - allow localhost only (secure)
Environment="OLLAMA_HOST=127.0.0.1:11434"

# Performance optimization for CPU-only inference
# Single model at a time (memory constraint)
Environment="OLLAMA_MAX_LOADED_MODELS=1"

# Single parallel request (CPU constraint)
Environment="OLLAMA_NUM_PARALLEL=1"

# Context window - balance between capability and memory
Environment="OLLAMA_CONTEXT_LENGTH=4096"

# Keep model loaded for 5 minutes (avoid reload latency)
Environment="OLLAMA_KEEP_ALIVE=5m"

# Enable flash attention (reduces memory usage)
Environment="OLLAMA_FLASH_ATTENTION=1"

# Quantize KV cache to save memory
Environment="OLLAMA_KV_CACHE_TYPE=q8_0"

# Logging level (error only in production)
Environment="OLLAMA_DEBUG=false"

# Memory limits (leave ~2GB for system + Resync)
MemoryMax=14G
MemoryHigh=12G

# CPU limits (use all 4 cores)
CPUQuota=400%

# Restart policy
Restart=always
RestartSec=5
