<!-- Unified Configuration Interface -->
<!-- Add to templates/admin.html in sidebar and main content area -->

<!-- SIDEBAR LINK (add to AI & LEARNING section) -->
<li>
    <a href="#" onclick="switchSection('unified-config'); return false;">
        <i class="fas fa-cog me-2"></i>
        <span>Unified Config</span>
        <span class="badge bg-success ms-2" id="hotReloadBadge">HOT</span>
    </a>
</li>

<!-- MAIN CONTENT SECTION -->
<div id="unified-config" class="content-section" style="display: none;">
    <h2 class="mb-4">
        <i class="fas fa-cog me-2"></i>
        Unified Configuration Manager
        <span class="badge bg-success ms-2" id="hotReloadStatus">Hot Reload Active</span>
    </h2>
    
    <!-- Status Banner -->
    <div class="alert alert-info mb-4" role="alert">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-bolt me-2"></i>
                <strong>Hot Reload Enabled:</strong> Changes apply instantly without restart!
            </div>
            <button class="btn btn-sm btn-outline-primary" onclick="forceReloadAllConfigs()">
                <i class="fas fa-sync me-1"></i>Reload All
            </button>
        </div>
    </div>
    
    <!-- Config Tabs -->
    <ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="graphrag-tab" data-bs-toggle="tab" 
                    data-bs-target="#graphrag-config" type="button">
                <i class="fas fa-project-diagram me-1"></i>GraphRAG
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ai-tab" data-bs-toggle="tab" 
                    data-bs-target="#ai-config" type="button">
                <i class="fas fa-robot me-1"></i>AI & Specialists
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="monitoring-tab" data-bs-toggle="tab" 
                    data-bs-target="#monitoring-config" type="button">
                <i class="fas fa-chart-line me-1"></i>Monitoring
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="system-tab" data-bs-toggle="tab" 
                    data-bs-target="#system-config" type="button">
                <i class="fas fa-server me-1"></i>System
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="backups-tab" data-bs-toggle="tab" 
                    data-bs-target="#backups-config" type="button">
                <i class="fas fa-history me-1"></i>Backups
            </button>
        </li>
    </ul>
    
    <!-- Tab Content -->
    <div class="tab-content" id="configTabContent">
        
        <!-- GraphRAG Config -->
        <div class="tab-pane fade show active" id="graphrag-config" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">GraphRAG Configuration</h5>
                    <button class="btn btn-sm btn-success" onclick="saveConfigSection('graphrag')">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
                <div class="card-body">
                    <div id="graphrag-config-form">
                        <!-- Dynamically loaded -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI Config -->
        <div class="tab-pane fade" id="ai-config" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">AI & Specialists Configuration</h5>
                    <button class="btn btn-sm btn-success" onclick="saveConfigSection('ai')">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
                <div class="card-body">
                    <div id="ai-config-form">
                        <!-- Dynamically loaded -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Monitoring Config -->
        <div class="tab-pane fade" id="monitoring-config" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Monitoring Configuration</h5>
                    <button class="btn btn-sm btn-success" onclick="saveConfigSection('monitoring')">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
                <div class="card-body">
                    <div id="monitoring-config-form">
                        <!-- Dynamically loaded -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- System Config -->
        <div class="tab-pane fade" id="system-config" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">System Configuration</h5>
                    <button class="btn btn-sm btn-success" onclick="saveConfigSection('system')">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
                <div class="card-body">
                    <div id="system-config-form">
                        <!-- Dynamically loaded -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Backups -->
        <div class="tab-pane fade" id="backups-config" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Configuration Backups</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Filename</th>
                                    <th>Size</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="backups-list">
                                <tr>
                                    <td colspan="4" class="text-center text-muted">
                                        Loading backups...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- Alert container -->
    <div id="config-alerts" class="mt-3"></div>
</div>

<!-- JAVASCRIPT -->
<script>
// ============================================================================
// UNIFIED CONFIGURATION MANAGER
// ============================================================================

let currentConfigs = {};

// Load all configurations
async function loadAllConfigurations() {
    try {
        const response = await fetch('/api/admin/config/all');
        const data = await response.json();
        
        if (data.status === 'success') {
            currentConfigs = data.configs;
            
            // Update hot reload badge
            updateHotReloadStatus(data.hot_reload_active);
            
            // Load each config tab
            loadConfigTab('graphrag');
            loadConfigTab('ai');
            loadConfigTab('monitoring');
            loadConfigTab('system');
        }
    } catch (error) {
        console.error('Failed to load configurations:', error);
        showConfigAlert('danger', 'Failed to load configurations');
    }
}

// Update hot reload status badge
function updateHotReloadStatus(active) {
    const badge = document.getElementById('hotReloadBadge');
    const status = document.getElementById('hotReloadStatus');
    
    if (active) {
        badge.className = 'badge bg-success ms-2';
        badge.textContent = 'HOT';
        status.className = 'badge bg-success ms-2';
        status.textContent = 'Hot Reload Active';
    } else {
        badge.className = 'badge bg-warning ms-2';
        badge.textContent = 'OFF';
        status.className = 'badge bg-warning ms-2';
        status.textContent = 'Hot Reload Inactive';
    }
}

// Load specific config tab
function loadConfigTab(configName) {
    const config = currentConfigs[configName];
    if (!config) return;
    
    const formDiv = document.getElementById(`${configName}-config-form`);
    if (!formDiv) return;
    
    // Build form HTML
    const html = buildConfigForm(configName, config);
    formDiv.innerHTML = html;
}

// Build dynamic form from config object
function buildConfigForm(configName, config, parentKey = '') {
    let html = '';
    
    for (const [key, value] of Object.entries(config)) {
        const fullKey = parentKey ? `${parentKey}.${key}` : key;
        
        if (typeof value === 'object' && !Array.isArray(value) && value !== null) {
            // Nested section
            html += `
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">${formatLabel(key)}</h6>
                    </div>
                    <div class="card-body">
                        ${buildConfigForm(configName, value, fullKey)}
                    </div>
                </div>
            `;
        } else {
            // Input field
            html += buildConfigInput(configName, fullKey, key, value);
        }
    }
    
    return html;
}

// Build input field based on value type
function buildConfigInput(configName, fullKey, key, value) {
    const inputId = `${configName}-${fullKey.replace(/\./g, '-')}`;
    const label = formatLabel(key);
    
    let inputHtml = '';
    
    if (typeof value === 'boolean') {
        // Checkbox
        inputHtml = `
            <div class="form-check">
                <input class="form-check-input" type="checkbox" 
                       id="${inputId}" ${value ? 'checked' : ''}
                       data-config="${configName}" data-key="${fullKey}">
                <label class="form-check-label" for="${inputId}">
                    ${label}
                </label>
            </div>
        `;
    } else if (typeof value === 'number') {
        // Number input
        inputHtml = `
            <div class="mb-3">
                <label class="form-label">${label}</label>
                <input type="number" class="form-control" id="${inputId}" 
                       value="${value}"
                       data-config="${configName}" data-key="${fullKey}">
            </div>
        `;
    } else if (Array.isArray(value)) {
        // Array (show as comma-separated)
        inputHtml = `
            <div class="mb-3">
                <label class="form-label">${label}</label>
                <input type="text" class="form-control" id="${inputId}" 
                       value="${value.join(', ')}"
                       data-config="${configName}" data-key="${fullKey}" data-type="array"
                       placeholder="Comma-separated values">
            </div>
        `;
    } else {
        // Text input
        inputHtml = `
            <div class="mb-3">
                <label class="form-label">${label}</label>
                <input type="text" class="form-control" id="${inputId}" 
                       value="${value || ''}"
                       data-config="${configName}" data-key="${fullKey}">
            </div>
        `;
    }
    
    return inputHtml;
}

// Format label from key
function formatLabel(key) {
    return key
        .replace(/_/g, ' ')
        .replace(/\b\w/g, l => l.toUpperCase());
}

// Save config section
async function saveConfigSection(configName) {
    try {
        // Collect all values from form
        const formDiv = document.getElementById(`${configName}-config-form`);
        const inputs = formDiv.querySelectorAll('[data-config][data-key]');
        
        const data = {};
        
        inputs.forEach(input => {
            const key = input.dataset.key;
            let value;
            
            if (input.type === 'checkbox') {
                value = input.checked;
            } else if (input.type === 'number') {
                value = parseFloat(input.value);
            } else if (input.dataset.type === 'array') {
                value = input.value.split(',').map(v => v.trim()).filter(v => v);
            } else {
                value = input.value;
            }
            
            setNestedValue(data, key, value);
        });
        
        // Send update request
        const response = await fetch(`/api/admin/config/${configName}/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                section: configName,
                data: data
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showConfigAlert('success', 
                `✅ ${formatLabel(configName)} config saved with hot reload! Changes active immediately.`);
            
            // Reload to show updated values
            await loadAllConfigurations();
        } else {
            showConfigAlert('danger', 'Failed to save configuration');
        }
        
    } catch (error) {
        console.error('Failed to save config:', error);
        showConfigAlert('danger', `Error: ${error.message}`);
    }
}

// Set nested value in object
function setNestedValue(obj, path, value) {
    const keys = path.split('.');
    let current = obj;
    
    for (let i = 0; i < keys.length - 1; i++) {
        const key = keys[i];
        if (!(key in current)) {
            current[key] = {};
        }
        current = current[key];
    }
    
    current[keys[keys.length - 1]] = value;
}

// Force reload all configs
async function forceReloadAllConfigs() {
    try {
        const response = await fetch('/api/admin/config/reload', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.status === 'success' || data.status === 'partial') {
            showConfigAlert('success', 
                `Reloaded ${data.configs_loaded.length} configurations`);
            await loadAllConfigurations();
        }
    } catch (error) {
        showConfigAlert('danger', 'Failed to reload configurations');
    }
}

// Load backups list
async function loadBackupsList() {
    try {
        const response = await fetch('/api/admin/config/backups');
        const data = await response.json();
        
        const tbody = document.getElementById('backups-list');
        tbody.innerHTML = '';
        
        if (data.backups.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted">
                        No backups found
                    </td>
                </tr>
            `;
            return;
        }
        
        data.backups.forEach(backup => {
            const date = new Date(backup.modified * 1000).toLocaleString();
            const sizeMB = (backup.size_bytes / 1024 / 1024).toFixed(2);
            
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><code>${backup.filename}</code></td>
                <td>${sizeMB} MB</td>
                <td>${date}</td>
                <td>
                    <button class="btn btn-sm btn-warning" 
                            onclick="restoreBackup('${backup.filename}')">
                        <i class="fas fa-undo me-1"></i>Restore
                    </button>
                </td>
            `;
        });
    } catch (error) {
        console.error('Failed to load backups:', error);
    }
}

// Restore backup
async function restoreBackup(filename) {
    if (!confirm(`Restore configuration from ${filename}? Current config will be backed up first.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/config/backups/${filename}/restore`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showConfigAlert('success', 
                `✅ Config restored from ${filename} with hot reload!`);
            await loadAllConfigurations();
        }
    } catch (error) {
        showConfigAlert('danger', `Failed to restore backup: ${error.message}`);
    }
}

// Show alert
function showConfigAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.getElementById('config-alerts').prepend(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Initialize when section is opened
document.addEventListener('DOMContentLoaded', function() {
    // Load configs when tab is first shown
    const configTab = document.querySelector('[data-bs-target="#unified-config"]');
    if (configTab) {
        configTab.addEventListener('shown.bs.tab', function() {
            loadAllConfigurations();
            loadBackupsList();
        });
    }
});
</script>
